<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 8.0.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"wangmc1024.github.io","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":false,"style":"mac"},"back2top":{"enable":true,"sidebar":true,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":"gitalk","storage":true,"lazyload":false,"nav":null,"activeClass":"gitalk"},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"db.json"};
  </script>

  <meta name="description" content="如题，结合官方文档与网络帖子，利用AI整理">
<meta property="og:type" content="article">
<meta property="og:title" content="Vue+IndexedDB+idb">
<meta property="og:url" content="https://wangmc1024.github.io/2025/10/09/web/Vue%20%E4%B8%AD%E4%BD%BF%E7%94%A8%20idb%20%E6%93%8D%E4%BD%9C%20IndexedDB%20%E5%AE%8C%E6%95%B4%E6%8C%87%E5%8D%97/index.html">
<meta property="og:site_name" content="Computer Science">
<meta property="og:description" content="如题，结合官方文档与网络帖子，利用AI整理">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2025-10-09T08:00:00.000Z">
<meta property="article:modified_time" content="2025-10-19T11:23:17.806Z">
<meta property="article:author" content="三子曰">
<meta property="article:tag" content="Web">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://wangmc1024.github.io/2025/10/09/web/Vue%20%E4%B8%AD%E4%BD%BF%E7%94%A8%20idb%20%E6%93%8D%E4%BD%9C%20IndexedDB%20%E5%AE%8C%E6%95%B4%E6%8C%87%E5%8D%97/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>Vue+IndexedDB+idb | Computer Science</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>


<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Computer Science</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">WangMC Blog</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>时间轴</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    


    <main class="main">
      <div class="main-inner">
        <div id="spa-content-wrap" class="content-wrap">
            

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://wangmc1024.github.io/2025/10/09/web/Vue%20%E4%B8%AD%E4%BD%BF%E7%94%A8%20idb%20%E6%93%8D%E4%BD%9C%20IndexedDB%20%E5%AE%8C%E6%95%B4%E6%8C%87%E5%8D%97/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://cdn.jsdelivr.net/gh/MengChangWang/Blog_Image@main/img/avatar.png">
      <meta itemprop="name" content="三子曰">
      <meta itemprop="description" content="欢迎来到我的博客">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Computer Science">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Vue+IndexedDB+idb
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2025-10-09 16:00:00" itemprop="dateCreated datePublished" datetime="2025-10-09T16:00:00+08:00">2025-10-09</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2025-10-19 19:23:17" itemprop="dateModified" datetime="2025-10-19T19:23:17+08:00">2025-10-19</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%BC%96%E7%A8%8B/" itemprop="url" rel="index"><span itemprop="name">编程</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span id="busuanzi_value_page_pv"></span>
            </span><br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>55k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>50 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <blockquote>
<p>如题，结合官方文档与网络帖子，利用AI整理</p>
</blockquote>
<span id="more"></span>
<h1>Vue 中使用 idb 操作 IndexedDB 完整指南</h1>
<h2 id="目录">目录</h2>
<ol>
<li class="lvl-3">
<p><a href="#%E4%BB%80%E4%B9%88%E6%98%AFindexeddb%E5%92%8Cidb">什么是 IndexedDB 和 idb</a></p>
</li>
<li class="lvl-3">
<p><a href="#%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87%E4%B8%8E%E5%AE%89%E8%A3%85">环境准备与安装</a></p>
</li>
<li class="lvl-3">
<p><a href="#%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5">基础概念</a></p>
</li>
<li class="lvl-3">
<p><a href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E8%BF%9E%E6%8E%A5%E7%AE%A1%E7%90%86">数据库连接管理</a></p>
</li>
<li class="lvl-3">
<p><a href="#%E6%95%B0%E6%8D%AE%E6%93%8D%E4%BD%9Ccrud">数据操作（CRUD）</a></p>
</li>
<li class="lvl-3">
<p><a href="#%E4%BA%8B%E5%8A%A1%E5%A4%84%E7%90%86">事务处理</a></p>
</li>
<li class="lvl-3">
<p><a href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E7%89%88%E6%9C%AC%E7%AE%A1%E7%90%86">数据库版本管理</a></p>
</li>
<li class="lvl-3">
<p><a href="#%E7%B4%A2%E5%BC%95%E4%BD%BF%E7%94%A8">索引使用</a></p>
</li>
<li class="lvl-3">
<p><a href="#%E9%AB%98%E7%BA%A7%E6%9F%A5%E8%AF%A2%E6%93%8D%E4%BD%9C">高级查询操作</a></p>
</li>
<li class="lvl-3">
<p><a href="#vue%E4%B8%AD%E7%9A%84%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5">Vue 中的最佳实践</a></p>
</li>
<li class="lvl-3">
<p><a href="#%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98%E4%B8%8E%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88">常见问题与解决方案</a></p>
</li>
<li class="lvl-3">
<p><a href="#%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96">性能优化</a></p>
</li>
</ol>
<h2 id="什么是-IndexedDB-和-idb">什么是 IndexedDB 和 idb</h2>
<h3 id="IndexedDB-简介">IndexedDB 简介</h3>
<p>IndexedDB 是浏览器提供的一种本地存储方案，具有以下特点：</p>
<ul class="lvl-0">
<li class="lvl-2">
<p><strong>NoSQL 数据库</strong>：基于键值对存储</p>
</li>
<li class="lvl-2">
<p><strong>异步操作</strong>：所有操作都是异步的，不会阻塞主线程</p>
</li>
<li class="lvl-2">
<p><strong>大容量存储</strong>：相比 localStorage 有更大的存储容量（通常是 GB 级别）</p>
</li>
<li class="lvl-2">
<p><strong>支持事务</strong>：确保数据操作的原子性</p>
</li>
<li class="lvl-2">
<p><strong>支持索引</strong>：可以在对象的属性上创建索引，提高查询效率</p>
</li>
<li class="lvl-2">
<p><strong>同源策略</strong>：遵循浏览器的同源策略</p>
</li>
</ul>
<h3 id="idb-库简介">idb 库简介</h3>
<p>idb 是由 Google 工程师 Jake Archibald 开发的一个轻量级 IndexedDB 包装库：</p>
<ul class="lvl-0">
<li class="lvl-2">
<p><strong>体积小巧</strong>：只有 1KB 大小</p>
</li>
<li class="lvl-2">
<p><strong>Promise API</strong>：将原生的回调式 API 转换为 Promise 式</p>
</li>
<li class="lvl-2">
<p><strong>TypeScript 支持</strong>：提供完整的类型定义</p>
</li>
<li class="lvl-2">
<p><strong>简化操作</strong>：简化了复杂的 IndexedDB 操作流程</p>
</li>
<li class="lvl-2">
<p><strong>活跃维护</strong>：持续更新和维护</p>
</li>
</ul>
<p>GitHub 地址：<a target="_blank" rel="noopener" href="https://github.com/jakearchibald/idb">https://github.com/jakearchibald/idb</a></p>
<h2 id="环境准备与安装">环境准备与安装</h2>
<h3 id="安装-idb">安装 idb</h3>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">使用npm</span></span><br><span class="line">npm install idb</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">使用yarn</span></span><br><span class="line">yarn add idb</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">使用pnpm</span></span><br><span class="line">pnpm add idb</span><br></pre></td></tr></table></figure>
<h3 id="在-Vue-中引入">在 Vue 中引入</h3>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 在Vue组件中直接引入</span></span><br><span class="line"><span class="keyword">import</span> &#123; openDB &#125; <span class="keyword">from</span> <span class="string">&#x27;idb&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 或者创建一个专门的数据库管理文件</span></span><br><span class="line"><span class="comment">// src/utils/indexedDB.js</span></span><br><span class="line"><span class="keyword">import</span> &#123; openDB &#125; <span class="keyword">from</span> <span class="string">&#x27;idb&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title function_">useIndexedDB</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="comment">// 数据库操作逻辑</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="基础概念">基础概念</h2>
<h3 id="数据库（Database）">数据库（Database）</h3>
<ul class="lvl-0">
<li class="lvl-2">
<p>数据库是存储数据的容器</p>
</li>
<li class="lvl-2">
<p>每个数据库有一个唯一的名称</p>
</li>
<li class="lvl-2">
<p>数据库可以包含多个对象仓库（store）</p>
</li>
<li class="lvl-2">
<p>数据库有版本号，版本号只能递增</p>
</li>
</ul>
<h3 id="对象仓库（Object-Store）">对象仓库（Object Store）</h3>
<ul class="lvl-0">
<li class="lvl-2">
<p>对象仓库类似于关系数据库中的表</p>
</li>
<li class="lvl-2">
<p>每个对象仓库存储一组相关的数据</p>
</li>
<li class="lvl-2">
<p>每个对象仓库必须有一个主键（key）</p>
</li>
<li class="lvl-2">
<p>主键可以是对象的属性（keyPath）或自动生成（autoIncrement）</p>
</li>
</ul>
<h3 id="事务（Transaction）">事务（Transaction）</h3>
<ul class="lvl-0">
<li class="lvl-2">
<p>事务是一组操作的集合</p>
</li>
<li class="lvl-2">
<p>事务具有 ACID 特性：原子性、一致性、隔离性、持久性</p>
</li>
<li class="lvl-2">
<p>事务有三种模式：readwrite（读写）、readonly（只读）、versionchange（版本变更）</p>
</li>
</ul>
<h3 id="索引（Index）">索引（Index）</h3>
<ul class="lvl-0">
<li class="lvl-2">
<p>索引是对象仓库的排序副本</p>
</li>
<li class="lvl-2">
<p>可以基于对象的属性创建索引</p>
</li>
<li class="lvl-2">
<p>索引可以提高查询效率</p>
</li>
<li class="lvl-2">
<p>一个对象仓库可以有多个索引</p>
</li>
</ul>
<h2 id="数据库连接管理">数据库连接管理</h2>
<h3 id="创建数据库连接">创建数据库连接</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">// src/utils/indexedDB.js</span><br><span class="line">import &#123; openDB &#125; from &#x27;idb&#x27;</span><br><span class="line"></span><br><span class="line">export const DB_NAME = &#x27;MyVueAppDB&#x27;</span><br><span class="line">export const DB_VERSION = 1</span><br><span class="line"></span><br><span class="line">// 创建数据库连接</span><br><span class="line">export const initDB = async () =&gt; &#123;</span><br><span class="line">  return openDB(DB_NAME, DB_VERSION, &#123;</span><br><span class="line">    upgrade(db) &#123;</span><br><span class="line">      // 数据库版本升级时的操作</span><br><span class="line">      console.log(&#x27;数据库升级中...&#x27;)</span><br><span class="line">      </span><br><span class="line">      // 创建用户对象仓库</span><br><span class="line">      if (!db.objectStoreNames.contains(&#x27;users&#x27;)) &#123;</span><br><span class="line">        db.createObjectStore(&#x27;users&#x27;, &#123; </span><br><span class="line">          keyPath: &#x27;id&#x27;,</span><br><span class="line">          autoIncrement: true </span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;</span><br><span class="line">      </span><br><span class="line">      // 创建商品对象仓库</span><br><span class="line">      if (!db.objectStoreNames.contains(&#x27;products&#x27;)) &#123;</span><br><span class="line">        db.createObjectStore(&#x27;products&#x27;, &#123; </span><br><span class="line">          keyPath: &#x27;id&#x27;</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;</span><br><span class="line">      </span><br><span class="line">      // 创建设置对象仓库（类似localStorage）</span><br><span class="line">      if (!db.objectStoreNames.contains(&#x27;settings&#x27;)) &#123;</span><br><span class="line">        db.createObjectStore(&#x27;settings&#x27;)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    </span><br><span class="line">    blocked() &#123;</span><br><span class="line">      // 数据库被其他连接占用时触发</span><br><span class="line">      console.log(&#x27;数据库连接被阻塞，请关闭其他标签页后重试&#x27;)</span><br><span class="line">    &#125;,</span><br><span class="line">    </span><br><span class="line">    blocking() &#123;</span><br><span class="line">      // 当前连接阻塞了新连接的版本升级时触发</span><br><span class="line">      console.log(&#x27;数据库需要升级，正在关闭当前连接...&#x27;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 获取数据库实例</span><br><span class="line">let dbInstance = null</span><br><span class="line">export const getDB = async () =&gt; &#123;</span><br><span class="line">  if (!dbInstance) &#123;</span><br><span class="line">    dbInstance = await initDB()</span><br><span class="line">  &#125;</span><br><span class="line">  return dbInstance</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="连接管理最佳实践">连接管理最佳实践</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">// 在Vue应用中管理数据库连接</span><br><span class="line">// src/plugins/indexedDB.js</span><br><span class="line">import &#123; getDB &#125; from &#x27;@/utils/indexedDB&#x27;</span><br><span class="line"></span><br><span class="line">export default &#123;</span><br><span class="line">  install(app) &#123;</span><br><span class="line">    // 提供全局的数据库实例</span><br><span class="line">    app.provide(&#x27;$db&#x27;, getDB())</span><br><span class="line">    </span><br><span class="line">    // 在组件中可以通过 inject(&#x27;$db&#x27;) 获取</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// main.js</span><br><span class="line">import &#123; createApp &#125; from &#x27;vue&#x27;</span><br><span class="line">import App from &#x27;./App.vue&#x27;</span><br><span class="line">import IndexedDB from &#x27;./plugins/indexedDB&#x27;</span><br><span class="line"></span><br><span class="line">const app = createApp(App)</span><br><span class="line">app.use(IndexedDB)</span><br><span class="line">app.mount(&#x27;#app&#x27;)</span><br></pre></td></tr></table></figure>
<h2 id="数据操作（CRUD）">数据操作（CRUD）</h2>
<h3 id="创建数据（Create）">创建数据（Create）</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">// src/api/user.js</span><br><span class="line">import &#123; getDB &#125; from &#x27;@/utils/indexedDB&#x27;</span><br><span class="line"></span><br><span class="line">export const createUser = async (userData) =&gt; &#123;</span><br><span class="line">  const db = await getDB()</span><br><span class="line">  </span><br><span class="line">  try &#123;</span><br><span class="line">    // 使用add方法添加新数据（主键不存在）</span><br><span class="line">    const userId = await db.add(&#x27;users&#x27;, &#123;</span><br><span class="line">      ...userData,</span><br><span class="line">      createdAt: new Date().toISOString(),</span><br><span class="line">      updatedAt: new Date().toISOString()</span><br><span class="line">    &#125;)</span><br><span class="line">    </span><br><span class="line">    return &#123; success: true, userId &#125;</span><br><span class="line">  &#125; catch (error) &#123;</span><br><span class="line">    console.error(&#x27;创建用户失败:&#x27;, error)</span><br><span class="line">    return &#123; success: false, error: error.message &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">export const createOrUpdateUser = async (userData) =&gt; &#123;</span><br><span class="line">  const db = await getDB()</span><br><span class="line">  </span><br><span class="line">  try &#123;</span><br><span class="line">    // 使用put方法添加或更新数据</span><br><span class="line">    const userId = await db.put(&#x27;users&#x27;, &#123;</span><br><span class="line">      ...userData,</span><br><span class="line">      updatedAt: new Date().toISOString()</span><br><span class="line">    &#125;)</span><br><span class="line">    </span><br><span class="line">    return &#123; success: true, userId &#125;</span><br><span class="line">  &#125; catch (error) &#123;</span><br><span class="line">    console.error(&#x27;创建或更新用户失败:&#x27;, error)</span><br><span class="line">    return &#123; success: false, error: error.message &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="读取数据（Read）">读取数据（Read）</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">// 获取单个用户</span><br><span class="line">export const getUserById = async (userId) =&gt; &#123;</span><br><span class="line">  const db = await getDB()</span><br><span class="line">  </span><br><span class="line">  try &#123;</span><br><span class="line">    const user = await db.get(&#x27;users&#x27;, userId)</span><br><span class="line">    return &#123; success: true, data: user &#125;</span><br><span class="line">  &#125; catch (error) &#123;</span><br><span class="line">    console.error(&#x27;获取用户失败:&#x27;, error)</span><br><span class="line">    return &#123; success: false, error: error.message &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 获取所有用户</span><br><span class="line">export const getAllUsers = async () =&gt; &#123;</span><br><span class="line">  const db = await getDB()</span><br><span class="line">  </span><br><span class="line">  try &#123;</span><br><span class="line">    const users = await db.getAll(&#x27;users&#x27;)</span><br><span class="line">    return &#123; success: true, data: users &#125;</span><br><span class="line">  &#125; catch (error) &#123;</span><br><span class="line">    console.error(&#x27;获取所有用户失败:&#x27;, error)</span><br><span class="line">    return &#123; success: false, error: error.message &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 获取指定数量的用户</span><br><span class="line">export const getUsersByLimit = async (limit, offset = 0) =&gt; &#123;</span><br><span class="line">  const db = await getDB()</span><br><span class="line">  </span><br><span class="line">  try &#123;</span><br><span class="line">    const users = await db.getAll(&#x27;users&#x27;, undefined, limit, offset)</span><br><span class="line">    return &#123; success: true, data: users &#125;</span><br><span class="line">  &#125; catch (error) &#123;</span><br><span class="line">    console.error(&#x27;获取用户列表失败:&#x27;, error)</span><br><span class="line">    return &#123; success: false, error: error.message &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 获取用户总数</span><br><span class="line">export const getUserCount = async () =&gt; &#123;</span><br><span class="line">  const db = await getDB()</span><br><span class="line">  </span><br><span class="line">  try &#123;</span><br><span class="line">    const count = await db.count(&#x27;users&#x27;)</span><br><span class="line">    return &#123; success: true, count &#125;</span><br><span class="line">  &#125; catch (error) &#123;</span><br><span class="line">    console.error(&#x27;获取用户总数失败:&#x27;, error)</span><br><span class="line">    return &#123; success: false, error: error.message &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="更新数据（Update）">更新数据（Update）</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">export const updateUser = async (userId, updateData) =&gt; &#123;</span><br><span class="line">  const db = await getDB()</span><br><span class="line">  </span><br><span class="line">  try &#123;</span><br><span class="line">    // 先获取当前用户数据</span><br><span class="line">    const user = await db.get(&#x27;users&#x27;, userId)</span><br><span class="line">    </span><br><span class="line">    if (!user) &#123;</span><br><span class="line">      return &#123; success: false, error: &#x27;用户不存在&#x27; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // 更新用户数据</span><br><span class="line">    const updatedUser = &#123;</span><br><span class="line">      ...user,</span><br><span class="line">      ...updateData,</span><br><span class="line">      updatedAt: new Date().toISOString()</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    await db.put(&#x27;users&#x27;, updatedUser)</span><br><span class="line">    return &#123; success: true, data: updatedUser &#125;</span><br><span class="line">  &#125; catch (error) &#123;</span><br><span class="line">    console.error(&#x27;更新用户失败:&#x27;, error)</span><br><span class="line">    return &#123; success: false, error: error.message &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="删除数据（Delete）">删除数据（Delete）</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">// 删除单个用户</span><br><span class="line">export const deleteUser = async (userId) =&gt; &#123;</span><br><span class="line">  const db = await getDB()</span><br><span class="line">  </span><br><span class="line">  try &#123;</span><br><span class="line">    await db.delete(&#x27;users&#x27;, userId)</span><br><span class="line">    return &#123; success: true &#125;</span><br><span class="line">  &#125; catch (error) &#123;</span><br><span class="line">    console.error(&#x27;删除用户失败:&#x27;, error)</span><br><span class="line">    return &#123; success: false, error: error.message &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 清空用户表</span><br><span class="line">export const clearAllUsers = async () =&gt; &#123;</span><br><span class="line">  const db = await getDB()</span><br><span class="line">  </span><br><span class="line">  try &#123;</span><br><span class="line">    await db.clear(&#x27;users&#x27;)</span><br><span class="line">    return &#123; success: true &#125;</span><br><span class="line">  &#125; catch (error) &#123;</span><br><span class="line">    console.error(&#x27;清空用户表失败:&#x27;, error)</span><br><span class="line">    return &#123; success: false, error: error.message &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="事务处理">事务处理</h2>
<h3 id="基本事务操作">基本事务操作</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">// 批量创建用户（使用事务确保原子性）</span><br><span class="line">export const batchCreateUsers = async (usersData) =&gt; &#123;</span><br><span class="line">  const db = await getDB()</span><br><span class="line">  </span><br><span class="line">  try &#123;</span><br><span class="line">    // 开始一个读写事务</span><br><span class="line">    const tx = db.transaction(&#x27;users&#x27;, &#x27;readwrite&#x27;)</span><br><span class="line">    const store = tx.objectStore(&#x27;users&#x27;)</span><br><span class="line">    </span><br><span class="line">    const results = []</span><br><span class="line">    for (const userData of usersData) &#123;</span><br><span class="line">      const userId = await store.add(&#123;</span><br><span class="line">        ...userData,</span><br><span class="line">        createdAt: new Date().toISOString(),</span><br><span class="line">        updatedAt: new Date().toISOString()</span><br><span class="line">      &#125;)</span><br><span class="line">      results.push(userId)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // 等待事务完成</span><br><span class="line">    await tx.done</span><br><span class="line">    </span><br><span class="line">    return &#123; success: true, userIds: results &#125;</span><br><span class="line">  &#125; catch (error) &#123;</span><br><span class="line">    console.error(&#x27;批量创建用户失败:&#x27;, error)</span><br><span class="line">    return &#123; success: false, error: error.message &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="跨存储事务">跨存储事务</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">// 同时操作多个对象仓库</span><br><span class="line">export const createOrderWithProducts = async (orderData, productIds) =&gt; &#123;</span><br><span class="line">  const db = await getDB()</span><br><span class="line">  </span><br><span class="line">  try &#123;</span><br><span class="line">    // 开始一个跨存储的读写事务</span><br><span class="line">    const tx = db.transaction([&#x27;orders&#x27;, &#x27;products&#x27;, &#x27;inventory&#x27;], &#x27;readwrite&#x27;)</span><br><span class="line">    </span><br><span class="line">    const orderStore = tx.objectStore(&#x27;orders&#x27;)</span><br><span class="line">    const productStore = tx.objectStore(&#x27;products&#x27;)</span><br><span class="line">    const inventoryStore = tx.objectStore(&#x27;inventory&#x27;)</span><br><span class="line">    </span><br><span class="line">    // 1. 创建订单</span><br><span class="line">    const orderId = await orderStore.add(&#123;</span><br><span class="line">      ...orderData,</span><br><span class="line">      createdAt: new Date().toISOString(),</span><br><span class="line">      status: &#x27;pending&#x27;</span><br><span class="line">    &#125;)</span><br><span class="line">    </span><br><span class="line">    // 2. 获取相关产品信息</span><br><span class="line">    const products = []</span><br><span class="line">    for (const productId of productIds) &#123;</span><br><span class="line">      const product = await productStore.get(productId)</span><br><span class="line">      if (product) &#123;</span><br><span class="line">        products.push(product)</span><br><span class="line">        </span><br><span class="line">        // 3. 更新库存</span><br><span class="line">        const inventory = await inventoryStore.get(productId)</span><br><span class="line">        if (inventory &amp;&amp; inventory.quantity &gt; 0) &#123;</span><br><span class="line">          await inventoryStore.put(&#123;</span><br><span class="line">            ...inventory,</span><br><span class="line">            quantity: inventory.quantity - 1</span><br><span class="line">          &#125;)</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">          throw new Error(`产品 $&#123;product.name&#125; 库存不足`)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // 等待事务完成</span><br><span class="line">    await tx.done</span><br><span class="line">    </span><br><span class="line">    return &#123;</span><br><span class="line">      success: true,</span><br><span class="line">      orderId,</span><br><span class="line">      products</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; catch (error) &#123;</span><br><span class="line">    console.error(&#x27;创建订单失败:&#x27;, error)</span><br><span class="line">    return &#123; success: false, error: error.message &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="事务错误处理">事务错误处理</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">// 事务错误处理示例</span><br><span class="line">export const safeTransaction = async (storeNames, mode, operation) =&gt; &#123;</span><br><span class="line">  const db = await getDB()</span><br><span class="line">  </span><br><span class="line">  try &#123;</span><br><span class="line">    const tx = db.transaction(storeNames, mode)</span><br><span class="line">    </span><br><span class="line">    // 监听事务错误</span><br><span class="line">    tx.onerror = (event) =&gt; &#123;</span><br><span class="line">      console.error(&#x27;事务错误:&#x27;, event.target.error)</span><br><span class="line">      // 阻止错误冒泡到全局</span><br><span class="line">      event.preventDefault()</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    tx.onabort = () =&gt; &#123;</span><br><span class="line">      console.log(&#x27;事务被中止&#x27;)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    tx.oncomplete = () =&gt; &#123;</span><br><span class="line">      console.log(&#x27;事务完成&#x27;)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    const result = await operation(tx)</span><br><span class="line">    await tx.done</span><br><span class="line">    </span><br><span class="line">    return &#123; success: true, result &#125;</span><br><span class="line">  &#125; catch (error) &#123;</span><br><span class="line">    console.error(&#x27;事务操作失败:&#x27;, error)</span><br><span class="line">    return &#123; success: false, error: error.message &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 使用安全事务</span><br><span class="line">export const transferPoints = async (fromUserId, toUserId, amount) =&gt; &#123;</span><br><span class="line">  return safeTransaction([&#x27;users&#x27;], &#x27;readwrite&#x27;, async (tx) =&gt; &#123;</span><br><span class="line">    const store = tx.objectStore(&#x27;users&#x27;)</span><br><span class="line">    </span><br><span class="line">    // 获取用户数据</span><br><span class="line">    const fromUser = await store.get(fromUserId)</span><br><span class="line">    const toUser = await store.get(toUserId)</span><br><span class="line">    </span><br><span class="line">    if (!fromUser) throw new Error(&#x27;源用户不存在&#x27;)</span><br><span class="line">    if (!toUser) throw new Error(&#x27;目标用户不存在&#x27;)</span><br><span class="line">    if (fromUser.points &lt; amount) throw new Error(&#x27;积分不足&#x27;)</span><br><span class="line">    </span><br><span class="line">    // 更新积分</span><br><span class="line">    await store.put(&#123;</span><br><span class="line">      ...fromUser,</span><br><span class="line">      points: fromUser.points - amount,</span><br><span class="line">      updatedAt: new Date().toISOString()</span><br><span class="line">    &#125;)</span><br><span class="line">    </span><br><span class="line">    await store.put(&#123;</span><br><span class="line">      ...toUser,</span><br><span class="line">      points: toUser.points + amount,</span><br><span class="line">      updatedAt: new Date().toISOString()</span><br><span class="line">    &#125;)</span><br><span class="line">    </span><br><span class="line">    // 记录交易</span><br><span class="line">    const transaction = &#123;</span><br><span class="line">      id: Date.now(),</span><br><span class="line">      fromUserId,</span><br><span class="line">      toUserId,</span><br><span class="line">      amount,</span><br><span class="line">      timestamp: new Date().toISOString()</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    return transaction</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="数据库版本管理">数据库版本管理</h2>
<h3 id="版本升级策略">版本升级策略</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">// src/utils/indexedDB.js - 版本升级示例</span><br><span class="line">export const DB_NAME = &#x27;MyVueAppDB&#x27;</span><br><span class="line">export const DB_VERSION = 3 // 升级到版本3</span><br><span class="line"></span><br><span class="line">export const initDB = async () =&gt; &#123;</span><br><span class="line">  return openDB(DB_NAME, DB_VERSION, &#123;</span><br><span class="line">    upgrade(db, oldVersion, newVersion) &#123;</span><br><span class="line">      console.log(`数据库升级: $&#123;oldVersion&#125; -&gt; $&#123;newVersion&#125;`)</span><br><span class="line">      </span><br><span class="line">      // 版本 0 -&gt; 1: 初始版本</span><br><span class="line">      if (oldVersion &lt; 1) &#123;</span><br><span class="line">        // 创建用户表</span><br><span class="line">        const userStore = db.createObjectStore(&#x27;users&#x27;, &#123; </span><br><span class="line">          keyPath: &#x27;id&#x27;,</span><br><span class="line">          autoIncrement: true </span><br><span class="line">        &#125;)</span><br><span class="line">        </span><br><span class="line">        // 创建商品表</span><br><span class="line">        db.createObjectStore(&#x27;products&#x27;, &#123; keyPath: &#x27;id&#x27; &#125;)</span><br><span class="line">        </span><br><span class="line">        // 创建设置表</span><br><span class="line">        db.createObjectStore(&#x27;settings&#x27;)</span><br><span class="line">      &#125;</span><br><span class="line">      </span><br><span class="line">      // 版本 1 -&gt; 2: 添加订单表和索引</span><br><span class="line">      if (oldVersion &lt; 2) &#123;</span><br><span class="line">        // 创建订单表</span><br><span class="line">        const orderStore = db.createObjectStore(&#x27;orders&#x27;, &#123; </span><br><span class="line">          keyPath: &#x27;id&#x27;,</span><br><span class="line">          autoIncrement: true </span><br><span class="line">        &#125;)</span><br><span class="line">        </span><br><span class="line">        // 为订单表创建用户ID索引</span><br><span class="line">        orderStore.createIndex(&#x27;userId&#x27;, &#x27;userId&#x27;)</span><br><span class="line">        orderStore.createIndex(&#x27;status&#x27;, &#x27;status&#x27;)</span><br><span class="line">        orderStore.createIndex(&#x27;createdAt&#x27;, &#x27;createdAt&#x27;)</span><br><span class="line">        </span><br><span class="line">        // 为用户表添加索引</span><br><span class="line">        const userStore = db.transaction(&#x27;users&#x27;, &#x27;readwrite&#x27;).objectStore(&#x27;users&#x27;)</span><br><span class="line">        userStore.createIndex(&#x27;email&#x27;, &#x27;email&#x27;, &#123; unique: true &#125;)</span><br><span class="line">        userStore.createIndex(&#x27;username&#x27;, &#x27;username&#x27;, &#123; unique: true &#125;)</span><br><span class="line">      &#125;</span><br><span class="line">      </span><br><span class="line">      // 版本 2 -&gt; 3: 添加库存表和修改用户表结构</span><br><span class="line">      if (oldVersion &lt; 3) &#123;</span><br><span class="line">        // 创建库存表</span><br><span class="line">        db.createObjectStore(&#x27;inventory&#x27;, &#123; keyPath: &#x27;productId&#x27; &#125;)</span><br><span class="line">        </span><br><span class="line">        // 修改用户表结构</span><br><span class="line">        const userStore = db.transaction(&#x27;users&#x27;, &#x27;readwrite&#x27;).objectStore(&#x27;users&#x27;)</span><br><span class="line">        </span><br><span class="line">        // 如果用户表没有points字段，添加默认值</span><br><span class="line">        userStore.openCursor().then(function cursorIterate(cursor) &#123;</span><br><span class="line">          if (!cursor) return</span><br><span class="line">          </span><br><span class="line">          const user = cursor.value</span><br><span class="line">          if (user.points === undefined) &#123;</span><br><span class="line">            user.points = 0 // 默认积分</span><br><span class="line">            user.level = 1 // 默认等级</span><br><span class="line">            cursor.update(user)</span><br><span class="line">          &#125;</span><br><span class="line">          </span><br><span class="line">          return cursor.continue().then(cursorIterate)</span><br><span class="line">        &#125;)</span><br><span class="line">        </span><br><span class="line">        // 为用户表添加新的索引</span><br><span class="line">        userStore.createIndex(&#x27;level&#x27;, &#x27;level&#x27;)</span><br><span class="line">        userStore.createIndex(&#x27;points&#x27;, &#x27;points&#x27;)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="版本管理最佳实践">版本管理最佳实践</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">// 数据库版本管理工具</span><br><span class="line">export const getCurrentDBVersion = async () =&gt; &#123;</span><br><span class="line">  try &#123;</span><br><span class="line">    const db = await openDB(DB_NAME, 1, &#123; upgrade: () =&gt; &#123;&#125; &#125;)</span><br><span class="line">    const version = db.version</span><br><span class="line">    db.close()</span><br><span class="line">    return version</span><br><span class="line">  &#125; catch (error) &#123;</span><br><span class="line">    if (error.name === &#x27;NotFoundError&#x27;) &#123;</span><br><span class="line">      return 0 // 数据库不存在</span><br><span class="line">    &#125;</span><br><span class="line">    throw error</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 数据库迁移工具</span><br><span class="line">export const migrateDB = async (targetVersion) =&gt; &#123;</span><br><span class="line">  const currentVersion = await getCurrentDBVersion()</span><br><span class="line">  </span><br><span class="line">  if (currentVersion &gt;= targetVersion) &#123;</span><br><span class="line">    console.log(`数据库版本已是 $&#123;currentVersion&#125;，无需迁移`)</span><br><span class="line">    return true</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  console.log(`开始数据库迁移: $&#123;currentVersion&#125; -&gt; $&#123;targetVersion&#125;`)</span><br><span class="line">  </span><br><span class="line">  try &#123;</span><br><span class="line">    const db = await openDB(DB_NAME, targetVersion, &#123;</span><br><span class="line">      upgrade(db, oldVersion, newVersion) &#123;</span><br><span class="line">        console.log(`执行升级: $&#123;oldVersion&#125; -&gt; $&#123;newVersion&#125;`)</span><br><span class="line">        // 这里可以执行具体的升级逻辑</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    </span><br><span class="line">    db.close()</span><br><span class="line">    console.log(&#x27;数据库迁移完成&#x27;)</span><br><span class="line">    return true</span><br><span class="line">  &#125; catch (error) &#123;</span><br><span class="line">    console.error(&#x27;数据库迁移失败:&#x27;, error)</span><br><span class="line">    throw error</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="索引使用">索引使用</h2>
<h3 id="创建索引">创建索引</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">// 在数据库升级时创建索引</span><br><span class="line">export const initDBWithIndexes = async () =&gt; &#123;</span><br><span class="line">  return openDB(&#x27;MyAppDB&#x27;, 2, &#123;</span><br><span class="line">    upgrade(db) &#123;</span><br><span class="line">      // 用户表索引</span><br><span class="line">      if (db.objectStoreNames.contains(&#x27;users&#x27;)) &#123;</span><br><span class="line">        const userStore = db.transaction(&#x27;users&#x27;, &#x27;readwrite&#x27;).objectStore(&#x27;users&#x27;)</span><br><span class="line">        </span><br><span class="line">        // 创建普通索引</span><br><span class="line">        if (!userStore.indexNames.contains(&#x27;email&#x27;)) &#123;</span><br><span class="line">          userStore.createIndex(&#x27;email&#x27;, &#x27;email&#x27;, &#123; unique: true &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // 创建复合索引</span><br><span class="line">        if (!userStore.indexNames.contains(&#x27;nameAge&#x27;)) &#123;</span><br><span class="line">          userStore.createIndex(&#x27;nameAge&#x27;, [&#x27;name&#x27;, &#x27;age&#x27;])</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // 创建多字段索引</span><br><span class="line">        if (!userStore.indexNames.contains(&#x27;addressCity&#x27;)) &#123;</span><br><span class="line">          userStore.createIndex(&#x27;addressCity&#x27;, &#x27;address.city&#x27;)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      </span><br><span class="line">      // 订单表索引</span><br><span class="line">      if (!db.objectStoreNames.contains(&#x27;orders&#x27;)) &#123;</span><br><span class="line">        const orderStore = db.createObjectStore(&#x27;orders&#x27;, &#123; </span><br><span class="line">          keyPath: &#x27;id&#x27;,</span><br><span class="line">          autoIncrement: true </span><br><span class="line">        &#125;)</span><br><span class="line">        </span><br><span class="line">        // 创建多个索引</span><br><span class="line">        orderStore.createIndex(&#x27;userId&#x27;, &#x27;userId&#x27;)</span><br><span class="line">        orderStore.createIndex(&#x27;status&#x27;, &#x27;status&#x27;)</span><br><span class="line">        orderStore.createIndex(&#x27;createdAt&#x27;, &#x27;createdAt&#x27;)</span><br><span class="line">        orderStore.createIndex(&#x27;totalAmount&#x27;, &#x27;totalAmount&#x27;)</span><br><span class="line">        </span><br><span class="line">        // 创建唯一索引</span><br><span class="line">        orderStore.createIndex(&#x27;orderNumber&#x27;, &#x27;orderNumber&#x27;, &#123; unique: true &#125;)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="使用索引查询">使用索引查询</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">// 通过索引查询</span><br><span class="line">export const getUserByEmail = async (email) =&gt; &#123;</span><br><span class="line">  const db = await getDB()</span><br><span class="line">  </span><br><span class="line">  try &#123;</span><br><span class="line">    const user = await db.getFromIndex(&#x27;users&#x27;, &#x27;email&#x27;, email)</span><br><span class="line">    return &#123; success: true, data: user &#125;</span><br><span class="line">  &#125; catch (error) &#123;</span><br><span class="line">    console.error(&#x27;通过邮箱查询用户失败:&#x27;, error)</span><br><span class="line">    return &#123; success: false, error: error.message &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 通过索引获取多个结果</span><br><span class="line">export const getOrdersByUserId = async (userId) =&gt; &#123;</span><br><span class="line">  const db = await getDB()</span><br><span class="line">  </span><br><span class="line">  try &#123;</span><br><span class="line">    const orders = await db.getAllFromIndex(&#x27;orders&#x27;, &#x27;userId&#x27;, userId)</span><br><span class="line">    return &#123; success: true, data: orders &#125;</span><br><span class="line">  &#125; catch (error) &#123;</span><br><span class="line">    console.error(&#x27;通过用户ID查询订单失败:&#x27;, error)</span><br><span class="line">    return &#123; success: false, error: error.message &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 通过索引获取范围数据</span><br><span class="line">export const getHighValueOrders = async (minAmount) =&gt; &#123;</span><br><span class="line">  const db = await getDB()</span><br><span class="line">  </span><br><span class="line">  try &#123;</span><br><span class="line">    // 获取金额大于等于minAmount的订单</span><br><span class="line">    const range = IDBKeyRange.lowerBound(minAmount)</span><br><span class="line">    const orders = await db.getAllFromIndex(&#x27;orders&#x27;, &#x27;totalAmount&#x27;, range)</span><br><span class="line">    </span><br><span class="line">    return &#123; success: true, data: orders &#125;</span><br><span class="line">  &#125; catch (error) &#123;</span><br><span class="line">    console.error(&#x27;查询高价值订单失败:&#x27;, error)</span><br><span class="line">    return &#123; success: false, error: error.message &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="索引管理">索引管理</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">// 索引管理工具</span><br><span class="line">export const getIndexNames = async (storeName) =&gt; &#123;</span><br><span class="line">  const db = await getDB()</span><br><span class="line">  </span><br><span class="line">  try &#123;</span><br><span class="line">    const tx = db.transaction(storeName, &#x27;readonly&#x27;)</span><br><span class="line">    const store = tx.objectStore(storeName)</span><br><span class="line">    const indexes = Array.from(store.indexNames)</span><br><span class="line">    </span><br><span class="line">    await tx.done</span><br><span class="line">    return &#123; success: true, indexes &#125;</span><br><span class="line">  &#125; catch (error) &#123;</span><br><span class="line">    console.error(`获取$&#123;storeName&#125;索引列表失败:`, error)</span><br><span class="line">    return &#123; success: false, error: error.message &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 删除索引</span><br><span class="line">export const deleteIndex = async (storeName, indexName) =&gt; &#123;</span><br><span class="line">  const db = await getDB()</span><br><span class="line">  </span><br><span class="line">  try &#123;</span><br><span class="line">    const tx = db.transaction(storeName, &#x27;readwrite&#x27;)</span><br><span class="line">    const store = tx.objectStore(storeName)</span><br><span class="line">    </span><br><span class="line">    if (store.indexNames.contains(indexName)) &#123;</span><br><span class="line">      store.deleteIndex(indexName)</span><br><span class="line">      await tx.done</span><br><span class="line">      return &#123; success: true, message: `索引 $&#123;indexName&#125; 删除成功` &#125;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      return &#123; success: false, error: `索引 $&#123;indexName&#125; 不存在` &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; catch (error) &#123;</span><br><span class="line">    console.error(`删除索引 $&#123;indexName&#125; 失败:`, error)</span><br><span class="line">    return &#123; success: false, error: error.message &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="高级查询操作">高级查询操作</h2>
<h3 id="区间查找">区间查找</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">// 区间查找工具</span><br><span class="line">export const getUsersByAgeRange = async (minAge, maxAge) =&gt; &#123;</span><br><span class="line">  const db = await getDB()</span><br><span class="line">  </span><br><span class="line">  try &#123;</span><br><span class="line">    // 创建区间对象</span><br><span class="line">    const ageRange = IDBKeyRange.bound(minAge, maxAge)</span><br><span class="line">    </span><br><span class="line">    // 通过索引查询区间数据</span><br><span class="line">    const users = await db.getAllFromIndex(&#x27;users&#x27;, &#x27;age&#x27;, ageRange)</span><br><span class="line">    </span><br><span class="line">    return &#123; success: true, data: users &#125;</span><br><span class="line">  &#125; catch (error) &#123;</span><br><span class="line">    console.error(&#x27;按年龄区间查询用户失败:&#x27;, error)</span><br><span class="line">    return &#123; success: false, error: error.message &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 复杂区间查询</span><br><span class="line">export const getRecentOrdersByStatus = async (status, days = 7) =&gt; &#123;</span><br><span class="line">  const db = await getDB()</span><br><span class="line">  </span><br><span class="line">  try &#123;</span><br><span class="line">    const date = new Date()</span><br><span class="line">    date.setDate(date.getDate() - days)</span><br><span class="line">    const minDate = date.toISOString()</span><br><span class="line">    </span><br><span class="line">    // 使用复合查询：状态和日期范围</span><br><span class="line">    const tx = db.transaction(&#x27;orders&#x27;, &#x27;readonly&#x27;)</span><br><span class="line">    const store = tx.objectStore(&#x27;orders&#x27;)</span><br><span class="line">    </span><br><span class="line">    // 先按状态筛选</span><br><span class="line">    const statusIndex = store.index(&#x27;status&#x27;)</span><br><span class="line">    const statusRange = IDBKeyRange.only(status)</span><br><span class="line">    </span><br><span class="line">    const orders = []</span><br><span class="line">    </span><br><span class="line">    // 使用游标遍历结果并进一步筛选日期</span><br><span class="line">    await new Promise((resolve, reject) =&gt; &#123;</span><br><span class="line">      const cursorRequest = statusIndex.openCursor(statusRange)</span><br><span class="line">      </span><br><span class="line">      cursorRequest.onsuccess = (event) =&gt; &#123;</span><br><span class="line">        const cursor = event.target.result</span><br><span class="line">        if (cursor) &#123;</span><br><span class="line">          const order = cursor.value</span><br><span class="line">          if (order.createdAt &gt;= minDate) &#123;</span><br><span class="line">            orders.push(order)</span><br><span class="line">          &#125;</span><br><span class="line">          cursor.continue()</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">          resolve()</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      </span><br><span class="line">      cursorRequest.onerror = (event) =&gt; &#123;</span><br><span class="line">        reject(event.target.error)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    </span><br><span class="line">    await tx.done</span><br><span class="line">    return &#123; success: true, data: orders &#125;</span><br><span class="line">  &#125; catch (error) &#123;</span><br><span class="line">    console.error(&#x27;查询最近订单失败:&#x27;, error)</span><br><span class="line">    return &#123; success: false, error: error.message &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="游标操作">游标操作</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line">// 使用游标遍历所有数据</span><br><span class="line">export const iterateAllUsers = async (callback) =&gt; &#123;</span><br><span class="line">  const db = await getDB()</span><br><span class="line">  </span><br><span class="line">  try &#123;</span><br><span class="line">    const tx = db.transaction(&#x27;users&#x27;, &#x27;readonly&#x27;)</span><br><span class="line">    const store = tx.objectStore(&#x27;users&#x27;)</span><br><span class="line">    </span><br><span class="line">    await new Promise((resolve, reject) =&gt; &#123;</span><br><span class="line">      const cursorRequest = store.openCursor()</span><br><span class="line">      </span><br><span class="line">      cursorRequest.onsuccess = (event) =&gt; &#123;</span><br><span class="line">        const cursor = event.target.result</span><br><span class="line">        if (cursor) &#123;</span><br><span class="line">          // 调用回调函数处理当前记录</span><br><span class="line">          const shouldContinue = callback(cursor.value, cursor.key)</span><br><span class="line">          </span><br><span class="line">          if (shouldContinue !== false) &#123;</span><br><span class="line">            cursor.continue()</span><br><span class="line">          &#125; else &#123;</span><br><span class="line">            resolve() // 停止遍历</span><br><span class="line">          &#125;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">          resolve() // 遍历完成</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      </span><br><span class="line">      cursorRequest.onerror = (event) =&gt; &#123;</span><br><span class="line">        reject(event.target.error)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    </span><br><span class="line">    await tx.done</span><br><span class="line">    return &#123; success: true &#125;</span><br><span class="line">  &#125; catch (error) &#123;</span><br><span class="line">    console.error(&#x27;遍历用户数据失败:&#x27;, error)</span><br><span class="line">    return &#123; success: false, error: error.message &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 使用游标进行分页查询</span><br><span class="line">export const getUsersByPage = async (page = 1, pageSize = 20) =&gt; &#123;</span><br><span class="line">  const db = await getDB()</span><br><span class="line">  </span><br><span class="line">  try &#123;</span><br><span class="line">    const tx = db.transaction(&#x27;users&#x27;, &#x27;readonly&#x27;)</span><br><span class="line">    const store = tx.objectStore(&#x27;users&#x27;)</span><br><span class="line">    </span><br><span class="line">    const users = []</span><br><span class="line">    const totalCount = await store.count()</span><br><span class="line">    const totalPages = Math.ceil(totalCount / pageSize)</span><br><span class="line">    const skip = (page - 1) * pageSize</span><br><span class="line">    </span><br><span class="line">    let count = 0</span><br><span class="line">    </span><br><span class="line">    await new Promise((resolve, reject) =&gt; &#123;</span><br><span class="line">      const cursorRequest = store.openCursor()</span><br><span class="line">      </span><br><span class="line">      cursorRequest.onsuccess = (event) =&gt; &#123;</span><br><span class="line">        const cursor = event.target.result</span><br><span class="line">        if (cursor) &#123;</span><br><span class="line">          if (count &gt;= skip &amp;&amp; count &lt; skip + pageSize) &#123;</span><br><span class="line">            users.push(cursor.value)</span><br><span class="line">          &#125;</span><br><span class="line">          </span><br><span class="line">          count++</span><br><span class="line">          </span><br><span class="line">          if (count &lt; skip + pageSize) &#123;</span><br><span class="line">            cursor.continue()</span><br><span class="line">          &#125; else &#123;</span><br><span class="line">            resolve()</span><br><span class="line">          &#125;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">          resolve()</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      </span><br><span class="line">      cursorRequest.onerror = (event) =&gt; &#123;</span><br><span class="line">        reject(event.target.error)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    </span><br><span class="line">    await tx.done</span><br><span class="line">    </span><br><span class="line">    return &#123;</span><br><span class="line">      success: true,</span><br><span class="line">      data: users,</span><br><span class="line">      pagination: &#123;</span><br><span class="line">        page,</span><br><span class="line">        pageSize,</span><br><span class="line">        totalCount,</span><br><span class="line">        totalPages</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; catch (error) &#123;</span><br><span class="line">    console.error(&#x27;分页查询用户失败:&#x27;, error)</span><br><span class="line">    return &#123; success: false, error: error.message &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="复杂查询组合">复杂查询组合</h3>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 复杂查询示例：多条件筛选和排序</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title function_">searchUsers</span> = <span class="keyword">async</span> (<span class="params">filters = &#123;&#125;, sort = &#123; field: <span class="string">&#x27;createdAt&#x27;</span>, order: <span class="string">&#x27;desc&#x27;</span> &#125;</span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> db = <span class="keyword">await</span> <span class="title function_">getDB</span>()</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> tx = db.<span class="title function_">transaction</span>(<span class="string">&#x27;users&#x27;</span>, <span class="string">&#x27;readonly&#x27;</span>)</span><br><span class="line">    <span class="keyword">const</span> store = tx.<span class="title function_">objectStore</span>(<span class="string">&#x27;users&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">let</span> cursorRequest</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 根据筛选条件选择合适的索引</span></span><br><span class="line">    <span class="keyword">if</span> (filters.<span class="property">email</span>) &#123;</span><br><span class="line">      cursorRequest = store.<span class="title function_">index</span>(<span class="string">&#x27;email&#x27;</span>).<span class="title function_">openCursor</span>(<span class="title class_">IDBKeyRange</span>.<span class="title function_">only</span>(filters.<span class="property">email</span>))</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (filters.<span class="property">age</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> ageRange = <span class="title class_">IDBKeyRange</span>.<span class="title function_">bound</span>(</span><br><span class="line">        filters.<span class="property">age</span>.<span class="property">min</span> || <span class="number">0</span>,</span><br><span class="line">        filters.<span class="property">age</span>.<span class="property">max</span> || <span class="number">150</span></span><br><span class="line">      )</span><br><span class="line">      cursorRequest = store.<span class="title function_">index</span>(<span class="string">&#x27;age&#x27;</span>).<span class="title function_">openCursor</span>(ageRange)</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (filters.<span class="property">level</span>) &#123;</span><br><span class="line">      cursorRequest = store.<span class="title function_">index</span>(<span class="string">&#x27;level&#x27;</span>).<span class="title function_">openCursor</span>(<span class="title class_">IDBKeyRange</span>.<span class="title function_">only</span>(filters.<span class="property">level</span>))</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// 默认遍历所有数据</span></span><br><span class="line">      cursorRequest = store.<span class="title function_">openCursor</span>()</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">const</span> users = []</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">await</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">      cursorRequest.<span class="property">onsuccess</span> = <span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> cursor = event.<span class="property">target</span>.<span class="property">result</span></span><br><span class="line">        <span class="keyword">if</span> (cursor) &#123;</span><br><span class="line">          <span class="keyword">const</span> user = cursor.<span class="property">value</span></span><br><span class="line">          <span class="keyword">let</span> match = <span class="literal">true</span></span><br><span class="line">          </span><br><span class="line">          <span class="comment">// 应用额外的筛选条件</span></span><br><span class="line">          <span class="keyword">if</span> (filters.<span class="property">name</span> &amp;&amp; !user.<span class="property">name</span>.<span class="title function_">toLowerCase</span>().<span class="title function_">includes</span>(filters.<span class="property">name</span>.<span class="title function_">toLowerCase</span>())) &#123;</span><br><span class="line">            match = <span class="literal">false</span></span><br><span class="line">          &#125;</span><br><span class="line">          </span><br><span class="line">          <span class="keyword">if</span> (filters.<span class="property">points</span> &amp;&amp; user.<span class="property">points</span> &lt; (filters.<span class="property">points</span>.<span class="property">min</span> || <span class="number">0</span>)) &#123;</span><br><span class="line">            match = <span class="literal">false</span></span><br><span class="line">          &#125;</span><br><span class="line">          </span><br><span class="line">          <span class="keyword">if</span> (match) &#123;</span><br><span class="line">            users.<span class="title function_">push</span>(user)</span><br><span class="line">          &#125;</span><br><span class="line">          </span><br><span class="line">          cursor.<span class="title function_">continue</span>()</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="comment">// 遍历完成后进行排序</span></span><br><span class="line">          users.<span class="title function_">sort</span>(<span class="function">(<span class="params">a, b</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (a[sort.<span class="property">field</span>] &lt; b[sort.<span class="property">field</span>]) &#123;</span><br><span class="line">              <span class="keyword">return</span> sort.<span class="property">order</span> === <span class="string">&#x27;asc&#x27;</span> ? -<span class="number">1</span> : <span class="number">1</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (a[sort.<span class="property">field</span>] &gt; b[sort.<span class="property">field</span>]) &#123;</span><br><span class="line">              <span class="keyword">return</span> sort.<span class="property">order</span> === <span class="string">&#x27;asc&#x27;</span> ? <span class="number">1</span> : -<span class="number">1</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">          &#125;)</span><br><span class="line">          </span><br><span class="line">          <span class="title function_">resolve</span>()</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      </span><br><span class="line">      cursorRequest.<span class="property">onerror</span> = <span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="title function_">reject</span>(event.<span class="property">target</span>.<span class="property">error</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">await</span> tx.<span class="property">done</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> &#123; <span class="attr">success</span>: <span class="literal">true</span>, <span class="attr">data</span>: users &#125;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;搜索用户失败:&#x27;</span>, error)</span><br><span class="line">    <span class="keyword">return</span> &#123; <span class="attr">success</span>: <span class="literal">false</span>, <span class="attr">error</span>: error.<span class="property">message</span> &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Vue-中的最佳实践">Vue 中的最佳实践</h2>
<h3 id="创建-Vue-Composition-API-封装">创建 Vue Composition API 封装</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br></pre></td><td class="code"><pre><span class="line">// src/composables/useIndexedDB.js</span><br><span class="line">import &#123; ref, reactive, toRefs &#125; from &#x27;vue&#x27;</span><br><span class="line">import &#123; getDB &#125; from &#x27;@/utils/indexedDB&#x27;</span><br><span class="line"></span><br><span class="line">export const useIndexedDB = (storeName) =&gt; &#123;</span><br><span class="line">  const state = reactive(&#123;</span><br><span class="line">    data: null,</span><br><span class="line">    loading: false,</span><br><span class="line">    error: null,</span><br><span class="line">    pagination: &#123;</span><br><span class="line">      page: 1,</span><br><span class="line">      pageSize: 20,</span><br><span class="line">      totalCount: 0,</span><br><span class="line">      totalPages: 0</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  const resetState = () =&gt; &#123;</span><br><span class="line">    state.data = null</span><br><span class="line">    state.loading = false</span><br><span class="line">    state.error = null</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  const getById = async (id) =&gt; &#123;</span><br><span class="line">    resetState()</span><br><span class="line">    state.loading = true</span><br><span class="line"></span><br><span class="line">    try &#123;</span><br><span class="line">      const db = await getDB()</span><br><span class="line">      const data = await db.get(storeName, id)</span><br><span class="line">      state.data = data</span><br><span class="line">      return &#123; success: true, data &#125;</span><br><span class="line">    &#125; catch (error) &#123;</span><br><span class="line">      state.error = error.message</span><br><span class="line">      console.error(`获取$&#123;storeName&#125;数据失败:`, error)</span><br><span class="line">      return &#123; success: false, error: error.message &#125;</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">      state.loading = false</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  const getAll = async () =&gt; &#123;</span><br><span class="line">    resetState()</span><br><span class="line">    state.loading = true</span><br><span class="line"></span><br><span class="line">    try &#123;</span><br><span class="line">      const db = await getDB()</span><br><span class="line">      const data = await db.getAll(storeName)</span><br><span class="line">      state.data = data</span><br><span class="line">      state.pagination.totalCount = data.length</span><br><span class="line">      state.pagination.totalPages = 1</span><br><span class="line">      return &#123; success: true, data &#125;</span><br><span class="line">    &#125; catch (error) &#123;</span><br><span class="line">      state.error = error.message</span><br><span class="line">      console.error(`获取所有$&#123;storeName&#125;数据失败:`, error)</span><br><span class="line">      return &#123; success: false, error: error.message &#125;</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">      state.loading = false</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  const getByPage = async (page = 1, pageSize = 20) =&gt; &#123;</span><br><span class="line">    resetState()</span><br><span class="line">    state.loading = true</span><br><span class="line"></span><br><span class="line">    try &#123;</span><br><span class="line">      const db = await getDB()</span><br><span class="line">      const tx = db.transaction(storeName, &#x27;readonly&#x27;)</span><br><span class="line">      const store = tx.objectStore(storeName)</span><br><span class="line"></span><br><span class="line">      const totalCount = await store.count()</span><br><span class="line">      const totalPages = Math.ceil(totalCount / pageSize)</span><br><span class="line">      const skip = (page - 1) * pageSize</span><br><span class="line"></span><br><span class="line">      const data = []</span><br><span class="line">      let count = 0</span><br><span class="line"></span><br><span class="line">      await new Promise((resolve, reject) =&gt; &#123;</span><br><span class="line">        const cursorRequest = store.openCursor()</span><br><span class="line"></span><br><span class="line">        cursorRequest.onsuccess = (event) =&gt; &#123;</span><br><span class="line">          const cursor = event.target.result</span><br><span class="line">          if (cursor) &#123;</span><br><span class="line">            if (count &gt;= skip &amp;&amp; count &lt; skip + pageSize) &#123;</span><br><span class="line">              data.push(cursor.value)</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            count++</span><br><span class="line"></span><br><span class="line">            if (count &lt; skip + pageSize) &#123;</span><br><span class="line">              cursor.continue()</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">              resolve()</span><br><span class="line">            &#125;</span><br><span class="line">          &#125; else &#123;</span><br><span class="line">            resolve()</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        cursorRequest.onerror = (event) =&gt; &#123;</span><br><span class="line">          reject(event.target.error)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">      await tx.done</span><br><span class="line"></span><br><span class="line">      state.data = data</span><br><span class="line">      state.pagination = &#123;</span><br><span class="line">        page,</span><br><span class="line">        pageSize,</span><br><span class="line">        totalCount,</span><br><span class="line">        totalPages</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      return &#123;</span><br><span class="line">        success: true,</span><br><span class="line">        data,</span><br><span class="line">        pagination: state.pagination</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; catch (error) &#123;</span><br><span class="line">      state.error = error.message</span><br><span class="line">      console.error(`分页获取$&#123;storeName&#125;数据失败:`, error)</span><br><span class="line">      return &#123; success: false, error: error.message &#125;</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">      state.loading = false</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  const create = async (item) =&gt; &#123;</span><br><span class="line">    state.loading = true</span><br><span class="line"></span><br><span class="line">    try &#123;</span><br><span class="line">      const db = await getDB()</span><br><span class="line">      const id = await db.add(storeName, item)</span><br><span class="line">      return &#123; success: true, id &#125;</span><br><span class="line">    &#125; catch (error) &#123;</span><br><span class="line">      state.error = error.message</span><br><span class="line">      console.error(`创建$&#123;storeName&#125;数据失败:`, error)</span><br><span class="line">      return &#123; success: false, error: error.message &#125;</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">      state.loading = false</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  const update = async (id, item) =&gt; &#123;</span><br><span class="line">    state.loading = true</span><br><span class="line"></span><br><span class="line">    try &#123;</span><br><span class="line">      const db = await getDB()</span><br><span class="line">      await db.put(storeName, &#123; ...item, id &#125;)</span><br><span class="line">      return &#123; success: true &#125;</span><br><span class="line">    &#125; catch (error) &#123;</span><br><span class="line">      state.error = error.message</span><br><span class="line">      console.error(`更新$&#123;storeName&#125;数据失败:`, error)</span><br><span class="line">      return &#123; success: false, error: error.message &#125;</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">      state.loading = false</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  const remove = async (id) =&gt; &#123;</span><br><span class="line">    state.loading = true</span><br><span class="line"></span><br><span class="line">    try &#123;</span><br><span class="line">      const db = await getDB()</span><br><span class="line">      await db.delete(storeName, id)</span><br><span class="line">      return &#123; success: true &#125;</span><br><span class="line">    &#125; catch (error) &#123;</span><br><span class="line">      state.error = error.message</span><br><span class="line">      console.error(`删除$&#123;storeName&#125;数据失败:`, error)</span><br><span class="line">      return &#123; success: false, error: error.message &#125;</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">      state.loading = false</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  const clear = async () =&gt; &#123;</span><br><span class="line">    state.loading = true</span><br><span class="line"></span><br><span class="line">    try &#123;</span><br><span class="line">      const db = await getDB()</span><br><span class="line">      await db.clear(storeName)</span><br><span class="line">      state.data = null</span><br><span class="line">      state.pagination.totalCount = 0</span><br><span class="line">      state.pagination.totalPages = 0</span><br><span class="line">      return &#123; success: true &#125;</span><br><span class="line">    &#125; catch (error) &#123;</span><br><span class="line">      state.error = error.message</span><br><span class="line">      console.error(`清空$&#123;storeName&#125;数据失败:`, error)</span><br><span class="line">      return &#123; success: false, error: error.message &#125;</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">      state.loading = false</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  return &#123;</span><br><span class="line">    ...toRefs(state),</span><br><span class="line">    getById,</span><br><span class="line">    getAll,</span><br><span class="line">    getByPage,</span><br><span class="line">    create,</span><br><span class="line">    update,</span><br><span class="line">    remove,</span><br><span class="line">    clear,</span><br><span class="line">    resetState</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="在-Vue-组件中使用">在 Vue 组件中使用</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- src/components/UserManagement.vue --&gt;</span><br><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div class=&quot;user-management&quot;&gt;</span><br><span class="line">    &lt;div class=&quot;header&quot;&gt;</span><br><span class="line">      &lt;h2&gt;用户管理&lt;/h2&gt;</span><br><span class="line">      &lt;button @click=&quot;showCreateModal = true&quot; class=&quot;btn btn-primary&quot;&gt;</span><br><span class="line">        添加用户</span><br><span class="line">      &lt;/button&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!-- 搜索和筛选 --&gt;</span><br><span class="line">    &lt;div class=&quot;filters&quot;&gt;</span><br><span class="line">      &lt;input</span><br><span class="line">        v-model=&quot;searchName&quot;</span><br><span class="line">        placeholder=&quot;搜索用户名...&quot;</span><br><span class="line">        @input=&quot;handleSearch&quot;</span><br><span class="line">        class=&quot;search-input&quot;</span><br><span class="line">      /&gt;</span><br><span class="line">      &lt;select v-model=&quot;filterLevel&quot; @change=&quot;handleSearch&quot; class=&quot;filter-select&quot;&gt;</span><br><span class="line">        &lt;option value=&quot;&quot;&gt;所有等级&lt;/option&gt;</span><br><span class="line">        &lt;option value=&quot;1&quot;&gt;等级1&lt;/option&gt;</span><br><span class="line">        &lt;option value=&quot;2&quot;&gt;等级2&lt;/option&gt;</span><br><span class="line">        &lt;option value=&quot;3&quot;&gt;等级3&lt;/option&gt;</span><br><span class="line">      &lt;/select&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!-- 加载状态 --&gt;</span><br><span class="line">    &lt;div v-if=&quot;loading&quot; class=&quot;loading&quot;&gt;</span><br><span class="line">      &lt;span&gt;加载中...&lt;/span&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!-- 错误提示 --&gt;</span><br><span class="line">    &lt;div v-else-if=&quot;error&quot; class=&quot;error&quot;&gt;</span><br><span class="line">      &lt;span&gt;错误: &#123;&#123; error &#125;&#125;&lt;/span&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!-- 用户列表 --&gt;</span><br><span class="line">    &lt;div v-else class=&quot;user-list&quot;&gt;</span><br><span class="line">      &lt;table class=&quot;user-table&quot;&gt;</span><br><span class="line">        &lt;thead&gt;</span><br><span class="line">          &lt;tr&gt;</span><br><span class="line">            &lt;th&gt;ID&lt;/th&gt;</span><br><span class="line">            &lt;th&gt;用户名&lt;/th&gt;</span><br><span class="line">            &lt;th&gt;邮箱&lt;/th&gt;</span><br><span class="line">            &lt;th&gt;年龄&lt;/th&gt;</span><br><span class="line">            &lt;th&gt;等级&lt;/th&gt;</span><br><span class="line">            &lt;th&gt;积分&lt;/th&gt;</span><br><span class="line">            &lt;th&gt;操作&lt;/th&gt;</span><br><span class="line">          &lt;/tr&gt;</span><br><span class="line">        &lt;/thead&gt;</span><br><span class="line">        &lt;tbody&gt;</span><br><span class="line">          &lt;tr v-for=&quot;user in data&quot; :key=&quot;user.id&quot;&gt;</span><br><span class="line">            &lt;td&gt;&#123;&#123; user.id &#125;&#125;&lt;/td&gt;</span><br><span class="line">            &lt;td&gt;&#123;&#123; user.name &#125;&#125;&lt;/td&gt;</span><br><span class="line">            &lt;td&gt;&#123;&#123; user.email &#125;&#125;&lt;/td&gt;</span><br><span class="line">            &lt;td&gt;&#123;&#123; user.age &#125;&#125;&lt;/td&gt;</span><br><span class="line">            &lt;td&gt;等级&#123;&#123; user.level &#125;&#125;&lt;/td&gt;</span><br><span class="line">            &lt;td&gt;&#123;&#123; user.points &#125;&#125;&lt;/td&gt;</span><br><span class="line">            &lt;td class=&quot;actions&quot;&gt;</span><br><span class="line">              &lt;button @click=&quot;handleEdit(user)&quot; class=&quot;btn btn-edit&quot;&gt;编辑&lt;/button&gt;</span><br><span class="line">              &lt;button @click=&quot;handleDelete(user.id)&quot; class=&quot;btn btn-delete&quot;&gt;删除&lt;/button&gt;</span><br><span class="line">            &lt;/td&gt;</span><br><span class="line">          &lt;/tr&gt;</span><br><span class="line">        &lt;/tbody&gt;</span><br><span class="line">      &lt;/table&gt;</span><br><span class="line"></span><br><span class="line">      &lt;!-- 分页 --&gt;</span><br><span class="line">      &lt;div class=&quot;pagination&quot; v-if=&quot;pagination.totalPages &gt; 1&quot;&gt;</span><br><span class="line">        &lt;button</span><br><span class="line">          @click=&quot;handlePageChange(pagination.page - 1)&quot;</span><br><span class="line">          :disabled=&quot;pagination.page === 1&quot;</span><br><span class="line">          class=&quot;page-btn&quot;</span><br><span class="line">        &gt;</span><br><span class="line">          上一页</span><br><span class="line">        &lt;/button&gt;</span><br><span class="line">        &lt;span class=&quot;page-info&quot;&gt;</span><br><span class="line">          第 &#123;&#123; pagination.page &#125;&#125; 页 / 共 &#123;&#123; pagination.totalPages &#125;&#125; 页</span><br><span class="line">        &lt;/span&gt;</span><br><span class="line">        &lt;button</span><br><span class="line">          @click=&quot;handlePageChange(pagination.page + 1)&quot;</span><br><span class="line">          :disabled=&quot;pagination.page === pagination.totalPages&quot;</span><br><span class="line">          class=&quot;page-btn&quot;</span><br><span class="line">        &gt;</span><br><span class="line">          下一页</span><br><span class="line">        &lt;/button&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!-- 创建/编辑用户模态框 --&gt;</span><br><span class="line">    &lt;div v-if=&quot;showCreateModal || showEditModal&quot; class=&quot;modal-overlay&quot;&gt;</span><br><span class="line">      &lt;div class=&quot;modal&quot;&gt;</span><br><span class="line">        &lt;div class=&quot;modal-header&quot;&gt;</span><br><span class="line">          &lt;h3&gt;&#123;&#123; showEditModal ? &#x27;编辑用户&#x27; : &#x27;创建用户&#x27; &#125;&#125;&lt;/h3&gt;</span><br><span class="line">          &lt;button @click=&quot;closeModal&quot; class=&quot;close-btn&quot;&gt;&amp;times;&lt;/button&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">        &lt;div class=&quot;modal-body&quot;&gt;</span><br><span class="line">          &lt;form @submit.prevent=&quot;handleSubmit&quot;&gt;</span><br><span class="line">            &lt;div class=&quot;form-group&quot;&gt;</span><br><span class="line">              &lt;label&gt;用户名:&lt;/label&gt;</span><br><span class="line">              &lt;input</span><br><span class="line">                v-model=&quot;form.name&quot;</span><br><span class="line">                required</span><br><span class="line">                class=&quot;form-control&quot;</span><br><span class="line">              /&gt;</span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">            &lt;div class=&quot;form-group&quot;&gt;</span><br><span class="line">              &lt;label&gt;邮箱:&lt;/label&gt;</span><br><span class="line">              &lt;input</span><br><span class="line">                v-model=&quot;form.email&quot;</span><br><span class="line">                type=&quot;email&quot;</span><br><span class="line">                required</span><br><span class="line">                class=&quot;form-control&quot;</span><br><span class="line">              /&gt;</span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">            &lt;div class=&quot;form-group&quot;&gt;</span><br><span class="line">              &lt;label&gt;年龄:&lt;/label&gt;</span><br><span class="line">              &lt;input</span><br><span class="line">                v-model.number=&quot;form.age&quot;</span><br><span class="line">                type=&quot;number&quot;</span><br><span class="line">                min=&quot;1&quot;</span><br><span class="line">                max=&quot;150&quot;</span><br><span class="line">                required</span><br><span class="line">                class=&quot;form-control&quot;</span><br><span class="line">              /&gt;</span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">            &lt;div class=&quot;form-group&quot;&gt;</span><br><span class="line">              &lt;label&gt;等级:&lt;/label&gt;</span><br><span class="line">              &lt;select v-model.number=&quot;form.level&quot; class=&quot;form-control&quot;&gt;</span><br><span class="line">                &lt;option value=&quot;1&quot;&gt;等级1&lt;/option&gt;</span><br><span class="line">                &lt;option value=&quot;2&quot;&gt;等级2&lt;/option&gt;</span><br><span class="line">                &lt;option value=&quot;3&quot;&gt;等级3&lt;/option&gt;</span><br><span class="line">              &lt;/select&gt;</span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">            &lt;div class=&quot;form-group&quot;&gt;</span><br><span class="line">              &lt;label&gt;积分:&lt;/label&gt;</span><br><span class="line">              &lt;input</span><br><span class="line">                v-model.number=&quot;form.points&quot;</span><br><span class="line">                type=&quot;number&quot;</span><br><span class="line">                min=&quot;0&quot;</span><br><span class="line">                class=&quot;form-control&quot;</span><br><span class="line">              /&gt;</span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">            &lt;div class=&quot;form-actions&quot;&gt;</span><br><span class="line">              &lt;button type=&quot;submit&quot; class=&quot;btn btn-primary&quot;&gt;</span><br><span class="line">                &#123;&#123; showEditModal ? &#x27;更新&#x27; : &#x27;创建&#x27; &#125;&#125;</span><br><span class="line">              &lt;/button&gt;</span><br><span class="line">              &lt;button type=&quot;button&quot; @click=&quot;closeModal&quot; class=&quot;btn btn-secondary&quot;&gt;</span><br><span class="line">                取消</span><br><span class="line">              &lt;/button&gt;</span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">          &lt;/form&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script setup&gt;</span><br><span class="line">import &#123; ref, reactive &#125; from &#x27;vue&#x27;</span><br><span class="line">import &#123; useIndexedDB &#125; from &#x27;@/composables/useIndexedDB&#x27;</span><br><span class="line">import &#123; searchUsers &#125; from &#x27;@/api/user&#x27;</span><br><span class="line"></span><br><span class="line">// 使用IndexedDB composable</span><br><span class="line">const &#123;</span><br><span class="line">  data,</span><br><span class="line">  loading,</span><br><span class="line">  error,</span><br><span class="line">  pagination,</span><br><span class="line">  getByPage,</span><br><span class="line">  create,</span><br><span class="line">  update,</span><br><span class="line">  remove</span><br><span class="line">&#125; = useIndexedDB(&#x27;users&#x27;)</span><br><span class="line"></span><br><span class="line">// 组件状态</span><br><span class="line">const showCreateModal = ref(false)</span><br><span class="line">const showEditModal = ref(false)</span><br><span class="line">const searchName = ref(&#x27;&#x27;)</span><br><span class="line">const filterLevel = ref(&#x27;&#x27;)</span><br><span class="line">const currentEditId = ref(null)</span><br><span class="line"></span><br><span class="line">// 表单数据</span><br><span class="line">const form = reactive(&#123;</span><br><span class="line">  name: &#x27;&#x27;,</span><br><span class="line">  email: &#x27;&#x27;,</span><br><span class="line">  age: 18,</span><br><span class="line">  level: 1,</span><br><span class="line">  points: 0,</span><br><span class="line">  createdAt: new Date().toISOString(),</span><br><span class="line">  updatedAt: new Date().toISOString()</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">// 初始化</span><br><span class="line">const init = async () =&gt; &#123;</span><br><span class="line">  await getByPage(1, 20)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 搜索处理</span><br><span class="line">const handleSearch = async () =&gt; &#123;</span><br><span class="line">  const filters = &#123;&#125;</span><br><span class="line">  if (searchName.value) &#123;</span><br><span class="line">    filters.name = searchName.value</span><br><span class="line">  &#125;</span><br><span class="line">  if (filterLevel.value) &#123;</span><br><span class="line">    filters.level = parseInt(filterLevel.value)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  const result = await searchUsers(filters)</span><br><span class="line">  if (result.success) &#123;</span><br><span class="line">    data.value = result.data</span><br><span class="line">    pagination.value.totalCount = result.data.length</span><br><span class="line">    pagination.value.totalPages = 1</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 分页处理</span><br><span class="line">const handlePageChange = async (newPage) =&gt; &#123;</span><br><span class="line">  await getByPage(newPage, pagination.value.pageSize)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 编辑用户</span><br><span class="line">const handleEdit = async (user) =&gt; &#123;</span><br><span class="line">  currentEditId.value = user.id</span><br><span class="line">  form.name = user.name</span><br><span class="line">  form.email = user.email</span><br><span class="line">  form.age = user.age</span><br><span class="line">  form.level = user.level</span><br><span class="line">  form.points = user.points</span><br><span class="line">  showEditModal.value = true</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 删除用户</span><br><span class="line">const handleDelete = async (userId) =&gt; &#123;</span><br><span class="line">  if (confirm(&#x27;确定要删除这个用户吗？&#x27;)) &#123;</span><br><span class="line">    const result = await remove(userId)</span><br><span class="line">    if (result.success) &#123;</span><br><span class="line">      await init() // 重新加载数据</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 表单提交</span><br><span class="line">const handleSubmit = async () =&gt; &#123;</span><br><span class="line">  form.updatedAt = new Date().toISOString()</span><br><span class="line"></span><br><span class="line">  if (showEditModal.value) &#123;</span><br><span class="line">    // 更新用户</span><br><span class="line">    const result = await update(currentEditId.value, form)</span><br><span class="line">    if (result.success) &#123;</span><br><span class="line">      closeModal()</span><br><span class="line">      await init()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    // 创建用户</span><br><span class="line">    const result = await create(form)</span><br><span class="line">    if (result.success) &#123;</span><br><span class="line">      closeModal()</span><br><span class="line">      await init()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 关闭模态框</span><br><span class="line">const closeModal = () =&gt; &#123;</span><br><span class="line">  showCreateModal.value = false</span><br><span class="line">  showEditModal.value = false</span><br><span class="line">  currentEditId.value = null</span><br><span class="line">  // 重置表单</span><br><span class="line">  form.name = &#x27;&#x27;</span><br><span class="line">  form.email = &#x27;&#x27;</span><br><span class="line">  form.age = 18</span><br><span class="line">  form.level = 1</span><br><span class="line">  form.points = 0</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 页面加载时初始化</span><br><span class="line">init()</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;style scoped&gt;</span><br><span class="line">/* 组件样式 */</span><br><span class="line">.user-management &#123;</span><br><span class="line">  max-width: 1200px;</span><br><span class="line">  margin: 0 auto;</span><br><span class="line">  padding: 20px;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.header &#123;</span><br><span class="line">  display: flex;</span><br><span class="line">  justify-content: space-between;</span><br><span class="line">  align-items: center;</span><br><span class="line">  margin-bottom: 20px;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.filters &#123;</span><br><span class="line">  display: flex;</span><br><span class="line">  gap: 10px;</span><br><span class="line">  margin-bottom: 20px;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.search-input, .filter-select &#123;</span><br><span class="line">  padding: 8px 12px;</span><br><span class="line">  border: 1px solid #ddd;</span><br><span class="line">  border-radius: 4px;</span><br><span class="line">  flex: 1;</span><br><span class="line">  max-width: 300px;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.loading, .error &#123;</span><br><span class="line">  text-align: center;</span><br><span class="line">  padding: 20px;</span><br><span class="line">  color: #666;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.error &#123;</span><br><span class="line">  color: #dc3545;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.user-table &#123;</span><br><span class="line">  width: 100%;</span><br><span class="line">  border-collapse: collapse;</span><br><span class="line">  margin-bottom: 20px;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.user-table th, .user-table td &#123;</span><br><span class="line">  padding: 12px 15px;</span><br><span class="line">  text-align: left;</span><br><span class="line">  border-bottom: 1px solid #ddd;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.user-table th &#123;</span><br><span class="line">  background-color: #f8f9fa;</span><br><span class="line">  font-weight: bold;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.actions &#123;</span><br><span class="line">  display: flex;</span><br><span class="line">  gap: 5px;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.btn &#123;</span><br><span class="line">  padding: 6px 12px;</span><br><span class="line">  border: none;</span><br><span class="line">  border-radius: 4px;</span><br><span class="line">  cursor: pointer;</span><br><span class="line">  font-size: 14px;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.btn-primary &#123;</span><br><span class="line">  background-color: #007bff;</span><br><span class="line">  color: white;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.btn-edit &#123;</span><br><span class="line">  background-color: #28a745;</span><br><span class="line">  color: white;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.btn-delete &#123;</span><br><span class="line">  background-color: #dc3545;</span><br><span class="line">  color: white;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.pagination &#123;</span><br><span class="line">  display: flex;</span><br><span class="line">  justify-content: center;</span><br><span class="line">  align-items: center;</span><br><span class="line">  gap: 10px;</span><br><span class="line">  margin-top: 20px;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.page-btn &#123;</span><br><span class="line">  padding: 6px 12px;</span><br><span class="line">  border: 1px solid #ddd;</span><br><span class="line">  background-color: white;</span><br><span class="line">  cursor: pointer;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.page-btn:disabled &#123;</span><br><span class="line">  cursor: not-allowed;</span><br><span class="line">  opacity: 0.5;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.modal-overlay &#123;</span><br><span class="line">  position: fixed;</span><br><span class="line">  top: 0;</span><br><span class="line">  left: 0;</span><br><span class="line">  right: 0;</span><br><span class="line">  bottom: 0;</span><br><span class="line">  background-color: rgba(0, 0, 0, 0.5);</span><br><span class="line">  display: flex;</span><br><span class="line">  justify-content: center;</span><br><span class="line">  align-items: center;</span><br><span class="line">  z-index: 1000;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.modal &#123;</span><br><span class="line">  background-color: white;</span><br><span class="line">  border-radius: 4px;</span><br><span class="line">  width: 90%;</span><br><span class="line">  max-width: 500px;</span><br><span class="line">  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.modal-header &#123;</span><br><span class="line">  display: flex;</span><br><span class="line">  justify-content: space-between;</span><br><span class="line">  align-items: center;</span><br><span class="line">  padding: 15px;</span><br><span class="line">  border-bottom: 1px solid #ddd;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.close-btn &#123;</span><br><span class="line">  background: none;</span><br><span class="line">  border: none;</span><br><span class="line">  font-size: 20px;</span><br><span class="line">  cursor: pointer;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.modal-body &#123;</span><br><span class="line">  padding: 15px;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.form-group &#123;</span><br><span class="line">  margin-bottom: 15px;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.form-control &#123;</span><br><span class="line">  width: 100%;</span><br><span class="line">  padding: 8px 12px;</span><br><span class="line">  border: 1px solid #ddd;</span><br><span class="line">  border-radius: 4px;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.form-actions &#123;</span><br><span class="line">  display: flex;</span><br><span class="line">  gap: 10px;</span><br><span class="line">  margin-top: 20px;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure>
<h3 id="Vuex-Pinia-集成">Vuex/Pinia 集成</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br></pre></td><td class="code"><pre><span class="line">// src/store/indexedDB.js (Pinia store)</span><br><span class="line">import &#123; defineStore &#125; from &#x27;pinia&#x27;</span><br><span class="line">import &#123; getDB &#125; from &#x27;@/utils/indexedDB&#x27;</span><br><span class="line"></span><br><span class="line">export const useIndexedDBStore = defineStore(&#x27;indexedDB&#x27;, &#123;</span><br><span class="line">  state: () =&gt; (&#123;</span><br><span class="line">    stores: &#123;&#125;,</span><br><span class="line">    loading: false,</span><br><span class="line">    error: null</span><br><span class="line">  &#125;),</span><br><span class="line"></span><br><span class="line">  actions: &#123;</span><br><span class="line">    async initStore(storeName) &#123;</span><br><span class="line">      if (!this.stores[storeName]) &#123;</span><br><span class="line">        this.stores[storeName] = &#123;</span><br><span class="line">          data: [],</span><br><span class="line">          pagination: &#123;</span><br><span class="line">            page: 1,</span><br><span class="line">            pageSize: 20,</span><br><span class="line">            totalCount: 0,</span><br><span class="line">            totalPages: 0</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    async getById(storeName, id) &#123;</span><br><span class="line">      this.loading = true</span><br><span class="line">      this.error = null</span><br><span class="line"></span><br><span class="line">      try &#123;</span><br><span class="line">        await this.initStore(storeName)</span><br><span class="line">        const db = await getDB()</span><br><span class="line">        const data = await db.get(storeName, id)</span><br><span class="line">        </span><br><span class="line">        this.stores[storeName].data = data ? [data] : []</span><br><span class="line">        return &#123; success: true, data &#125;</span><br><span class="line">      &#125; catch (error) &#123;</span><br><span class="line">        this.error = error.message</span><br><span class="line">        console.error(`获取$&#123;storeName&#125;数据失败:`, error)</span><br><span class="line">        return &#123; success: false, error: error.message &#125;</span><br><span class="line">      &#125; finally &#123;</span><br><span class="line">        this.loading = false</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    async getAll(storeName) &#123;</span><br><span class="line">      this.loading = true</span><br><span class="line">      this.error = null</span><br><span class="line"></span><br><span class="line">      try &#123;</span><br><span class="line">        await this.initStore(storeName)</span><br><span class="line">        const db = await getDB()</span><br><span class="line">        const data = await db.getAll(storeName)</span><br><span class="line">        </span><br><span class="line">        this.stores[storeName].data = data</span><br><span class="line">        this.stores[storeName].pagination.totalCount = data.length</span><br><span class="line">        this.stores[storeName].pagination.totalPages = 1</span><br><span class="line">        </span><br><span class="line">        return &#123; success: true, data &#125;</span><br><span class="line">      &#125; catch (error) &#123;</span><br><span class="line">        this.error = error.message</span><br><span class="line">        console.error(`获取所有$&#123;storeName&#125;数据失败:`, error)</span><br><span class="line">        return &#123; success: false, error: error.message &#125;</span><br><span class="line">      &#125; finally &#123;</span><br><span class="line">        this.loading = false</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    async create(storeName, item) &#123;</span><br><span class="line">      this.loading = true</span><br><span class="line">      this.error = null</span><br><span class="line"></span><br><span class="line">      try &#123;</span><br><span class="line">        const db = await getDB()</span><br><span class="line">        const id = await db.add(storeName, item)</span><br><span class="line">        </span><br><span class="line">        // 重新加载数据</span><br><span class="line">        await this.getAll(storeName)</span><br><span class="line">        </span><br><span class="line">        return &#123; success: true, id &#125;</span><br><span class="line">      &#125; catch (error) &#123;</span><br><span class="line">        this.error = error.message</span><br><span class="line">        console.error(`创建$&#123;storeName&#125;数据失败:`, error)</span><br><span class="line">        return &#123; success: false, error: error.message &#125;</span><br><span class="line">      &#125; finally &#123;</span><br><span class="line">        this.loading = false</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    async update(storeName, id, item) &#123;</span><br><span class="line">      this.loading = true</span><br><span class="line">      this.error = null</span><br><span class="line"></span><br><span class="line">      try &#123;</span><br><span class="line">        const db = await getDB()</span><br><span class="line">        await db.put(storeName, &#123; ...item, id &#125;)</span><br><span class="line">        </span><br><span class="line">        // 重新加载数据</span><br><span class="line">        await this.getAll(storeName)</span><br><span class="line">        </span><br><span class="line">        return &#123; success: true &#125;</span><br><span class="line">      &#125; catch (error) &#123;</span><br><span class="line">        this.error = error.message</span><br><span class="line">        console.error(`更新$&#123;storeName&#125;数据失败:`, error)</span><br><span class="line">        return &#123; success: false, error: error.message &#125;</span><br><span class="line">      &#125; finally &#123;</span><br><span class="line">        this.loading = false</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    async remove(storeName, id) &#123;</span><br><span class="line">      this.loading = true</span><br><span class="line">      this.error = null</span><br><span class="line"></span><br><span class="line">      try &#123;</span><br><span class="line">        const db = await getDB()</span><br><span class="line">        await db.delete(storeName, id)</span><br><span class="line">        </span><br><span class="line">        // 重新加载数据</span><br><span class="line">        await this.getAll(storeName)</span><br><span class="line">        </span><br><span class="line">        return &#123; success: true &#125;</span><br><span class="line">      &#125; catch (error) &#123;</span><br><span class="line">        this.error = error.message</span><br><span class="line">        console.error(`删除$&#123;storeName&#125;数据失败:`, error)</span><br><span class="line">        return &#123; success: false, error: error.message &#125;</span><br><span class="line">      &#125; finally &#123;</span><br><span class="line">        this.loading = false</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  getters: &#123;</span><br><span class="line">    getStoreData: (state) =&gt; (storeName) =&gt; &#123;</span><br><span class="line">      return state.stores[storeName]?.data || []</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    getStorePagination: (state) =&gt; (storeName) =&gt; &#123;</span><br><span class="line">      return state.stores[storeName]?.pagination || &#123;</span><br><span class="line">        page: 1,</span><br><span class="line">        pageSize: 20,</span><br><span class="line">        totalCount: 0,</span><br><span class="line">        totalPages: 0</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h2 id="常见问题与解决方案">常见问题与解决方案</h2>
<h3 id="1-数据库连接问题">1. 数据库连接问题</h3>
<p><strong>问题</strong>：数据库连接被阻塞或无法打开</p>
<p><strong>解决方案</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">// 改进的连接管理</span><br><span class="line">let dbInstance = null</span><br><span class="line">let dbOpening = false</span><br><span class="line">let dbQueue = []</span><br><span class="line"></span><br><span class="line">export const getDB = async () =&gt; &#123;</span><br><span class="line">  if (dbInstance) &#123;</span><br><span class="line">    return dbInstance</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // 如果正在打开连接，加入队列等待</span><br><span class="line">  if (dbOpening) &#123;</span><br><span class="line">    return new Promise((resolve) =&gt; &#123;</span><br><span class="line">      dbQueue.push(resolve)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  dbOpening = true</span><br><span class="line"></span><br><span class="line">  try &#123;</span><br><span class="line">    dbInstance = await initDB()</span><br><span class="line">    </span><br><span class="line">    // 通知所有等待的连接</span><br><span class="line">    while (dbQueue.length &gt; 0) &#123;</span><br><span class="line">      dbQueue.shift()(dbInstance)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    return dbInstance</span><br><span class="line">  &#125; catch (error) &#123;</span><br><span class="line">    console.error(&#x27;数据库连接失败:&#x27;, error)</span><br><span class="line">    </span><br><span class="line">    // 清空队列并返回错误</span><br><span class="line">    while (dbQueue.length &gt; 0) &#123;</span><br><span class="line">      dbQueue.shift()(null)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    throw error</span><br><span class="line">  &#125; finally &#123;</span><br><span class="line">    dbOpening = false</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 连接健康检查</span><br><span class="line">export const checkDBHealth = async () =&gt; &#123;</span><br><span class="line">  try &#123;</span><br><span class="line">    const db = await getDB()</span><br><span class="line">    </span><br><span class="line">    // 尝试执行一个简单的操作来检查连接状态</span><br><span class="line">    const tx = db.transaction(db.objectStoreNames[0] || &#x27;settings&#x27;, &#x27;readonly&#x27;)</span><br><span class="line">    await tx.done</span><br><span class="line">    </span><br><span class="line">    return true</span><br><span class="line">  &#125; catch (error) &#123;</span><br><span class="line">    console.error(&#x27;数据库连接不健康，尝试重新连接:&#x27;, error)</span><br><span class="line">    </span><br><span class="line">    // 重置连接实例</span><br><span class="line">    dbInstance = null</span><br><span class="line">    </span><br><span class="line">    // 尝试重新连接</span><br><span class="line">    try &#123;</span><br><span class="line">      dbInstance = await initDB()</span><br><span class="line">      return true</span><br><span class="line">    &#125; catch (reconnectError) &#123;</span><br><span class="line">      console.error(&#x27;重新连接数据库失败:&#x27;, reconnectError)</span><br><span class="line">      return false</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="2-数据迁移问题">2. 数据迁移问题</h3>
<p><strong>问题</strong>：版本升级时数据迁移失败</p>
<p><strong>解决方案</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line">// 安全的数据迁移工具</span><br><span class="line">export const safeMigrate = async (migrationSteps) =&gt; &#123;</span><br><span class="line">  const currentVersion = await getCurrentDBVersion()</span><br><span class="line">  const targetVersion = Math.max(...Object.keys(migrationSteps).map(v =&gt; parseInt(v)))</span><br><span class="line"></span><br><span class="line">  if (currentVersion &gt;= targetVersion) &#123;</span><br><span class="line">    return &#123; success: true, message: &#x27;无需迁移&#x27; &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  try &#123;</span><br><span class="line">    // 备份当前数据</span><br><span class="line">    await backupDatabase()</span><br><span class="line"></span><br><span class="line">    // 执行迁移步骤</span><br><span class="line">    for (let version = currentVersion + 1; version &lt;= targetVersion; version++) &#123;</span><br><span class="line">      if (migrationSteps[version]) &#123;</span><br><span class="line">        console.log(`执行迁移步骤: $&#123;version&#125;`)</span><br><span class="line">        await migrationSteps[version]()</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return &#123; success: true, message: &#x27;迁移完成&#x27; &#125;</span><br><span class="line">  &#125; catch (error) &#123;</span><br><span class="line">    console.error(&#x27;迁移失败，尝试回滚:&#x27;, error)</span><br><span class="line">    </span><br><span class="line">    // 尝试回滚到备份</span><br><span class="line">    await restoreDatabase()</span><br><span class="line">    </span><br><span class="line">    return &#123; success: false, error: error.message &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 数据库备份</span><br><span class="line">export const backupDatabase = async () =&gt; &#123;</span><br><span class="line">  const db = await getDB()</span><br><span class="line">  const backup = &#123;&#125;</span><br><span class="line"></span><br><span class="line">  // 备份所有对象仓库的数据</span><br><span class="line">  for (const storeName of db.objectStoreNames) &#123;</span><br><span class="line">    const tx = db.transaction(storeName, &#x27;readonly&#x27;)</span><br><span class="line">    const store = tx.objectStore(storeName)</span><br><span class="line">    backup[storeName] = await store.getAll()</span><br><span class="line">    await tx.done</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // 保存备份到localStorage或服务器</span><br><span class="line">  localStorage.setItem(&#x27;db_backup&#x27;, JSON.stringify(&#123;</span><br><span class="line">    timestamp: new Date().toISOString(),</span><br><span class="line">    version: db.version,</span><br><span class="line">    data: backup</span><br><span class="line">  &#125;))</span><br><span class="line"></span><br><span class="line">  return backup</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 数据库恢复</span><br><span class="line">export const restoreDatabase = async () =&gt; &#123;</span><br><span class="line">  const backupData = localStorage.getItem(&#x27;db_backup&#x27;)</span><br><span class="line">  </span><br><span class="line">  if (!backupData) &#123;</span><br><span class="line">    throw new Error(&#x27;没有找到备份数据&#x27;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  const &#123; data, version &#125; = JSON.parse(backupData)</span><br><span class="line">  const db = await openDB(DB_NAME, version, &#123;</span><br><span class="line">    upgrade(db) &#123;</span><br><span class="line">      // 重建对象仓库结构</span><br><span class="line">      for (const storeName in data) &#123;</span><br><span class="line">        if (!db.objectStoreNames.contains(storeName)) &#123;</span><br><span class="line">          db.createObjectStore(storeName)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  // 恢复数据</span><br><span class="line">  for (const storeName in data) &#123;</span><br><span class="line">    const tx = db.transaction(storeName, &#x27;readwrite&#x27;)</span><br><span class="line">    const store = tx.objectStore(storeName)</span><br><span class="line">    </span><br><span class="line">    // 清空现有数据</span><br><span class="line">    await store.clear()</span><br><span class="line">    </span><br><span class="line">    // 恢复备份数据</span><br><span class="line">    for (const item of data[storeName]) &#123;</span><br><span class="line">      await store.put(item)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    await tx.done</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  return true</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="3-性能问题">3. 性能问题</h3>
<p><strong>问题</strong>：大量数据操作时性能低下</p>
<p><strong>解决方案</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line">// 批量操作优化</span><br><span class="line">export const batchOperations = async (storeName, operations) =&gt; &#123;</span><br><span class="line">  const db = await getDB()</span><br><span class="line">  </span><br><span class="line">  try &#123;</span><br><span class="line">    const tx = db.transaction(storeName, &#x27;readwrite&#x27;)</span><br><span class="line">    const store = tx.objectStore(storeName)</span><br><span class="line">    </span><br><span class="line">    const results = []</span><br><span class="line">    </span><br><span class="line">    for (const op of operations) &#123;</span><br><span class="line">      let result</span><br><span class="line">      </span><br><span class="line">      switch (op.type) &#123;</span><br><span class="line">        case &#x27;add&#x27;:</span><br><span class="line">          result = await store.add(op.data)</span><br><span class="line">          break</span><br><span class="line">        case &#x27;put&#x27;:</span><br><span class="line">          result = await store.put(op.data)</span><br><span class="line">          break</span><br><span class="line">        case &#x27;delete&#x27;:</span><br><span class="line">          result = await store.delete(op.key)</span><br><span class="line">          break</span><br><span class="line">        default:</span><br><span class="line">          throw new Error(`不支持的操作类型: $&#123;op.type&#125;`)</span><br><span class="line">      &#125;</span><br><span class="line">      </span><br><span class="line">      results.push(&#123;</span><br><span class="line">        operation: op,</span><br><span class="line">        result,</span><br><span class="line">        success: true</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    await tx.done</span><br><span class="line">    return &#123; success: true, results &#125;</span><br><span class="line">  &#125; catch (error) &#123;</span><br><span class="line">    console.error(&#x27;批量操作失败:&#x27;, error)</span><br><span class="line">    return &#123; success: false, error: error.message &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 大数据集分页查询优化</span><br><span class="line">export const optimizedPagination = async (storeName, page = 1, pageSize = 20, indexName = null, keyRange = null) =&gt; &#123;</span><br><span class="line">  const db = await getDB()</span><br><span class="line">  </span><br><span class="line">  try &#123;</span><br><span class="line">    const tx = db.transaction(storeName, &#x27;readonly&#x27;)</span><br><span class="line">    const store = tx.objectStore(storeName)</span><br><span class="line">    </span><br><span class="line">    let index = store</span><br><span class="line">    if (indexName &amp;&amp; store.indexNames.contains(indexName)) &#123;</span><br><span class="line">      index = store.index(indexName)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // 获取总数（优化：如果有范围查询，先获取范围内的总数）</span><br><span class="line">    const totalCount = keyRange </span><br><span class="line">      ? await index.count(keyRange)</span><br><span class="line">      : await store.count()</span><br><span class="line">    </span><br><span class="line">    const totalPages = Math.ceil(totalCount / pageSize)</span><br><span class="line">    const skip = (page - 1) * pageSize</span><br><span class="line">    </span><br><span class="line">    const data = []</span><br><span class="line">    </span><br><span class="line">    // 使用游标进行高效分页</span><br><span class="line">    await new Promise((resolve, reject) =&gt; &#123;</span><br><span class="line">      let count = 0</span><br><span class="line">      const cursorRequest = keyRange </span><br><span class="line">        ? index.openCursor(keyRange)</span><br><span class="line">        : index.openCursor()</span><br><span class="line">      </span><br><span class="line">      cursorRequest.onsuccess = (event) =&gt; &#123;</span><br><span class="line">        const cursor = event.target.result</span><br><span class="line">        if (cursor) &#123;</span><br><span class="line">          if (count &gt;= skip &amp;&amp; count &lt; skip + pageSize) &#123;</span><br><span class="line">            data.push(cursor.value)</span><br><span class="line">          &#125;</span><br><span class="line">          </span><br><span class="line">          count++</span><br><span class="line">          </span><br><span class="line">          if (count &lt; skip + pageSize) &#123;</span><br><span class="line">            cursor.continue()</span><br><span class="line">          &#125; else &#123;</span><br><span class="line">            resolve()</span><br><span class="line">          &#125;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">          resolve()</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      </span><br><span class="line">      cursorRequest.onerror = (event) =&gt; &#123;</span><br><span class="line">        reject(event.target.error)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    </span><br><span class="line">    await tx.done</span><br><span class="line">    </span><br><span class="line">    return &#123;</span><br><span class="line">      success: true,</span><br><span class="line">      data,</span><br><span class="line">      pagination: &#123;</span><br><span class="line">        page,</span><br><span class="line">        pageSize,</span><br><span class="line">        totalCount,</span><br><span class="line">        totalPages</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; catch (error) &#123;</span><br><span class="line">    console.error(&#x27;优化分页查询失败:&#x27;, error)</span><br><span class="line">    return &#123; success: false, error: error.message &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="4-浏览器兼容性问题">4. 浏览器兼容性问题</h3>
<p><strong>问题</strong>：某些浏览器不支持 IndexedDB 或 idb 库</p>
<p><strong>解决方案</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line">// 兼容性检测和降级方案</span><br><span class="line">export const checkCompatibility = () =&gt; &#123;</span><br><span class="line">  try &#123;</span><br><span class="line">    // 检测IndexedDB支持</span><br><span class="line">    if (!window.indexedDB) &#123;</span><br><span class="line">      return &#123;</span><br><span class="line">        supported: false,</span><br><span class="line">        message: &#x27;您的浏览器不支持IndexedDB，请升级到现代浏览器&#x27;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 检测Promise支持（idb需要Promise）</span><br><span class="line">    if (!window.Promise) &#123;</span><br><span class="line">      return &#123;</span><br><span class="line">        supported: false,</span><br><span class="line">        message: &#x27;您的浏览器不支持Promise，请升级到现代浏览器&#x27;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return &#123; supported: true &#125;</span><br><span class="line">  &#125; catch (error) &#123;</span><br><span class="line">    return &#123;</span><br><span class="line">      supported: false,</span><br><span class="line">      message: `兼容性检测失败: $&#123;error.message&#125;`</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 降级到localStorage的适配器</span><br><span class="line">export const createFallbackStorage = () =&gt; &#123;</span><br><span class="line">  const STORAGE_KEY = &#x27;fallback_db_&#x27;</span><br><span class="line"></span><br><span class="line">  return &#123;</span><br><span class="line">    async get(storeName, key) &#123;</span><br><span class="line">      const data = localStorage.getItem(STORAGE_KEY + storeName)</span><br><span class="line">      if (!data) return null</span><br><span class="line">      </span><br><span class="line">      const store = JSON.parse(data)</span><br><span class="line">      return store[key] || null</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    async getAll(storeName) &#123;</span><br><span class="line">      const data = localStorage.getItem(STORAGE_KEY + storeName)</span><br><span class="line">      if (!data) return []</span><br><span class="line">      </span><br><span class="line">      const store = JSON.parse(data)</span><br><span class="line">      return Object.values(store)</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    async add(storeName, value, key) &#123;</span><br><span class="line">      const data = localStorage.getItem(STORAGE_KEY + storeName) || &#x27;&#123;&#125;&#x27;</span><br><span class="line">      const store = JSON.parse(data)</span><br><span class="line">      </span><br><span class="line">      if (store[key]) &#123;</span><br><span class="line">        throw new Error(`主键 $&#123;key&#125; 已存在`)</span><br><span class="line">      &#125;</span><br><span class="line">      </span><br><span class="line">      store[key] = value</span><br><span class="line">      localStorage.setItem(STORAGE_KEY + storeName, JSON.stringify(store))</span><br><span class="line">      return key</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    async put(storeName, value, key) &#123;</span><br><span class="line">      const data = localStorage.getItem(STORAGE_KEY + storeName) || &#x27;&#123;&#125;&#x27;</span><br><span class="line">      const store = JSON.parse(data)</span><br><span class="line">      </span><br><span class="line">      store[key] = value</span><br><span class="line">      localStorage.setItem(STORAGE_KEY + storeName, JSON.stringify(store))</span><br><span class="line">      return key</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    async delete(storeName, key) &#123;</span><br><span class="line">      const data = localStorage.getItem(STORAGE_KEY + storeName)</span><br><span class="line">      if (!data) return</span><br><span class="line">      </span><br><span class="line">      const store = JSON.parse(data)</span><br><span class="line">      delete store[key]</span><br><span class="line">      localStorage.setItem(STORAGE_KEY + storeName, JSON.stringify(store))</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    async clear(storeName) &#123;</span><br><span class="line">      localStorage.removeItem(STORAGE_KEY + storeName)</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    async count(storeName) &#123;</span><br><span class="line">      const data = localStorage.getItem(STORAGE_KEY + storeName)</span><br><span class="line">      if (!data) return 0</span><br><span class="line">      </span><br><span class="line">      const store = JSON.parse(data)</span><br><span class="line">      return Object.keys(store).length</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 创建统一的存储接口</span><br><span class="line">export const createStorage = async () =&gt; &#123;</span><br><span class="line">  const compatibility = checkCompatibility()</span><br><span class="line">  </span><br><span class="line">  if (!compatibility.supported) &#123;</span><br><span class="line">    console.warn(&#x27;IndexedDB不支持，使用localStorage降级方案&#x27;)</span><br><span class="line">    return createFallbackStorage()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  try &#123;</span><br><span class="line">    // 尝试初始化IndexedDB</span><br><span class="line">    const db = await getDB()</span><br><span class="line">    return db</span><br><span class="line">  &#125; catch (error) &#123;</span><br><span class="line">    console.warn(&#x27;IndexedDB初始化失败，使用localStorage降级方案:&#x27;, error)</span><br><span class="line">    return createFallbackStorage()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="性能优化">性能优化</h2>
<h3 id="1-连接池管理">1. 连接池管理</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line">// 数据库连接池</span><br><span class="line">class DBConnectionPool &#123;</span><br><span class="line">  constructor() &#123;</span><br><span class="line">    this.pool = []</span><br><span class="line">    this.maxConnections = 5</span><br><span class="line">    this.waiting = []</span><br><span class="line">    this.isClosed = false</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  async getConnection() &#123;</span><br><span class="line">    if (this.isClosed) &#123;</span><br><span class="line">      throw new Error(&#x27;连接池已关闭&#x27;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 如果有空闲连接，直接返回</span><br><span class="line">    if (this.pool.length &gt; 0) &#123;</span><br><span class="line">      return this.pool.shift()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 如果未达到最大连接数，创建新连接</span><br><span class="line">    if (this.pool.length + this.waiting.length &lt; this.maxConnections) &#123;</span><br><span class="line">      const db = await initDB()</span><br><span class="line">      return db</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 否则等待空闲连接</span><br><span class="line">    return new Promise((resolve) =&gt; &#123;</span><br><span class="line">      this.waiting.push(resolve)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  releaseConnection(db) &#123;</span><br><span class="line">    if (this.isClosed) &#123;</span><br><span class="line">      db.close()</span><br><span class="line">      return</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 如果有等待的请求，直接分配连接</span><br><span class="line">    if (this.waiting.length &gt; 0) &#123;</span><br><span class="line">      const resolve = this.waiting.shift()</span><br><span class="line">      resolve(db)</span><br><span class="line">      return</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 否则放回连接池</span><br><span class="line">    this.pool.push(db)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  async close() &#123;</span><br><span class="line">    this.isClosed = true</span><br><span class="line"></span><br><span class="line">    // 关闭所有连接</span><br><span class="line">    for (const db of this.pool) &#123;</span><br><span class="line">      await db.close()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 拒绝所有等待的请求</span><br><span class="line">    for (const resolve of this.waiting) &#123;</span><br><span class="line">      resolve(null)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    this.pool = []</span><br><span class="line">    this.waiting = []</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 创建连接池实例</span><br><span class="line">export const connectionPool = new DBConnectionPool()</span><br><span class="line"></span><br><span class="line">// 使用连接池的数据库操作</span><br><span class="line">export const withConnection = async (operation) =&gt; &#123;</span><br><span class="line">  let db = null</span><br><span class="line"></span><br><span class="line">  try &#123;</span><br><span class="line">    db = await connectionPool.getConnection()</span><br><span class="line">    </span><br><span class="line">    if (!db) &#123;</span><br><span class="line">      throw new Error(&#x27;无法获取数据库连接&#x27;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return await operation(db)</span><br><span class="line">  &#125; finally &#123;</span><br><span class="line">    if (db) &#123;</span><br><span class="line">      connectionPool.releaseConnection(db)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 使用连接池的示例</span><br><span class="line">export const getUserWithPool = async (userId) =&gt; &#123;</span><br><span class="line">  return withConnection(async (db) =&gt; &#123;</span><br><span class="line">    return db.get(&#x27;users&#x27;, userId)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="2-缓存策略">2. 缓存策略</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line">// 内存缓存管理器</span><br><span class="line">class CacheManager &#123;</span><br><span class="line">  constructor(options = &#123;&#125;) &#123;</span><br><span class="line">    this.cache = new Map()</span><br><span class="line">    this.ttl = options.ttl || 5 * 60 * 1000 // 默认5分钟</span><br><span class="line">    this.maxSize = options.maxSize || 1000</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  set(key, value, ttl = this.ttl) &#123;</span><br><span class="line">    // 如果缓存已满，删除最旧的条目</span><br><span class="line">    if (this.cache.size &gt;= this.maxSize) &#123;</span><br><span class="line">      const firstKey = this.cache.keys().next().value</span><br><span class="line">      this.cache.delete(firstKey)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    const expireTime = Date.now() + ttl</span><br><span class="line">    this.cache.set(key, &#123; value, expireTime &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  get(key) &#123;</span><br><span class="line">    const item = this.cache.get(key)</span><br><span class="line">    </span><br><span class="line">    if (!item) &#123;</span><br><span class="line">      return null</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 检查是否过期</span><br><span class="line">    if (Date.now() &gt; item.expireTime) &#123;</span><br><span class="line">      this.cache.delete(key)</span><br><span class="line">      return null</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return item.value</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  delete(key) &#123;</span><br><span class="line">    this.cache.delete(key)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  clear() &#123;</span><br><span class="line">    this.cache.clear()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  has(key) &#123;</span><br><span class="line">    return this.get(key) !== null</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 创建缓存实例</span><br><span class="line">export const cache = new CacheManager(&#123;</span><br><span class="line">  ttl: 10 * 60 * 1000, // 10分钟</span><br><span class="line">  maxSize: 500</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">// 带缓存的数据获取</span><br><span class="line">export const getCachedData = async (storeName, key, options = &#123;&#125;) =&gt; &#123;</span><br><span class="line">  const cacheKey = `$&#123;storeName&#125;:$&#123;key&#125;`</span><br><span class="line">  </span><br><span class="line">  // 先检查缓存</span><br><span class="line">  const cachedData = cache.get(cacheKey)</span><br><span class="line">  if (cachedData &amp;&amp; !options.forceRefresh) &#123;</span><br><span class="line">    return &#123; success: true, data: cachedData, fromCache: true &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // 缓存未命中或需要强制刷新，从数据库获取</span><br><span class="line">  try &#123;</span><br><span class="line">    const result = await withConnection(async (db) =&gt; &#123;</span><br><span class="line">      return db.get(storeName, key)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    if (result) &#123;</span><br><span class="line">      // 更新缓存</span><br><span class="line">      cache.set(cacheKey, result, options.ttl)</span><br><span class="line">      return &#123; success: true, data: result, fromCache: false &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return &#123; success: false, error: &#x27;数据不存在&#x27; &#125;</span><br><span class="line">  &#125; catch (error) &#123;</span><br><span class="line">    console.error(`获取$&#123;storeName&#125;数据失败:`, error)</span><br><span class="line">    return &#123; success: false, error: error.message &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 缓存失效机制</span><br><span class="line">export const invalidateCache = (storeName, key = null) =&gt; &#123;</span><br><span class="line">  if (key) &#123;</span><br><span class="line">    cache.delete(`$&#123;storeName&#125;:$&#123;key&#125;`)</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    // 清除整个store的缓存</span><br><span class="line">    for (const cacheKey of cache.cache.keys()) &#123;</span><br><span class="line">      if (cacheKey.startsWith(`$&#123;storeName&#125;:`)) &#123;</span><br><span class="line">        cache.delete(cacheKey)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 更新数据时自动失效缓存</span><br><span class="line">export const updateWithCacheInvalidation = async (storeName, id, data) =&gt; &#123;</span><br><span class="line">  const result = await withConnection(async (db) =&gt; &#123;</span><br><span class="line">    return db.put(storeName, data, id)</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  if (result.success) &#123;</span><br><span class="line">    // 失效相关缓存</span><br><span class="line">    invalidateCache(storeName, id)</span><br><span class="line">    // 可以根据需要失效其他相关缓存</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  return result</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="3-批量操作优化">3. 批量操作优化</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line">// 批量操作队列</span><br><span class="line">class BatchOperationQueue &#123;</span><br><span class="line">  constructor(options = &#123;&#125;) &#123;</span><br><span class="line">    this.queue = new Map()</span><br><span class="line">    this.batchSize = options.batchSize || 100</span><br><span class="line">    this.delay = options.delay || 100</span><br><span class="line">    this.timers = new Map()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  addOperation(storeName, operation) &#123;</span><br><span class="line">    if (!this.queue.has(storeName)) &#123;</span><br><span class="line">      this.queue.set(storeName, [])</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    const storeQueue = this.queue.get(storeName)</span><br><span class="line">    storeQueue.push(operation)</span><br><span class="line"></span><br><span class="line">    // 如果达到批处理大小，立即执行</span><br><span class="line">    if (storeQueue.length &gt;= this.batchSize) &#123;</span><br><span class="line">      this.processBatch(storeName)</span><br><span class="line">    &#125; else if (!this.timers.has(storeName)) &#123;</span><br><span class="line">      // 否则设置延迟执行</span><br><span class="line">      this.timers.set(storeName, setTimeout(() =&gt; &#123;</span><br><span class="line">        this.processBatch(storeName)</span><br><span class="line">      &#125;, this.delay))</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  async processBatch(storeName) &#123;</span><br><span class="line">    // 清除定时器</span><br><span class="line">    if (this.timers.has(storeName)) &#123;</span><br><span class="line">      clearTimeout(this.timers.get(storeName))</span><br><span class="line">      this.timers.delete(storeName)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    const storeQueue = this.queue.get(storeName)</span><br><span class="line">    if (!storeQueue || storeQueue.length === 0) &#123;</span><br><span class="line">      return</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    try &#123;</span><br><span class="line">      // 执行批处理操作</span><br><span class="line">      await batchOperations(storeName, storeQueue)</span><br><span class="line">      </span><br><span class="line">      // 清空队列</span><br><span class="line">      this.queue.set(storeName, [])</span><br><span class="line">    &#125; catch (error) &#123;</span><br><span class="line">      console.error(`批处理操作失败 ($&#123;storeName&#125;):`, error)</span><br><span class="line">      // 可以选择重试或处理失败的操作</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  async flush() &#123;</span><br><span class="line">    // 立即执行所有队列中的操作</span><br><span class="line">    for (const storeName of this.queue.keys()) &#123;</span><br><span class="line">      await this.processBatch(storeName)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 创建批处理队列实例</span><br><span class="line">export const batchQueue = new BatchOperationQueue(&#123;</span><br><span class="line">  batchSize: 50,</span><br><span class="line">  delay: 50</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">// 使用批处理队列的操作</span><br><span class="line">export const queueUserUpdate = (userId, data) =&gt; &#123;</span><br><span class="line">  batchQueue.addOperation(&#x27;users&#x27;, &#123;</span><br><span class="line">    type: &#x27;put&#x27;,</span><br><span class="line">    data: &#123; id: userId, ...data &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">export const queueProductAdd = (productData) =&gt; &#123;</span><br><span class="line">  batchQueue.addOperation(&#x27;products&#x27;, &#123;</span><br><span class="line">    type: &#x27;add&#x27;,</span><br><span class="line">    data: productData</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="4-索引优化">4. 索引优化</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">// 索引使用建议和优化</span><br><span class="line">export const optimizeIndexes = async () =&gt; &#123;</span><br><span class="line">  const db = await getDB()</span><br><span class="line">  </span><br><span class="line">  // 分析查询模式并建议索引</span><br><span class="line">  const indexRecommendations = []</span><br><span class="line"></span><br><span class="line">  // 检查用户表的查询模式</span><br><span class="line">  const userStore = db.transaction(&#x27;users&#x27;, &#x27;readonly&#x27;).objectStore(&#x27;users&#x27;)</span><br><span class="line">  </span><br><span class="line">  // 检查常用查询字段是否有索引</span><br><span class="line">  const commonQueryFields = [&#x27;email&#x27;, &#x27;username&#x27;, &#x27;level&#x27;, &#x27;age&#x27;]</span><br><span class="line">  for (const field of commonQueryFields) &#123;</span><br><span class="line">    if (!userStore.indexNames.contains(field)) &#123;</span><br><span class="line">      indexRecommendations.push(&#123;</span><br><span class="line">        storeName: &#x27;users&#x27;,</span><br><span class="line">        field,</span><br><span class="line">        reason: &#x27;常用查询字段缺少索引&#x27;</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  return indexRecommendations</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 索引使用性能监控</span><br><span class="line">export const monitorIndexPerformance = async () =&gt; &#123;</span><br><span class="line">  const db = await getDB()</span><br><span class="line">  const performanceData = &#123;&#125;</span><br><span class="line"></span><br><span class="line">  for (const storeName of db.objectStoreNames) &#123;</span><br><span class="line">    const tx = db.transaction(storeName, &#x27;readonly&#x27;)</span><br><span class="line">    const store = tx.objectStore(storeName)</span><br><span class="line">    </span><br><span class="line">    performanceData[storeName] = &#123;</span><br><span class="line">      indexes: Array.from(store.indexNames),</span><br><span class="line">      recordCount: await store.count()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    await tx.done</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  return performanceData</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="总结">总结</h2>
<p>本指南详细介绍了如何在 Vue 应用中使用 idb 库操作 IndexedDB，涵盖了从基础概念到高级应用的各个方面：</p>
<h3 id="核心要点">核心要点</h3>
<ol>
<li class="lvl-3">
<p><strong>环境搭建</strong>：安装 idb 库并创建数据库连接管理</p>
</li>
<li class="lvl-3">
<p><strong>基础操作</strong>：掌握 CRUD 操作和事务处理</p>
</li>
<li class="lvl-3">
<p><strong>版本管理</strong>：正确处理数据库版本升级和迁移</p>
</li>
<li class="lvl-3">
<p><strong>索引优化</strong>：使用索引提高查询效率</p>
</li>
<li class="lvl-3">
<p><strong>高级查询</strong>：掌握区间查找和游标操作</p>
</li>
<li class="lvl-3">
<p><strong>Vue 集成</strong>：使用 Composition API 和 Pinia/Vuex 管理数据</p>
</li>
<li class="lvl-3">
<p><strong>性能优化</strong>：连接池、缓存、批处理等优化策略</p>
</li>
<li class="lvl-3">
<p><strong>问题解决</strong>：常见问题的解决方案和最佳实践</p>
</li>
</ol>
<h3 id="最佳实践建议">最佳实践建议</h3>
<ol>
<li class="lvl-3">
<p><strong>连接管理</strong>：使用单例模式管理数据库连接，避免频繁打开和关闭</p>
</li>
<li class="lvl-3">
<p><strong>错误处理</strong>：完善的错误处理和用户反馈机制</p>
</li>
<li class="lvl-3">
<p><strong>性能优化</strong>：合理使用索引，避免全表扫描</p>
</li>
<li class="lvl-3">
<p><strong>数据安全</strong>：敏感数据加密，定期备份</p>
</li>
<li class="lvl-3">
<p><strong>兼容性考虑</strong>：提供降级方案，确保在不支持 IndexedDB 的浏览器中也能正常运行</p>
</li>
<li class="lvl-3">
<p><strong>监控和调试</strong>：使用浏览器 DevTools 进行调试和性能监控</p>
</li>
</ol>
<p>通过本指南的学习，您应该能够在 Vue 应用中熟练使用 IndexedDB 进行本地数据存储，为用户提供更好的离线体验和数据持久化功能。</p>
<h3 id="进一步学习资源">进一步学习资源</h3>
<ul class="lvl-0">
<li class="lvl-2">
<p><a target="_blank" rel="noopener" href="https://github.com/jakearchibald/idb">idb 官方文档</a></p>
</li>
<li class="lvl-2">
<p><a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/IndexedDB_API">MDN IndexedDB 文档</a></p>
</li>
<li class="lvl-2">
<p><a target="_blank" rel="noopener" href="https://vuejs.org/">Vue.js 官方文档</a></p>
</li>
<li class="lvl-2">
<p><a target="_blank" rel="noopener" href="https://caniuse.com/indexeddb">浏览器兼容性表</a></p>
</li>
</ul>

    </div>

    
    
    

      <footer class="post-footer">
          
          <div class="post-tags">
              <a href="/tags/Web/" rel="tag"><i class="fa fa-tag"></i> Web</a>
          </div>

        



        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2025/10/09/web/Vue%20%E8%B7%AF%E7%94%B1/" rel="prev" title="Vue路由">
      <i class="fa fa-chevron-left"></i> Vue路由
    </a></div>
      <div class="post-nav-item">
    <a href="/2025/10/10/web/Pinia%20%E7%9F%A5%E8%AF%86%E7%82%B9%E6%95%B4%E7%90%86/" rel="next" title="Pinia学习笔记">
      Pinia学习笔记 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
            <!-- 修正后的代码：使用 Nunjucks 的 default 过滤器 -->

    <div class="comments" id="gitalk-container"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link"><span class="nav-number">1.</span> <span class="nav-text">Vue 中使用 idb 操作 IndexedDB 完整指南</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%9B%AE%E5%BD%95"><span class="nav-number">1.1.</span> <span class="nav-text">目录</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF-IndexedDB-%E5%92%8C-idb"><span class="nav-number">1.2.</span> <span class="nav-text">什么是 IndexedDB 和 idb</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#IndexedDB-%E7%AE%80%E4%BB%8B"><span class="nav-number">1.2.1.</span> <span class="nav-text">IndexedDB 简介</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#idb-%E5%BA%93%E7%AE%80%E4%BB%8B"><span class="nav-number">1.2.2.</span> <span class="nav-text">idb 库简介</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87%E4%B8%8E%E5%AE%89%E8%A3%85"><span class="nav-number">1.3.</span> <span class="nav-text">环境准备与安装</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%89%E8%A3%85-idb"><span class="nav-number">1.3.1.</span> <span class="nav-text">安装 idb</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9C%A8-Vue-%E4%B8%AD%E5%BC%95%E5%85%A5"><span class="nav-number">1.3.2.</span> <span class="nav-text">在 Vue 中引入</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5"><span class="nav-number">1.4.</span> <span class="nav-text">基础概念</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E5%BA%93%EF%BC%88Database%EF%BC%89"><span class="nav-number">1.4.1.</span> <span class="nav-text">数据库（Database）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AF%B9%E8%B1%A1%E4%BB%93%E5%BA%93%EF%BC%88Object-Store%EF%BC%89"><span class="nav-number">1.4.2.</span> <span class="nav-text">对象仓库（Object Store）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BA%8B%E5%8A%A1%EF%BC%88Transaction%EF%BC%89"><span class="nav-number">1.4.3.</span> <span class="nav-text">事务（Transaction）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%B4%A2%E5%BC%95%EF%BC%88Index%EF%BC%89"><span class="nav-number">1.4.4.</span> <span class="nav-text">索引（Index）</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E8%BF%9E%E6%8E%A5%E7%AE%A1%E7%90%86"><span class="nav-number">1.5.</span> <span class="nav-text">数据库连接管理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E6%95%B0%E6%8D%AE%E5%BA%93%E8%BF%9E%E6%8E%A5"><span class="nav-number">1.5.1.</span> <span class="nav-text">创建数据库连接</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BF%9E%E6%8E%A5%E7%AE%A1%E7%90%86%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="nav-number">1.5.2.</span> <span class="nav-text">连接管理最佳实践</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E6%93%8D%E4%BD%9C%EF%BC%88CRUD%EF%BC%89"><span class="nav-number">1.6.</span> <span class="nav-text">数据操作（CRUD）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E6%95%B0%E6%8D%AE%EF%BC%88Create%EF%BC%89"><span class="nav-number">1.6.1.</span> <span class="nav-text">创建数据（Create）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%AF%BB%E5%8F%96%E6%95%B0%E6%8D%AE%EF%BC%88Read%EF%BC%89"><span class="nav-number">1.6.2.</span> <span class="nav-text">读取数据（Read）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9B%B4%E6%96%B0%E6%95%B0%E6%8D%AE%EF%BC%88Update%EF%BC%89"><span class="nav-number">1.6.3.</span> <span class="nav-text">更新数据（Update）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%A0%E9%99%A4%E6%95%B0%E6%8D%AE%EF%BC%88Delete%EF%BC%89"><span class="nav-number">1.6.4.</span> <span class="nav-text">删除数据（Delete）</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%8B%E5%8A%A1%E5%A4%84%E7%90%86"><span class="nav-number">1.7.</span> <span class="nav-text">事务处理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9F%BA%E6%9C%AC%E4%BA%8B%E5%8A%A1%E6%93%8D%E4%BD%9C"><span class="nav-number">1.7.1.</span> <span class="nav-text">基本事务操作</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%B7%A8%E5%AD%98%E5%82%A8%E4%BA%8B%E5%8A%A1"><span class="nav-number">1.7.2.</span> <span class="nav-text">跨存储事务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BA%8B%E5%8A%A1%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86"><span class="nav-number">1.7.3.</span> <span class="nav-text">事务错误处理</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E7%89%88%E6%9C%AC%E7%AE%A1%E7%90%86"><span class="nav-number">1.8.</span> <span class="nav-text">数据库版本管理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%89%88%E6%9C%AC%E5%8D%87%E7%BA%A7%E7%AD%96%E7%95%A5"><span class="nav-number">1.8.1.</span> <span class="nav-text">版本升级策略</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%89%88%E6%9C%AC%E7%AE%A1%E7%90%86%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="nav-number">1.8.2.</span> <span class="nav-text">版本管理最佳实践</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%B4%A2%E5%BC%95%E4%BD%BF%E7%94%A8"><span class="nav-number">1.9.</span> <span class="nav-text">索引使用</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E7%B4%A2%E5%BC%95"><span class="nav-number">1.9.1.</span> <span class="nav-text">创建索引</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E7%B4%A2%E5%BC%95%E6%9F%A5%E8%AF%A2"><span class="nav-number">1.9.2.</span> <span class="nav-text">使用索引查询</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%B4%A2%E5%BC%95%E7%AE%A1%E7%90%86"><span class="nav-number">1.9.3.</span> <span class="nav-text">索引管理</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%AB%98%E7%BA%A7%E6%9F%A5%E8%AF%A2%E6%93%8D%E4%BD%9C"><span class="nav-number">1.10.</span> <span class="nav-text">高级查询操作</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8C%BA%E9%97%B4%E6%9F%A5%E6%89%BE"><span class="nav-number">1.10.1.</span> <span class="nav-text">区间查找</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B8%B8%E6%A0%87%E6%93%8D%E4%BD%9C"><span class="nav-number">1.10.2.</span> <span class="nav-text">游标操作</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A4%8D%E6%9D%82%E6%9F%A5%E8%AF%A2%E7%BB%84%E5%90%88"><span class="nav-number">1.10.3.</span> <span class="nav-text">复杂查询组合</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Vue-%E4%B8%AD%E7%9A%84%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="nav-number">1.11.</span> <span class="nav-text">Vue 中的最佳实践</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA-Vue-Composition-API-%E5%B0%81%E8%A3%85"><span class="nav-number">1.11.1.</span> <span class="nav-text">创建 Vue Composition API 封装</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9C%A8-Vue-%E7%BB%84%E4%BB%B6%E4%B8%AD%E4%BD%BF%E7%94%A8"><span class="nav-number">1.11.2.</span> <span class="nav-text">在 Vue 组件中使用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Vuex-Pinia-%E9%9B%86%E6%88%90"><span class="nav-number">1.11.3.</span> <span class="nav-text">Vuex&#x2F;Pinia 集成</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98%E4%B8%8E%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="nav-number">1.12.</span> <span class="nav-text">常见问题与解决方案</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E6%95%B0%E6%8D%AE%E5%BA%93%E8%BF%9E%E6%8E%A5%E9%97%AE%E9%A2%98"><span class="nav-number">1.12.1.</span> <span class="nav-text">1. 数据库连接问题</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E6%95%B0%E6%8D%AE%E8%BF%81%E7%A7%BB%E9%97%AE%E9%A2%98"><span class="nav-number">1.12.2.</span> <span class="nav-text">2. 数据迁移问题</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E6%80%A7%E8%83%BD%E9%97%AE%E9%A2%98"><span class="nav-number">1.12.3.</span> <span class="nav-text">3. 性能问题</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-%E6%B5%8F%E8%A7%88%E5%99%A8%E5%85%BC%E5%AE%B9%E6%80%A7%E9%97%AE%E9%A2%98"><span class="nav-number">1.12.4.</span> <span class="nav-text">4. 浏览器兼容性问题</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96"><span class="nav-number">1.13.</span> <span class="nav-text">性能优化</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E8%BF%9E%E6%8E%A5%E6%B1%A0%E7%AE%A1%E7%90%86"><span class="nav-number">1.13.1.</span> <span class="nav-text">1. 连接池管理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E7%BC%93%E5%AD%98%E7%AD%96%E7%95%A5"><span class="nav-number">1.13.2.</span> <span class="nav-text">2. 缓存策略</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E6%89%B9%E9%87%8F%E6%93%8D%E4%BD%9C%E4%BC%98%E5%8C%96"><span class="nav-number">1.13.3.</span> <span class="nav-text">3. 批量操作优化</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-%E7%B4%A2%E5%BC%95%E4%BC%98%E5%8C%96"><span class="nav-number">1.13.4.</span> <span class="nav-text">4. 索引优化</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%80%BB%E7%BB%93"><span class="nav-number">1.14.</span> <span class="nav-text">总结</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A0%B8%E5%BF%83%E8%A6%81%E7%82%B9"><span class="nav-number">1.14.1.</span> <span class="nav-text">核心要点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5%E5%BB%BA%E8%AE%AE"><span class="nav-number">1.14.2.</span> <span class="nav-text">最佳实践建议</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BF%9B%E4%B8%80%E6%AD%A5%E5%AD%A6%E4%B9%A0%E8%B5%84%E6%BA%90"><span class="nav-number">1.14.3.</span> <span class="nav-text">进一步学习资源</span></a></li></ol></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="三子曰"
      src="https://cdn.jsdelivr.net/gh/MengChangWang/Blog_Image@main/img/avatar.png">
  <p class="site-author-name" itemprop="name">三子曰</p>
  <div class="site-description" itemprop="description">欢迎来到我的博客</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">52</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">2</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">19</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/MengChangWang" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;MengChangWang" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:wangmc1024@gmail.com" title="E-Mail → mailto:wangmc1024@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



      </div>
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; Wed Mar 27 2024 08:00:00 GMT+0800 (中国标准时间) – 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">三子曰</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="站点总字数">549k</span>
</div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script size="300" alpha="0.6" zIndex="-1" src="/lib/canvas-ribbon/canvas-ribbon.js"></script>
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/lozad@1/dist/lozad.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  
  <script>
    (function(){
      var canonicalURL, curProtocol;
      //Get the <link> tag
      var x=document.getElementsByTagName("link");
		//Find the last canonical URL
		if(x.length > 0){
			for (i=0;i<x.length;i++){
				if(x[i].rel.toLowerCase() == 'canonical' && x[i].href){
					canonicalURL=x[i].href;
				}
			}
		}
    //Get protocol
	    if (!canonicalURL){
	    	curProtocol = window.location.protocol.split(':')[0];
	    }
	    else{
	    	curProtocol = canonicalURL.split(':')[0];
	    }
      //Get current URL if the canonical URL does not exist
	    if (!canonicalURL) canonicalURL = window.location.href;
	    //Assign script content. Replace current URL with the canonical URL
      !function(){var e=/([http|https]:\/\/[a-zA-Z0-9\_\.]+\.baidu\.com)/gi,r=canonicalURL,t=document.referrer;if(!e.test(r)){var n=(String(curProtocol).toLowerCase() === 'https')?"https://sp0.baidu.com/9_Q4simg2RQJ8t7jm9iCKT-xh_/s.gif":"//api.share.baidu.com/s.gif";t?(n+="?r="+encodeURIComponent(document.referrer),r&&(n+="&l="+r)):r&&(n+="?l="+r);var i=new Image;i.src=n}}(window);})();
  </script>















  

  

<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.css">

<script>
NexT.utils.loadComments(document.querySelector('#gitalk-container'), () => {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js', () => {
    var gitalk = new Gitalk({
      clientID    : '2719e26e1ea715ee8429',
      clientSecret: '77a4ce8e9410a002f05c8f2c2b398c952a012d7c',
      repo        : 'mengchangwang.github.io',
      owner       : 'MengChangWang',
      admin       : ['MengChangWang'],
      id          : 'c83882f64828173c91d806180d8a3009',
        language: 'zh-CN',
      distractionFreeMode: true
    });
    gitalk.render('gitalk-container');
  }, window.Gitalk);
});
</script>


<script src="/js/spa.js"></script>  <!-- 引入 SPA 核心脚本 -->
<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.css">

<script>
NexT.utils.loadComments(document.querySelector('#gitalk-container'), () => {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js', () => {
    var gitalk = new Gitalk({
      clientID    : '2719e26e1ea715ee8429',
      clientSecret: '77a4ce8e9410a002f05c8f2c2b398c952a012d7c',
      repo        : 'mengchangwang.github.io',
      owner       : 'MengChangWang',
      admin       : ['MengChangWang'],
      id          : 'c83882f64828173c91d806180d8a3009',
        language: 'zh-CN',
      distractionFreeMode: true
    });
    gitalk.render('gitalk-container');
  }, window.Gitalk);
});
</script>

</body>
</html>

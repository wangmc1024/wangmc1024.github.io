<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 8.0.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"wangmc1024.github.io","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":false,"style":"mac"},"back2top":{"enable":true,"sidebar":true,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":"gitalk","storage":true,"lazyload":true,"nav":null,"activeClass":"gitalk"},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":true,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.json"};
  </script>

  <meta name="description" content="利用AI，结合官方文档收集整理，作为了解">
<meta property="og:type" content="article">
<meta property="og:title" content="MCP构建指南">
<meta property="og:url" content="https://wangmc1024.github.io/2025/10/23/AI/MCP%E6%9E%84%E5%BB%BA%E6%8C%87%E5%8D%97/index.html">
<meta property="og:site_name" content="Computer Science">
<meta property="og:description" content="利用AI，结合官方文档收集整理，作为了解">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2025-10-23T10:55:02.000Z">
<meta property="article:modified_time" content="2025-10-23T10:56:21.095Z">
<meta property="article:author" content="三子曰">
<meta property="article:tag" content="AI">
<meta property="article:tag" content="web">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://wangmc1024.github.io/2025/10/23/AI/MCP%E6%9E%84%E5%BB%BA%E6%8C%87%E5%8D%97/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>MCP构建指南 | Computer Science</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>


<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Computer Science</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">WangMC Blog</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>时间轴</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    


    <main class="main">
      <div class="main-inner">
        <div id="spa-content-wrap" class="content-wrap">
            

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://wangmc1024.github.io/2025/10/23/AI/MCP%E6%9E%84%E5%BB%BA%E6%8C%87%E5%8D%97/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://cdn.jsdelivr.net/gh/MengChangWang/Blog_Image@main/img/avatar.png">
      <meta itemprop="name" content="三子曰">
      <meta itemprop="description" content="欢迎来到我的博客">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Computer Science">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          MCP构建指南
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2025-10-23 18:55:02 / 修改时间：18:56:21" itemprop="dateCreated datePublished" datetime="2025-10-23T18:55:02+08:00">2025-10-23</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/AI/" itemprop="url" rel="index"><span itemprop="name">AI</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span id="busuanzi_value_page_pv"></span>
            </span><br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>47k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>42 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <blockquote>
<p>利用AI，结合官方文档收集整理，作为了解</p>
</blockquote>
<span id="more"></span>
<h1>MCP 开发指南：构建模型上下文协议服务器</h1>
<p><strong>Date</strong>: October 23, 2025<br>
<strong>Version</strong>: 1.0<br>
<strong>Specification Version</strong>: 2024-11-05</p>
<h2 id="目录">目录</h2>
<ol>
<li class="lvl-3">
<p><a href="#%E5%BF%AB%E9%80%9F%E5%BC%80%E5%A7%8B">快速开始</a></p>
</li>
<li class="lvl-3">
<p><a href="#%E5%8D%8F%E8%AE%AE%E6%A6%82%E8%BF%B0">协议概述</a></p>
</li>
<li class="lvl-3">
<p><a href="#%E6%A0%B8%E5%BF%83%E6%9E%B6%E6%9E%84">核心架构</a></p>
</li>
<li class="lvl-3">
<p><a href="#%E5%8D%8F%E8%AE%AE%E5%9F%BA%E7%A1%80">协议基础</a></p>
</li>
<li class="lvl-3">
<p><a href="#%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E7%AE%A1%E7%90%86">生命周期管理</a></p>
</li>
<li class="lvl-3">
<p><a href="#%E4%BC%A0%E8%BE%93%E6%9C%BA%E5%88%B6">传输机制</a></p>
</li>
<li class="lvl-3">
<p><a href="#%E6%9C%8D%E5%8A%A1%E7%AB%AF%E5%BC%80%E5%8F%91">服务端开发</a></p>
</li>
<li class="lvl-3">
<p><a href="#%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%BC%80%E5%8F%91">客户端开发</a></p>
</li>
<li class="lvl-3">
<p><a href="#%E5%AE%9E%E6%88%98%E7%A4%BA%E4%BE%8B">实战示例</a></p>
</li>
<li class="lvl-4">
<p><a href="#%E8%B0%83%E8%AF%95%E4%B8%8E%E6%B5%8B%E8%AF%95">调试与测试</a></p>
</li>
<li class="lvl-4">
<p><a href="#%E9%83%A8%E7%BD%B2%E6%8C%87%E5%8D%97">部署指南</a></p>
</li>
<li class="lvl-4">
<p><a href="#%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5">最佳实践</a></p>
</li>
</ol>
<hr>
<h2 id="快速开始">快速开始</h2>
<h3 id="环境准备">环境准备</h3>
<p><strong>系统要求</strong></p>
<ul class="lvl-0">
<li class="lvl-2">
<p>Python 3.8+ 或 Node.js 16+</p>
</li>
<li class="lvl-2">
<p>网络连接</p>
</li>
<li class="lvl-2">
<p>1GB 可用内存</p>
</li>
</ul>
<p><strong>安装 MCP SDK</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Python SDK</span></span><br><span class="line">pip install <span class="string">&quot;mcp[cli]&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># TypeScript SDK</span></span><br><span class="line">npm install @modelcontextprotocol/sdk</span><br></pre></td></tr></table></figure>
<h3 id="5分钟创建第一个-MCP-服务器">5分钟创建第一个 MCP 服务器</h3>
<h4 id="Step-1-创建项目目录">Step 1: 创建项目目录</h4>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> mcp-demo &amp;&amp; <span class="built_in">cd</span> mcp-demo</span><br></pre></td></tr></table></figure>
<h4 id="Step-2-编写基础服务器代码">Step 2: 编写基础服务器代码</h4>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># server.py</span></span><br><span class="line"><span class="keyword">from</span> mcp <span class="keyword">import</span> MCPServer</span><br><span class="line"><span class="keyword">from</span> mcp.types <span class="keyword">import</span> ToolRegistration</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">HelloWorldServer</span>(<span class="title class_ inherited__">MCPServer</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">super</span>().__init__(name=<span class="string">&quot;HelloWorldServer&quot;</span>, version=<span class="string">&quot;1.0.0&quot;</span>)</span><br><span class="line">        <span class="variable language_">self</span>.register_tools()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">register_tools</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;注册工具&quot;&quot;&quot;</span></span><br><span class="line">        hello_tool: ToolRegistration = &#123;</span><br><span class="line">            <span class="string">&quot;name&quot;</span>: <span class="string">&quot;say_hello&quot;</span>,</span><br><span class="line">            <span class="string">&quot;description&quot;</span>: <span class="string">&quot;向指定名称的用户打招呼&quot;</span>,</span><br><span class="line">            <span class="string">&quot;parameters&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;name&quot;</span>: &#123;</span><br><span class="line">                    <span class="string">&quot;type&quot;</span>: <span class="string">&quot;string&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;description&quot;</span>: <span class="string">&quot;用户名称&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;required&quot;</span>: <span class="literal">True</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&quot;handler&quot;</span>: <span class="variable language_">self</span>.handle_say_hello</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable language_">self</span>.register_tool(hello_tool)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">handle_say_hello</span>(<span class="params">self, parameters</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;处理打招呼工具调用&quot;&quot;&quot;</span></span><br><span class="line">        name = parameters.get(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;World&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="string">&quot;message&quot;</span>: <span class="string">f&quot;Hello, <span class="subst">&#123;name&#125;</span>!&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    server = HelloWorldServer()</span><br><span class="line">    server.run(host=<span class="string">&quot;0.0.0.0&quot;</span>, port=<span class="number">8080</span>)</span><br></pre></td></tr></table></figure>
<h4 id="Step-3-启动服务器">Step 3: 启动服务器</h4>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python server.py</span><br></pre></td></tr></table></figure>
<h4 id="Step-4-测试服务器">Step 4: 测试服务器</h4>
<p>使用 MCP 客户端测试：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># client.py</span></span><br><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">from</span> mcp <span class="keyword">import</span> MCPClient</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">test_server</span>():</span><br><span class="line">    client = MCPClient(host=<span class="string">&quot;localhost&quot;</span>, port=<span class="number">8080</span>)</span><br><span class="line">    session = <span class="keyword">await</span> client.connect()</span><br><span class="line">    </span><br><span class="line">    result = <span class="keyword">await</span> session.call_tool(</span><br><span class="line">        tool_name=<span class="string">&quot;say_hello&quot;</span>,</span><br><span class="line">        parameters=&#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;MCP Developer&quot;</span>&#125;</span><br><span class="line">    )</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;服务器响应: <span class="subst">&#123;result&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="comment"># 输出: 服务器响应: &#123;&#x27;message&#x27;: &#x27;Hello, MCP Developer!&#x27;&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    asyncio.run(test_server())</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="协议概述">协议概述</h2>
<h3 id="什么是-MCP">什么是 MCP</h3>
<p><strong>MCP (Model Context Protocol)</strong> 是一种专门为大语言模型（LLM）设计的标准化通信协议，旨在建立模型与外部工具、数据源和服务之间的统一交互接口。</p>
<h3 id="核心价值">核心价值</h3>
<p>MCP 解决了 AI 应用开发中的关键问题：</p>
<ul class="lvl-0">
<li class="lvl-2">
<p><strong>标准化接口</strong>：为不同工具和服务提供统一调用方式</p>
</li>
<li class="lvl-2">
<p><strong>上下文管理</strong>：支持复杂对话场景中的状态保持</p>
</li>
<li class="lvl-2">
<p><strong>安全隔离</strong>：通过三层架构实现严格的安全边界</p>
</li>
<li class="lvl-2">
<p><strong>扩展性</strong>：允许动态添加新功能而不影响现有系统</p>
</li>
</ul>
<h3 id="协议特点">协议特点</h3>
<ul class="lvl-0">
<li class="lvl-2">
<p><strong>基于 JSON-RPC 2.0</strong>：成熟的远程过程调用规范</p>
</li>
<li class="lvl-2">
<p><strong>有状态会话</strong>：维护上下文信息的会话机制</p>
</li>
<li class="lvl-2">
<p><strong>双向通信</strong>：支持客户端和服务器双向消息交换</p>
</li>
<li class="lvl-2">
<p><strong>多传输支持</strong>：stdio 和 HTTP/SSE 传输机制</p>
</li>
</ul>
<hr>
<h2 id="核心架构">核心架构</h2>
<h3 id="三层架构模式">三层架构模式</h3>
<p>MCP 采用客户端-主机-服务器三层架构：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐</span><br><span class="line">│    客户端       │     │      主机       │     │     服务器      │</span><br><span class="line">│ (Client)        │────▶│ (Host)          │────▶│ (Server)        │</span><br><span class="line">└─────────────────┘     └─────────────────┘     └─────────────────┘</span><br></pre></td></tr></table></figure>
<h3 id="组件详情">组件详情</h3>
<h4 id="主机-Host">主机 (Host)</h4>
<p><strong>职责</strong>：</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>管理客户端实例的生命周期</p>
</li>
<li class="lvl-2">
<p>控制连接权限和执行安全策略</p>
</li>
<li class="lvl-2">
<p>协调 AI/LLM 集成</p>
</li>
<li class="lvl-2">
<p>确保系统稳定运行</p>
</li>
</ul>
<p><strong>核心功能</strong>：</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>连接管理和路由</p>
</li>
<li class="lvl-2">
<p>权限验证和安全控制</p>
</li>
<li class="lvl-2">
<p>负载均衡和故障恢复</p>
</li>
<li class="lvl-2">
<p>监控和日志记录</p>
</li>
</ul>
<h4 id="客户端-Client">客户端 (Client)</h4>
<p><strong>职责</strong>：</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>维护与服务器的独立连接</p>
</li>
<li class="lvl-2">
<p>建立有状态会话</p>
</li>
<li class="lvl-2">
<p>处理协议协商</p>
</li>
<li class="lvl-2">
<p>管理消息路由</p>
</li>
</ul>
<p><strong>核心功能</strong>：</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>会话状态管理</p>
</li>
<li class="lvl-2">
<p>消息序列化和解析</p>
</li>
<li class="lvl-2">
<p>错误处理和重试</p>
</li>
<li class="lvl-2">
<p>传输协议适配</p>
</li>
</ul>
<h4 id="服务器-Server">服务器 (Server)</h4>
<p><strong>职责</strong>：</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>公开特定的资源和工具</p>
</li>
<li class="lvl-2">
<p>独立运行和管理</p>
</li>
<li class="lvl-2">
<p>通过客户端处理请求</p>
</li>
<li class="lvl-2">
<p>支持本地和远程服务</p>
</li>
</ul>
<p><strong>核心功能</strong>：</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>工具注册和执行</p>
</li>
<li class="lvl-2">
<p>资源管理和访问</p>
</li>
<li class="lvl-2">
<p>提示词管理</p>
</li>
<li class="lvl-2">
<p>事件通知</p>
</li>
</ul>
<hr>
<h2 id="协议基础">协议基础</h2>
<h3 id="消息类型">消息类型</h3>
<p>MCP 定义了三种基本消息类型，基于 JSON-RPC 2.0 规范。</p>
<h4 id="1-请求-Request">1. 请求 (Request)</h4>
<p><strong>特点</strong>：</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>双向消息，可在客户端和服务器间双向发送</p>
</li>
<li class="lvl-2">
<p>必须包含唯一 ID</p>
</li>
<li class="lvl-2">
<p>支持参数传递</p>
</li>
<li class="lvl-2">
<p>需要响应</p>
</li>
</ul>
<p><strong>格式示例</strong>：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;jsonrpc&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;request-123&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;method&quot;</span><span class="punctuation">:</span> <span class="string">&quot;tool.call&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;params&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;toolName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;say_hello&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;arguments&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Alice&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<h4 id="2-响应-Response">2. 响应 (Response)</h4>
<p><strong>特点</strong>：</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>作为对请求的回复</p>
</li>
<li class="lvl-2">
<p>必须包含对应请求的 ID</p>
</li>
<li class="lvl-2">
<p>必须设置 result 或 error</p>
</li>
<li class="lvl-2">
<p>错误码必须是整数</p>
</li>
</ul>
<p><strong>成功响应示例</strong>：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;jsonrpc&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;request-123&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;result&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;message&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Hello, Alice!&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p><strong>错误响应示例</strong>：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;jsonrpc&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;request-123&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;error&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;code&quot;</span><span class="punctuation">:</span> <span class="number">-32602</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;message&quot;</span><span class="punctuation">:</span> <span class="string">&quot;参数验证失败&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;data&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;parameter&quot;</span><span class="punctuation">:</span> <span class="string">&quot;name&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;message&quot;</span><span class="punctuation">:</span> <span class="string">&quot;名称不能为空&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<h4 id="3-通知-Notification">3. 通知 (Notification)</h4>
<p><strong>特点</strong>：</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>不需要响应的单向消息</p>
</li>
<li class="lvl-2">
<p>不能包含 ID 字段</p>
</li>
<li class="lvl-2">
<p>用于状态更新和事件通知</p>
</li>
<li class="lvl-2">
<p>减少通信开销</p>
</li>
</ul>
<p><strong>格式示例</strong>：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;jsonrpc&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;method&quot;</span><span class="punctuation">:</span> <span class="string">&quot;status.update&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;params&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;status&quot;</span><span class="punctuation">:</span> <span class="string">&quot;processing&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;progress&quot;</span><span class="punctuation">:</span> <span class="number">50</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<h3 id="错误码规范">错误码规范</h3>
<table>
<thead>
<tr>
<th>错误码范围</th>
<th>含义</th>
<th>示例</th>
</tr>
</thead>
<tbody>
<tr>
<td>-32768 到 -32000</td>
<td>JSON-RPC 保留错误码</td>
<td>-32600: 无效请求</td>
</tr>
<tr>
<td>-32099 到 -32000</td>
<td>服务器端错误</td>
<td>-32001: 工具不存在</td>
</tr>
<tr>
<td>-32099 到 -32000</td>
<td>自定义错误码</td>
<td>-32002: 权限不足</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="生命周期管理">生命周期管理</h2>
<h3 id="会话生命周期">会话生命周期</h3>
<p>MCP 会话包含三个主要阶段：初始化、操作和关闭。</p>
<h4 id="1-初始化阶段">1. 初始化阶段</h4>
<p>初始化是客户端和服务器的第一次交互，建立通信基础。</p>
<p><strong>初始化流程</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">客户端                  服务器</span><br><span class="line">   │                      │</span><br><span class="line">   │  initialize 请求      │</span><br><span class="line">   │─────────────────────▶│</span><br><span class="line">   │                      │</span><br><span class="line">   │                      │  验证版本和能力</span><br><span class="line">   │                      │</span><br><span class="line">   │  initialize 响应      │</span><br><span class="line">   │◀─────────────────────│</span><br><span class="line">   │                      │</span><br><span class="line">   │  initialized 通知     │</span><br><span class="line">   │─────────────────────▶│</span><br><span class="line">   │                      │</span><br></pre></td></tr></table></figure>
<p><strong>初始化请求</strong>：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;jsonrpc&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;method&quot;</span><span class="punctuation">:</span> <span class="string">&quot;initialize&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;params&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;protocolVersion&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2024-11-05&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;capabilities&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;roots&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;listChanged&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;sampling&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;clientInfo&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;MyClient&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1.0.0&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p><strong>初始化响应</strong>：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;jsonrpc&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;result&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;protocolVersion&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2024-11-05&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;capabilities&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;tools&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;listChanged&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;resources&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;subscribe&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;serverInfo&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;MyServer&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1.0.0&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<h4 id="2-操作阶段">2. 操作阶段</h4>
<p>操作阶段是会话的核心，处理所有工具调用和资源访问。</p>
<p><strong>主要操作</strong>：</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>工具调用：<code>tool.call</code></p>
</li>
<li class="lvl-2">
<p>资源读取：<code>resource.read</code></p>
</li>
<li class="lvl-2">
<p>资源订阅：<code>resource.subscribe</code></p>
</li>
<li class="lvl-2">
<p>提示词获取：<code>prompt.get</code></p>
</li>
</ul>
<p><strong>工具调用示例</strong>：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;jsonrpc&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;call-456&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;method&quot;</span><span class="punctuation">:</span> <span class="string">&quot;tool.call&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;params&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;toolName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;calculate&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;arguments&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;expression&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2 + 3 * 4&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<h4 id="3-关闭阶段">3. 关闭阶段</h4>
<p>优雅地终止会话并清理资源。</p>
<p><strong>关闭流程</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">客户端                  服务器</span><br><span class="line">   │                      │</span><br><span class="line">   │  shutdown 通知        │</span><br><span class="line">   │─────────────────────▶│</span><br><span class="line">   │                      │</span><br><span class="line">   │                      │  清理资源</span><br><span class="line">   │                      │</span><br><span class="line">   │  shutdown 确认        │</span><br><span class="line">   │◀─────────────────────│</span><br><span class="line">   │                      │</span><br><span class="line">   │  连接关闭             │</span><br><span class="line">   │─────────────────────▶│</span><br><span class="line">   │                      │</span><br></pre></td></tr></table></figure>
<h3 id="版本协商">版本协商</h3>
<p><strong>版本协商策略</strong>：</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>客户端发送支持的最新版本</p>
</li>
<li class="lvl-2">
<p>服务器响应相同版本或支持的其他版本</p>
</li>
<li class="lvl-2">
<p>版本格式：<code>YYYY-MM-DD</code></p>
</li>
<li class="lvl-2">
<p>不兼容时断开连接</p>
</li>
</ul>
<h3 id="能力协商">能力协商</h3>
<p><strong>客户端能力</strong>：</p>
<ul class="lvl-0">
<li class="lvl-2">
<p><code>roots</code>：提供文件系统根目录</p>
</li>
<li class="lvl-2">
<p><code>sampling</code>：支持 LLM 采样请求</p>
</li>
<li class="lvl-2">
<p><code>experimental</code>：实验性功能</p>
</li>
</ul>
<p><strong>服务器能力</strong>：</p>
<ul class="lvl-0">
<li class="lvl-2">
<p><code>tools</code>：提供可调用工具</p>
</li>
<li class="lvl-2">
<p><code>resources</code>：提供可读资源</p>
</li>
<li class="lvl-2">
<p><code>prompts</code>：提供提示模板</p>
</li>
<li class="lvl-2">
<p><code>logging</code>：结构化日志</p>
</li>
<li class="lvl-2">
<p><code>experimental</code>：实验性功能</p>
</li>
</ul>
<hr>
<h2 id="传输机制">传输机制</h2>
<h3 id="标准输入输出-stdio">标准输入输出 (stdio)</h3>
<p>适合本地集成和命令行工具。</p>
<p><strong>特点</strong>：</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>客户端将服务器作为子进程启动</p>
</li>
<li class="lvl-2">
<p>通过 stdin/stdout 传输 JSON-RPC 消息</p>
</li>
<li class="lvl-2">
<p>消息以换行符分隔</p>
</li>
<li class="lvl-2">
<p>stderr 用于日志记录</p>
</li>
</ul>
<p><strong>Python 实现示例</strong>：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># stdio_server.py</span></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">handle_stdin</span>():</span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> sys.stdin:</span><br><span class="line">        line = line.strip()</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> line:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            message = json.loads(line)</span><br><span class="line">            <span class="comment"># 处理消息</span></span><br><span class="line">            response = <span class="keyword">await</span> process_message(message)</span><br><span class="line">            <span class="keyword">if</span> response:</span><br><span class="line">                <span class="built_in">print</span>(json.dumps(response))</span><br><span class="line">                sys.stdout.flush()</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            error = &#123;</span><br><span class="line">                <span class="string">&quot;jsonrpc&quot;</span>: <span class="string">&quot;2.0&quot;</span>,</span><br><span class="line">                <span class="string">&quot;error&quot;</span>: &#123;</span><br><span class="line">                    <span class="string">&quot;code&quot;</span>: -<span class="number">32603</span>,</span><br><span class="line">                    <span class="string">&quot;message&quot;</span>: <span class="built_in">str</span>(e)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">print</span>(json.dumps(error))</span><br><span class="line">            sys.stdout.flush()</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">process_message</span>(<span class="params">message</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;处理 MCP 消息&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> message[<span class="string">&quot;method&quot;</span>] == <span class="string">&quot;initialize&quot;</span>:</span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="string">&quot;jsonrpc&quot;</span>: <span class="string">&quot;2.0&quot;</span>,</span><br><span class="line">            <span class="string">&quot;id&quot;</span>: message[<span class="string">&quot;id&quot;</span>],</span><br><span class="line">            <span class="string">&quot;result&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;protocolVersion&quot;</span>: <span class="string">&quot;2024-11-05&quot;</span>,</span><br><span class="line">                <span class="string">&quot;capabilities&quot;</span>: &#123;<span class="string">&quot;tools&quot;</span>: &#123;&#125;&#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    asyncio.run(handle_stdin())</span><br></pre></td></tr></table></figure>
<h3 id="基于-SSE-的-HTTP">基于 SSE 的 HTTP</h3>
<p>适合远程通信和 Web 应用。</p>
<p><strong>服务器端点</strong>：</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>SSE 端点：接收服务器消息</p>
</li>
<li class="lvl-2">
<p>HTTP POST 端点：发送客户端消息</p>
</li>
</ul>
<p><strong>工作流程</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1. 客户端连接到 SSE 端点</span><br><span class="line">2. 服务器发送 endpoint 事件</span><br><span class="line">3. 客户端使用 POST 端点发送消息</span><br><span class="line">4. 服务器通过 SSE 发送响应</span><br></pre></td></tr></table></figure>
<p><strong>TypeScript 实现示例</strong>：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// http_server.ts</span></span><br><span class="line"><span class="keyword">import</span> &#123; createServer &#125; <span class="keyword">from</span> <span class="string">&#x27;http&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="variable constant_">SSE</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;sse&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> server = <span class="title function_">createServer</span>(<span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (req.<span class="property">url</span> === <span class="string">&#x27;/mcp/sse&#x27;</span>) &#123;</span><br><span class="line">        <span class="comment">// SSE 连接</span></span><br><span class="line">        <span class="keyword">const</span> sse = <span class="keyword">new</span> <span class="title function_">SSE</span>(req, res);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 发送 endpoint 事件</span></span><br><span class="line">        sse.<span class="title function_">send</span>(&#123;</span><br><span class="line">            <span class="attr">event</span>: <span class="string">&#x27;endpoint&#x27;</span>,</span><br><span class="line">            <span class="attr">data</span>: <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(&#123;</span><br><span class="line">                <span class="attr">endpoint</span>: <span class="string">&#x27;/mcp/message&#x27;</span></span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;);</span><br><span class="line">        </span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (req.<span class="property">url</span> === <span class="string">&#x27;/mcp/message&#x27;</span> &amp;&amp; req.<span class="property">method</span> === <span class="string">&#x27;POST&#x27;</span>) &#123;</span><br><span class="line">        <span class="comment">// 处理消息</span></span><br><span class="line">        <span class="keyword">let</span> body = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">        req.<span class="title function_">on</span>(<span class="string">&#x27;data&#x27;</span>, <span class="function"><span class="params">chunk</span> =&gt;</span> body += chunk);</span><br><span class="line">        req.<span class="title function_">on</span>(<span class="string">&#x27;end&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">const</span> message = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(body);</span><br><span class="line">            <span class="title function_">handleMessage</span>(message, res);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">handleMessage</span>(<span class="params"><span class="attr">message</span>: <span class="built_in">any</span>, <span class="attr">res</span>: <span class="built_in">any</span></span>) &#123;</span><br><span class="line">    <span class="comment">// 处理 MCP 消息</span></span><br><span class="line">    <span class="keyword">const</span> response = <span class="title function_">processMessage</span>(message);</span><br><span class="line">    res.<span class="title function_">writeHead</span>(<span class="number">200</span>, &#123; <span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;application/json&#x27;</span> &#125;);</span><br><span class="line">    res.<span class="title function_">end</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(response));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server.<span class="title function_">listen</span>(<span class="number">8080</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;MCP HTTP server running on port 8080&#x27;</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="服务端开发">服务端开发</h2>
<h3 id="核心组件">核心组件</h3>
<h4 id="1-服务器类">1. 服务器类</h4>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> mcp <span class="keyword">import</span> MCPServer</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Dict</span>, <span class="type">Any</span>, <span class="type">Coroutine</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyServer</span>(<span class="title class_ inherited__">MCPServer</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, name: <span class="built_in">str</span>, version: <span class="built_in">str</span></span>):</span><br><span class="line">        <span class="built_in">super</span>().__init__(name=name, version=version)</span><br><span class="line">        <span class="variable language_">self</span>.register_components()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">register_components</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;注册工具、资源和提示词&quot;&quot;&quot;</span></span><br><span class="line">        <span class="variable language_">self</span>.register_tools()</span><br><span class="line">        <span class="variable language_">self</span>.register_resources()</span><br><span class="line">        <span class="variable language_">self</span>.register_prompts()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">register_tools</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;注册工具&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">register_resources</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;注册资源&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">register_prompts</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;注册提示词&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>
<h4 id="2-工具开发">2. 工具开发</h4>
<p><strong>工具注册格式</strong>：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> mcp.types <span class="keyword">import</span> ToolRegistration</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">register_my_tool</span>(<span class="params">server: MCPServer</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;注册自定义工具&quot;&quot;&quot;</span></span><br><span class="line">    tool: ToolRegistration = &#123;</span><br><span class="line">        <span class="string">&quot;name&quot;</span>: <span class="string">&quot;tool_name&quot;</span>,</span><br><span class="line">        <span class="string">&quot;description&quot;</span>: <span class="string">&quot;工具描述&quot;</span>,</span><br><span class="line">        <span class="string">&quot;parameters&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;param1&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;type&quot;</span>: <span class="string">&quot;string&quot;</span>,</span><br><span class="line">                <span class="string">&quot;description&quot;</span>: <span class="string">&quot;参数1描述&quot;</span>,</span><br><span class="line">                <span class="string">&quot;required&quot;</span>: <span class="literal">True</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&quot;param2&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;type&quot;</span>: <span class="string">&quot;number&quot;</span>,</span><br><span class="line">                <span class="string">&quot;description&quot;</span>: <span class="string">&quot;参数2描述&quot;</span>,</span><br><span class="line">                <span class="string">&quot;required&quot;</span>: <span class="literal">False</span>,</span><br><span class="line">                <span class="string">&quot;default&quot;</span>: <span class="number">0</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;handler&quot;</span>: tool_handler</span><br><span class="line">    &#125;</span><br><span class="line">    server.register_tool(tool)</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">tool_handler</span>(<span class="params">parameters: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]</span>) -&gt; <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;工具处理函数&quot;&quot;&quot;</span></span><br><span class="line">    param1 = parameters.get(<span class="string">&quot;param1&quot;</span>)</span><br><span class="line">    param2 = parameters.get(<span class="string">&quot;param2&quot;</span>, <span class="number">0</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 业务逻辑处理</span></span><br><span class="line">    result = process_data(param1, param2)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="string">&quot;success&quot;</span>: <span class="literal">True</span>,</span><br><span class="line">        <span class="string">&quot;result&quot;</span>: result</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p><strong>工具类型</strong>：</p>
<ol>
<li class="lvl-3">
<p><strong>同步工具</strong>：立即返回结果</p>
</li>
<li class="lvl-3">
<p><strong>异步工具</strong>：后台执行，需要轮询状态</p>
</li>
<li class="lvl-3">
<p><strong>事件工具</strong>：执行后发送事件通知</p>
</li>
</ol>
<h4 id="3-资源管理">3. 资源管理</h4>
<p><strong>资源注册示例</strong>：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> mcp.types <span class="keyword">import</span> ResourceRegistration</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">register_config_resource</span>(<span class="params">server: MCPServer</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;注册配置资源&quot;&quot;&quot;</span></span><br><span class="line">    resource: ResourceRegistration = &#123;</span><br><span class="line">        <span class="string">&quot;name&quot;</span>: <span class="string">&quot;config&quot;</span>,</span><br><span class="line">        <span class="string">&quot;uri&quot;</span>: <span class="string">&quot;config://app&quot;</span>,</span><br><span class="line">        <span class="string">&quot;description&quot;</span>: <span class="string">&quot;应用配置资源&quot;</span>,</span><br><span class="line">        <span class="string">&quot;handler&quot;</span>: config_resource_handler</span><br><span class="line">    &#125;</span><br><span class="line">    server.register_resource(resource)</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">config_resource_handler</span>(<span class="params">request: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]</span>) -&gt; <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;资源处理函数&quot;&quot;&quot;</span></span><br><span class="line">    config_data = &#123;</span><br><span class="line">        <span class="string">&quot;app_name&quot;</span>: <span class="string">&quot;My MCP Server&quot;</span>,</span><br><span class="line">        <span class="string">&quot;version&quot;</span>: <span class="string">&quot;1.0.0&quot;</span>,</span><br><span class="line">        <span class="string">&quot;features&quot;</span>: [<span class="string">&quot;tools&quot;</span>, <span class="string">&quot;resources&quot;</span>, <span class="string">&quot;prompts&quot;</span>]</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="string">&quot;contents&quot;</span>: [&#123;<span class="string">&quot;text&quot;</span>: json.dumps(config_data, indent=<span class="number">2</span>)&#125;]</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h4 id="4-提示词管理">4. 提示词管理</h4>
<p><strong>提示词注册示例</strong>：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> mcp.types <span class="keyword">import</span> PromptRegistration</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">register_prompts</span>(<span class="params">server: MCPServer</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;注册提示词&quot;&quot;&quot;</span></span><br><span class="line">    code_reviewer_prompt: PromptRegistration = &#123;</span><br><span class="line">        <span class="string">&quot;name&quot;</span>: <span class="string">&quot;code_reviewer&quot;</span>,</span><br><span class="line">        <span class="string">&quot;description&quot;</span>: <span class="string">&quot;代码审查专家提示词&quot;</span>,</span><br><span class="line">        <span class="string">&quot;parameters&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;language&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;type&quot;</span>: <span class="string">&quot;string&quot;</span>,</span><br><span class="line">                <span class="string">&quot;description&quot;</span>: <span class="string">&quot;编程语言&quot;</span>,</span><br><span class="line">                <span class="string">&quot;required&quot;</span>: <span class="literal">True</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;template&quot;</span>: <span class="string">&quot;&quot;&quot;你是一位专业的&#123;&#123;language&#125;&#125;代码审查专家。</span></span><br><span class="line"><span class="string">请仔细审查以下代码，指出潜在的问题、性能优化点和最佳实践建议。</span></span><br><span class="line"><span class="string">重点关注：</span></span><br><span class="line"><span class="string">1. 代码可读性和维护性</span></span><br><span class="line"><span class="string">2. 潜在的bug和安全问题</span></span><br><span class="line"><span class="string">3. 性能优化机会</span></span><br><span class="line"><span class="string">4. 编码规范符合性&quot;&quot;&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    server.register_prompt(code_reviewer_prompt)</span><br></pre></td></tr></table></figure>
<h3 id="事件系统">事件系统</h3>
<p><strong>事件类型</strong>：</p>
<ul class="lvl-0">
<li class="lvl-2">
<p><code>tool.executed</code>：工具执行完成</p>
</li>
<li class="lvl-2">
<p><code>resource.updated</code>：资源更新</p>
</li>
<li class="lvl-2">
<p><code>session.closed</code>：会话关闭</p>
</li>
<li class="lvl-2">
<p><code>error.occurred</code>：错误发生</p>
</li>
</ul>
<p><strong>事件发送示例</strong>：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">long_running_tool_handler</span>(<span class="params">parameters: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;长时间运行的工具&quot;&quot;&quot;</span></span><br><span class="line">    task_id = <span class="built_in">str</span>(uuid.uuid4())</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 启动后台任务</span></span><br><span class="line">    asyncio.create_task(</span><br><span class="line">        background_task(task_id, parameters)</span><br><span class="line">    )</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="string">&quot;task_id&quot;</span>: task_id,</span><br><span class="line">        <span class="string">&quot;status&quot;</span>: <span class="string">&quot;processing&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">background_task</span>(<span class="params">task_id: <span class="built_in">str</span>, parameters: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;后台任务&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 模拟长时间处理</span></span><br><span class="line">        <span class="keyword">await</span> asyncio.sleep(<span class="number">30</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 任务完成，发送事件</span></span><br><span class="line">        <span class="keyword">await</span> <span class="variable language_">self</span>.send_event(&#123;</span><br><span class="line">            <span class="string">&quot;event_type&quot;</span>: <span class="string">&quot;task.completed&quot;</span>,</span><br><span class="line">            <span class="string">&quot;task_id&quot;</span>: task_id,</span><br><span class="line">            <span class="string">&quot;result&quot;</span>: &#123;<span class="string">&quot;status&quot;</span>: <span class="string">&quot;success&quot;</span>&#125;</span><br><span class="line">        &#125;)</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">await</span> <span class="variable language_">self</span>.send_event(&#123;</span><br><span class="line">            <span class="string">&quot;event_type&quot;</span>: <span class="string">&quot;task.failed&quot;</span>,</span><br><span class="line">            <span class="string">&quot;task_id&quot;</span>: task_id,</span><br><span class="line">            <span class="string">&quot;error&quot;</span>: <span class="built_in">str</span>(e)</span><br><span class="line">        &#125;)</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="客户端开发">客户端开发</h2>
<h3 id="客户端基础">客户端基础</h3>
<h4 id="连接管理">连接管理</h4>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> mcp <span class="keyword">import</span> MCPClient</span><br><span class="line"><span class="keyword">from</span> mcp.types <span class="keyword">import</span> Session</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyMCP客户端</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, host: <span class="built_in">str</span>, port: <span class="built_in">int</span></span>):</span><br><span class="line">        <span class="variable language_">self</span>.client = MCPClient(host=host, port=port)</span><br><span class="line">        <span class="variable language_">self</span>.session: Session = <span class="literal">None</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">connect</span>(<span class="params">self</span>) -&gt; <span class="built_in">bool</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;建立连接&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="variable language_">self</span>.session = <span class="keyword">await</span> <span class="variable language_">self</span>.client.connect()</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;连接失败: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">disconnect</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;断开连接&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.session:</span><br><span class="line">            <span class="keyword">await</span> <span class="variable language_">self</span>.session.close()</span><br><span class="line">            <span class="variable language_">self</span>.session = <span class="literal">None</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">call_tool</span>(<span class="params">self, tool_name: <span class="built_in">str</span>, parameters: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]</span>) -&gt; <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;调用工具&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="variable language_">self</span>.session:</span><br><span class="line">            <span class="keyword">raise</span> Exception(<span class="string">&quot;未建立连接&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">await</span> <span class="variable language_">self</span>.session.call_tool(</span><br><span class="line">            tool_name=tool_name,</span><br><span class="line">            parameters=parameters</span><br><span class="line">        )</span><br></pre></td></tr></table></figure>
<h4 id="异步操作处理">异步操作处理</h4>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">handle_async_tool_call</span>(<span class="params">client: MyMCP客户端, tool_name: <span class="built_in">str</span>, parameters: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;处理异步工具调用&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 调用异步工具</span></span><br><span class="line">        result = <span class="keyword">await</span> client.call_tool(tool_name, parameters)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> result.get(<span class="string">&quot;status&quot;</span>) == <span class="string">&quot;processing&quot;</span>:</span><br><span class="line">            task_id = result.get(<span class="string">&quot;task_id&quot;</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 轮询任务状态</span></span><br><span class="line">            <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">                status = <span class="keyword">await</span> client.call_tool(<span class="string">&quot;get_task_status&quot;</span>, &#123;<span class="string">&quot;task_id&quot;</span>: task_id&#125;)</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span> status.get(<span class="string">&quot;status&quot;</span>) == <span class="string">&quot;completed&quot;</span>:</span><br><span class="line">                    <span class="keyword">return</span> status.get(<span class="string">&quot;result&quot;</span>)</span><br><span class="line">                <span class="keyword">elif</span> status.get(<span class="string">&quot;status&quot;</span>) == <span class="string">&quot;failed&quot;</span>:</span><br><span class="line">                    <span class="keyword">raise</span> Exception(status.get(<span class="string">&quot;error&quot;</span>))</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">await</span> asyncio.sleep(<span class="number">2</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> result</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;工具调用失败: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">raise</span></span><br></pre></td></tr></table></figure>
<h4 id="事件订阅">事件订阅</h4>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">subscribe_to_events</span>(<span class="params">client: MyMCP客户端</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;订阅服务器事件&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">for</span> event <span class="keyword">in</span> client.session.events():</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            event_data = json.loads(event.data)</span><br><span class="line">            event_type = event_data.get(<span class="string">&quot;event_type&quot;</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> event_type == <span class="string">&quot;task.completed&quot;</span>:</span><br><span class="line">                handle_task_completed(event_data)</span><br><span class="line">            <span class="keyword">elif</span> event_type == <span class="string">&quot;resource.updated&quot;</span>:</span><br><span class="line">                handle_resource_updated(event_data)</span><br><span class="line">                </span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;处理事件失败: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">handle_task_completed</span>(<span class="params">event_data: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;处理任务完成事件&quot;&quot;&quot;</span></span><br><span class="line">    task_id = event_data.get(<span class="string">&quot;task_id&quot;</span>)</span><br><span class="line">    result = event_data.get(<span class="string">&quot;result&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;任务 <span class="subst">&#123;task_id&#125;</span> 完成: <span class="subst">&#123;result&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="实战示例">实战示例</h2>
<h3 id="示例-1-文件管理器服务器">示例 1: 文件管理器服务器</h3>
<p><strong>功能需求</strong>：</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>列出目录内容</p>
</li>
<li class="lvl-2">
<p>读取文件内容</p>
</li>
<li class="lvl-2">
<p>创建和修改文件</p>
</li>
<li class="lvl-2">
<p>删除文件和目录</p>
</li>
</ul>
<p><strong>实现代码</strong>：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># file_manager_server.py</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">from</span> mcp <span class="keyword">import</span> MCPServer</span><br><span class="line"><span class="keyword">from</span> mcp.types <span class="keyword">import</span> ToolRegistration, ResourceRegistration</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">FileManagerServer</span>(<span class="title class_ inherited__">MCPServer</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">super</span>().__init__(name=<span class="string">&quot;FileManagerServer&quot;</span>, version=<span class="string">&quot;1.0.0&quot;</span>)</span><br><span class="line">        <span class="variable language_">self</span>.register_tools()</span><br><span class="line">        <span class="variable language_">self</span>.register_resources()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">register_tools</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;注册文件管理工具&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># 列出目录工具</span></span><br><span class="line">        list_dir_tool: ToolRegistration = &#123;</span><br><span class="line">            <span class="string">&quot;name&quot;</span>: <span class="string">&quot;list_directory&quot;</span>,</span><br><span class="line">            <span class="string">&quot;description&quot;</span>: <span class="string">&quot;列出指定目录的内容&quot;</span>,</span><br><span class="line">            <span class="string">&quot;parameters&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;path&quot;</span>: &#123;</span><br><span class="line">                    <span class="string">&quot;type&quot;</span>: <span class="string">&quot;string&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;description&quot;</span>: <span class="string">&quot;目录路径&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;required&quot;</span>: <span class="literal">True</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&quot;handler&quot;</span>: <span class="variable language_">self</span>.handle_list_directory</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable language_">self</span>.register_tool(list_dir_tool)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 读取文件工具</span></span><br><span class="line">        read_file_tool: ToolRegistration = &#123;</span><br><span class="line">            <span class="string">&quot;name&quot;</span>: <span class="string">&quot;read_file&quot;</span>,</span><br><span class="line">            <span class="string">&quot;description&quot;</span>: <span class="string">&quot;读取文件内容&quot;</span>,</span><br><span class="line">            <span class="string">&quot;parameters&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;path&quot;</span>: &#123;</span><br><span class="line">                    <span class="string">&quot;type&quot;</span>: <span class="string">&quot;string&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;description&quot;</span>: <span class="string">&quot;文件路径&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;required&quot;</span>: <span class="literal">True</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&quot;handler&quot;</span>: <span class="variable language_">self</span>.handle_read_file</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable language_">self</span>.register_tool(read_file_tool)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 写入文件工具</span></span><br><span class="line">        write_file_tool: ToolRegistration = &#123;</span><br><span class="line">            <span class="string">&quot;name&quot;</span>: <span class="string">&quot;write_file&quot;</span>,</span><br><span class="line">            <span class="string">&quot;description&quot;</span>: <span class="string">&quot;写入文件内容&quot;</span>,</span><br><span class="line">            <span class="string">&quot;parameters&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;path&quot;</span>: &#123;</span><br><span class="line">                    <span class="string">&quot;type&quot;</span>: <span class="string">&quot;string&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;description&quot;</span>: <span class="string">&quot;文件路径&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;required&quot;</span>: <span class="literal">True</span></span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="string">&quot;content&quot;</span>: &#123;</span><br><span class="line">                    <span class="string">&quot;type&quot;</span>: <span class="string">&quot;string&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;description&quot;</span>: <span class="string">&quot;文件内容&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;required&quot;</span>: <span class="literal">True</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&quot;handler&quot;</span>: <span class="variable language_">self</span>.handle_write_file</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable language_">self</span>.register_tool(write_file_tool)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">register_resources</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;注册文件系统资源&quot;&quot;&quot;</span></span><br><span class="line">        file_resource: ResourceRegistration = &#123;</span><br><span class="line">            <span class="string">&quot;name&quot;</span>: <span class="string">&quot;file&quot;</span>,</span><br><span class="line">            <span class="string">&quot;uri&quot;</span>: <span class="string">&quot;file://&quot;</span>,</span><br><span class="line">            <span class="string">&quot;description&quot;</span>: <span class="string">&quot;文件系统资源&quot;</span>,</span><br><span class="line">            <span class="string">&quot;handler&quot;</span>: <span class="variable language_">self</span>.handle_file_resource</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable language_">self</span>.register_resource(file_resource)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">handle_list_directory</span>(<span class="params">self, parameters</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;处理列出目录请求&quot;&quot;&quot;</span></span><br><span class="line">        path = parameters.get(<span class="string">&quot;path&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> os.path.isdir(path):</span><br><span class="line">                <span class="keyword">return</span> &#123;<span class="string">&quot;error&quot;</span>: <span class="string">f&quot;路径 <span class="subst">&#123;path&#125;</span> 不是目录&quot;</span>&#125;</span><br><span class="line">            </span><br><span class="line">            items = os.listdir(path)</span><br><span class="line">            result = []</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">for</span> item <span class="keyword">in</span> items:</span><br><span class="line">                item_path = os.path.join(path, item)</span><br><span class="line">                result.append(&#123;</span><br><span class="line">                    <span class="string">&quot;name&quot;</span>: item,</span><br><span class="line">                    <span class="string">&quot;type&quot;</span>: <span class="string">&quot;directory&quot;</span> <span class="keyword">if</span> os.path.isdir(item_path) <span class="keyword">else</span> <span class="string">&quot;file&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;size&quot;</span>: os.path.getsize(item_path) <span class="keyword">if</span> os.path.isfile(item_path) <span class="keyword">else</span> <span class="literal">None</span></span><br><span class="line">                &#125;)</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> &#123;<span class="string">&quot;contents&quot;</span>: result&#125;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">return</span> &#123;<span class="string">&quot;error&quot;</span>: <span class="built_in">str</span>(e)&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">handle_read_file</span>(<span class="params">self, parameters</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;处理读取文件请求&quot;&quot;&quot;</span></span><br><span class="line">        path = parameters.get(<span class="string">&quot;path&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> os.path.isfile(path):</span><br><span class="line">                <span class="keyword">return</span> &#123;<span class="string">&quot;error&quot;</span>: <span class="string">f&quot;文件 <span class="subst">&#123;path&#125;</span> 不存在&quot;</span>&#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">with</span> <span class="built_in">open</span>(path, <span class="string">&#x27;r&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">                content = f.read()</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> &#123;<span class="string">&quot;content&quot;</span>: content&#125;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">return</span> &#123;<span class="string">&quot;error&quot;</span>: <span class="built_in">str</span>(e)&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">handle_write_file</span>(<span class="params">self, parameters</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;处理写入文件请求&quot;&quot;&quot;</span></span><br><span class="line">        path = parameters.get(<span class="string">&quot;path&quot;</span>)</span><br><span class="line">        content = parameters.get(<span class="string">&quot;content&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">with</span> <span class="built_in">open</span>(path, <span class="string">&#x27;w&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">                f.write(content)</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> &#123;<span class="string">&quot;success&quot;</span>: <span class="literal">True</span>, <span class="string">&quot;message&quot;</span>: <span class="string">f&quot;文件 <span class="subst">&#123;path&#125;</span> 写入成功&quot;</span>&#125;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">return</span> &#123;<span class="string">&quot;error&quot;</span>: <span class="built_in">str</span>(e)&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">handle_file_resource</span>(<span class="params">self, request</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;处理文件资源请求&quot;&quot;&quot;</span></span><br><span class="line">        uri = request.get(<span class="string">&quot;uri&quot;</span>)</span><br><span class="line">        path = uri.replace(<span class="string">&quot;file://&quot;</span>, <span class="string">&quot;&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">if</span> os.path.isfile(path):</span><br><span class="line">                <span class="keyword">with</span> <span class="built_in">open</span>(path, <span class="string">&#x27;r&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">                    content = f.read()</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">return</span> &#123;</span><br><span class="line">                    <span class="string">&quot;contents&quot;</span>: [&#123;<span class="string">&quot;text&quot;</span>: content&#125;]</span><br><span class="line">                &#125;</span><br><span class="line">            <span class="keyword">elif</span> os.path.isdir(path):</span><br><span class="line">                items = os.listdir(path)</span><br><span class="line">                directory_info = json.dumps(&#123;</span><br><span class="line">                    <span class="string">&quot;type&quot;</span>: <span class="string">&quot;directory&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;items&quot;</span>: items</span><br><span class="line">                &#125;, indent=<span class="number">2</span>)</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">return</span> &#123;</span><br><span class="line">                    <span class="string">&quot;contents&quot;</span>: [&#123;<span class="string">&quot;text&quot;</span>: directory_info&#125;]</span><br><span class="line">                &#125;</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">return</span> &#123;</span><br><span class="line">                    <span class="string">&quot;error&quot;</span>: <span class="string">f&quot;路径 <span class="subst">&#123;path&#125;</span> 不存在&quot;</span></span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">return</span> &#123;</span><br><span class="line">                <span class="string">&quot;error&quot;</span>: <span class="built_in">str</span>(e)</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    server = FileManagerServer()</span><br><span class="line">    server.run(host=<span class="string">&quot;0.0.0.0&quot;</span>, port=<span class="number">8080</span>)</span><br></pre></td></tr></table></figure>
<h3 id="示例-2-天气查询服务器">示例 2: 天气查询服务器</h3>
<p><strong>功能需求</strong>：</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>获取实时天气信息</p>
</li>
<li class="lvl-2">
<p>获取天气预报</p>
</li>
<li class="lvl-2">
<p>支持多个城市</p>
</li>
<li class="lvl-2">
<p>缓存查询结果</p>
</li>
</ul>
<p><strong>实现代码</strong>：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># weather_server.py</span></span><br><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> aiohttp</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> mcp <span class="keyword">import</span> MCPServer</span><br><span class="line"><span class="keyword">from</span> mcp.types <span class="keyword">import</span> ToolRegistration</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">WeatherServer</span>(<span class="title class_ inherited__">MCPServer</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">super</span>().__init__(name=<span class="string">&quot;WeatherServer&quot;</span>, version=<span class="string">&quot;1.0.0&quot;</span>)</span><br><span class="line">        <span class="variable language_">self</span>.api_key = <span class="string">&quot;your_api_key&quot;</span>  <span class="comment"># 替换为实际的API密钥</span></span><br><span class="line">        <span class="variable language_">self</span>.cache = &#123;&#125;</span><br><span class="line">        <span class="variable language_">self</span>.cache_ttl = <span class="number">3600</span>  <span class="comment"># 缓存有效期1小时</span></span><br><span class="line">        <span class="variable language_">self</span>.register_tools()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">register_tools</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;注册天气查询工具&quot;&quot;&quot;</span></span><br><span class="line">        current_weather_tool: ToolRegistration = &#123;</span><br><span class="line">            <span class="string">&quot;name&quot;</span>: <span class="string">&quot;get_current_weather&quot;</span>,</span><br><span class="line">            <span class="string">&quot;description&quot;</span>: <span class="string">&quot;获取指定城市的实时天气&quot;</span>,</span><br><span class="line">            <span class="string">&quot;parameters&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;city&quot;</span>: &#123;</span><br><span class="line">                    <span class="string">&quot;type&quot;</span>: <span class="string">&quot;string&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;description&quot;</span>: <span class="string">&quot;城市名称&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;required&quot;</span>: <span class="literal">True</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&quot;handler&quot;</span>: <span class="variable language_">self</span>.handle_get_current_weather</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable language_">self</span>.register_tool(current_weather_tool)</span><br><span class="line">        </span><br><span class="line">        forecast_tool: ToolRegistration = &#123;</span><br><span class="line">            <span class="string">&quot;name&quot;</span>: <span class="string">&quot;get_weather_forecast&quot;</span>,</span><br><span class="line">            <span class="string">&quot;description&quot;</span>: <span class="string">&quot;获取指定城市的天气预报&quot;</span>,</span><br><span class="line">            <span class="string">&quot;parameters&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;city&quot;</span>: &#123;</span><br><span class="line">                    <span class="string">&quot;type&quot;</span>: <span class="string">&quot;string&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;description&quot;</span>: <span class="string">&quot;城市名称&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;required&quot;</span>: <span class="literal">True</span></span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="string">&quot;days&quot;</span>: &#123;</span><br><span class="line">                    <span class="string">&quot;type&quot;</span>: <span class="string">&quot;integer&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;description&quot;</span>: <span class="string">&quot;预报天数&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;required&quot;</span>: <span class="literal">False</span>,</span><br><span class="line">                    <span class="string">&quot;default&quot;</span>: <span class="number">3</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&quot;handler&quot;</span>: <span class="variable language_">self</span>.handle_get_weather_forecast</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable language_">self</span>.register_tool(forecast_tool)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">get_weather_from_api</span>(<span class="params">self, city: <span class="built_in">str</span>, forecast: <span class="built_in">bool</span> = <span class="literal">False</span>, days: <span class="built_in">int</span> = <span class="number">3</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;从API获取天气数据&quot;&quot;&quot;</span></span><br><span class="line">        cache_key = <span class="string">f&quot;<span class="subst">&#123;city&#125;</span>:<span class="subst">&#123;forecast&#125;</span>:<span class="subst">&#123;days&#125;</span>&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 检查缓存</span></span><br><span class="line">        <span class="keyword">if</span> cache_key <span class="keyword">in</span> <span class="variable language_">self</span>.cache:</span><br><span class="line">            cached_data, timestamp = <span class="variable language_">self</span>.cache[cache_key]</span><br><span class="line">            <span class="keyword">if</span> time.time() - timestamp &lt; <span class="variable language_">self</span>.cache_ttl:</span><br><span class="line">                <span class="keyword">return</span> cached_data</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 构建API请求</span></span><br><span class="line">        base_url = <span class="string">&quot;https://api.weatherapi.com/v1/&quot;</span></span><br><span class="line">        endpoint = <span class="string">&quot;forecast.json&quot;</span> <span class="keyword">if</span> forecast <span class="keyword">else</span> <span class="string">&quot;current.json&quot;</span></span><br><span class="line">        </span><br><span class="line">        params = &#123;</span><br><span class="line">            <span class="string">&quot;key&quot;</span>: <span class="variable language_">self</span>.api_key,</span><br><span class="line">            <span class="string">&quot;q&quot;</span>: city,</span><br><span class="line">            <span class="string">&quot;days&quot;</span>: days</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">async</span> <span class="keyword">with</span> aiohttp.ClientSession() <span class="keyword">as</span> session:</span><br><span class="line">            <span class="keyword">async</span> <span class="keyword">with</span> session.get(<span class="string">f&quot;<span class="subst">&#123;base_url&#125;</span><span class="subst">&#123;endpoint&#125;</span>&quot;</span>, params=params) <span class="keyword">as</span> response:</span><br><span class="line">                <span class="keyword">if</span> response.status != <span class="number">200</span>:</span><br><span class="line">                    <span class="keyword">raise</span> Exception(<span class="string">f&quot;API请求失败: <span class="subst">&#123;response.status&#125;</span>&quot;</span>)</span><br><span class="line">                </span><br><span class="line">                data = <span class="keyword">await</span> response.json()</span><br><span class="line">                </span><br><span class="line">                <span class="comment"># 更新缓存</span></span><br><span class="line">                <span class="variable language_">self</span>.cache[cache_key] = (data, time.time())</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">return</span> data</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">handle_get_current_weather</span>(<span class="params">self, parameters</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;处理实时天气查询&quot;&quot;&quot;</span></span><br><span class="line">        city = parameters.get(<span class="string">&quot;city&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            weather_data = <span class="keyword">await</span> <span class="variable language_">self</span>.get_weather_from_api(city)</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> &#123;</span><br><span class="line">                <span class="string">&quot;city&quot;</span>: city,</span><br><span class="line">                <span class="string">&quot;temperature&quot;</span>: weather_data[<span class="string">&quot;current&quot;</span>][<span class="string">&quot;temp_c&quot;</span>],</span><br><span class="line">                <span class="string">&quot;condition&quot;</span>: weather_data[<span class="string">&quot;current&quot;</span>][<span class="string">&quot;condition&quot;</span>][<span class="string">&quot;text&quot;</span>],</span><br><span class="line">                <span class="string">&quot;humidity&quot;</span>: weather_data[<span class="string">&quot;current&quot;</span>][<span class="string">&quot;humidity&quot;</span>],</span><br><span class="line">                <span class="string">&quot;wind_speed&quot;</span>: weather_data[<span class="string">&quot;current&quot;</span>][<span class="string">&quot;wind_kph&quot;</span>],</span><br><span class="line">                <span class="string">&quot;last_updated&quot;</span>: weather_data[<span class="string">&quot;current&quot;</span>][<span class="string">&quot;last_updated&quot;</span>]</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">return</span> &#123;<span class="string">&quot;error&quot;</span>: <span class="built_in">str</span>(e)&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">handle_get_weather_forecast</span>(<span class="params">self, parameters</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;处理天气预报查询&quot;&quot;&quot;</span></span><br><span class="line">        city = parameters.get(<span class="string">&quot;city&quot;</span>)</span><br><span class="line">        days = parameters.get(<span class="string">&quot;days&quot;</span>, <span class="number">3</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            weather_data = <span class="keyword">await</span> <span class="variable language_">self</span>.get_weather_from_api(city, forecast=<span class="literal">True</span>, days=days)</span><br><span class="line">            </span><br><span class="line">            forecast = []</span><br><span class="line">            <span class="keyword">for</span> day <span class="keyword">in</span> weather_data[<span class="string">&quot;forecast&quot;</span>][<span class="string">&quot;forecastday&quot;</span>]:</span><br><span class="line">                forecast.append(&#123;</span><br><span class="line">                    <span class="string">&quot;date&quot;</span>: day[<span class="string">&quot;date&quot;</span>],</span><br><span class="line">                    <span class="string">&quot;max_temp&quot;</span>: day[<span class="string">&quot;day&quot;</span>][<span class="string">&quot;maxtemp_c&quot;</span>],</span><br><span class="line">                    <span class="string">&quot;min_temp&quot;</span>: day[<span class="string">&quot;day&quot;</span>][<span class="string">&quot;mintemp_c&quot;</span>],</span><br><span class="line">                    <span class="string">&quot;condition&quot;</span>: day[<span class="string">&quot;day&quot;</span>][<span class="string">&quot;condition&quot;</span>][<span class="string">&quot;text&quot;</span>],</span><br><span class="line">                    <span class="string">&quot;precipitation&quot;</span>: day[<span class="string">&quot;day&quot;</span>][<span class="string">&quot;totalprecip_mm&quot;</span>]</span><br><span class="line">                &#125;)</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> &#123;</span><br><span class="line">                <span class="string">&quot;city&quot;</span>: city,</span><br><span class="line">                <span class="string">&quot;forecast&quot;</span>: forecast,</span><br><span class="line">                <span class="string">&quot;last_updated&quot;</span>: weather_data[<span class="string">&quot;current&quot;</span>][<span class="string">&quot;last_updated&quot;</span>]</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">return</span> &#123;<span class="string">&quot;error&quot;</span>: <span class="built_in">str</span>(e)&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    server = WeatherServer()</span><br><span class="line">    server.run(host=<span class="string">&quot;0.0.0.0&quot;</span>, port=<span class="number">8081</span>)</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="调试与测试">调试与测试</h2>
<h3 id="MCP-检查器">MCP 检查器</h3>
<p>使用官方 MCP Inspector 工具进行调试：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装 MCP Inspector</span></span><br><span class="line">npm install -g @modelcontextprotocol/inspector</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动检查器</span></span><br><span class="line">mcp-inspector --server http://localhost:8080</span><br></pre></td></tr></table></figure>
<h3 id="日志配置">日志配置</h3>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">setup_logging</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;设置日志配置&quot;&quot;&quot;</span></span><br><span class="line">    log_dir = <span class="string">&quot;logs&quot;</span></span><br><span class="line">    os.makedirs(log_dir, exist_ok=<span class="literal">True</span>)</span><br><span class="line">    </span><br><span class="line">    log_file = os.path.join(</span><br><span class="line">        log_dir,</span><br><span class="line">        <span class="string">f&quot;mcp-server-<span class="subst">&#123;datetime.now().strftime(<span class="string">&#x27;%Y%m%d&#x27;</span>)&#125;</span>.log&quot;</span></span><br><span class="line">    )</span><br><span class="line">    </span><br><span class="line">    logging.basicConfig(</span><br><span class="line">        level=logging.INFO,</span><br><span class="line">        <span class="built_in">format</span>=<span class="string">&quot;%(asctime)s [%(levelname)s] %(name)s:%(lineno)d - %(message)s&quot;</span>,</span><br><span class="line">        handlers=[</span><br><span class="line">            logging.FileHandler(log_file, encoding=<span class="string">&#x27;utf-8&#x27;</span>),</span><br><span class="line">            logging.StreamHandler()</span><br><span class="line">        ]</span><br><span class="line">    )</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> logging.getLogger(<span class="string">&quot;mcp-server&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在服务器中使用</span></span><br><span class="line">logger = setup_logging()</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyServer</span>(<span class="title class_ inherited__">MCPServer</span>):</span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">handle_say_hello</span>(<span class="params">self, parameters</span>):</span><br><span class="line">        logger.info(<span class="string">f&quot;处理打招呼请求: <span class="subst">&#123;parameters&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            name = parameters.get(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;World&quot;</span>)</span><br><span class="line">            result = &#123;<span class="string">&quot;message&quot;</span>: <span class="string">f&quot;Hello, <span class="subst">&#123;name&#125;</span>!&quot;</span>&#125;</span><br><span class="line">            logger.info(<span class="string">f&quot;请求处理成功: <span class="subst">&#123;result&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> result</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            logger.error(<span class="string">f&quot;请求处理失败: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">raise</span></span><br></pre></td></tr></table></figure>
<h3 id="单元测试">单元测试</h3>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># tests/test_server.py</span></span><br><span class="line"><span class="keyword">import</span> pytest</span><br><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">from</span> unittest.mock <span class="keyword">import</span> Mock, patch</span><br><span class="line"><span class="keyword">from</span> my_server <span class="keyword">import</span> MyServer</span><br><span class="line"></span><br><span class="line"><span class="meta">@pytest.mark.asyncio</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">test_say_hello_tool</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;测试打招呼工具&quot;&quot;&quot;</span></span><br><span class="line">    server = MyServer()</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 测试正常情况</span></span><br><span class="line">    result = <span class="keyword">await</span> server.handle_say_hello(&#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;Test User&quot;</span>&#125;)</span><br><span class="line">    <span class="keyword">assert</span> result == &#123;<span class="string">&quot;message&quot;</span>: <span class="string">&quot;Hello, Test User!&quot;</span>&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 测试默认值</span></span><br><span class="line">    result = <span class="keyword">await</span> server.handle_say_hello(&#123;&#125;)</span><br><span class="line">    <span class="keyword">assert</span> result == &#123;<span class="string">&quot;message&quot;</span>: <span class="string">&quot;Hello, World!&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@pytest.mark.asyncio</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">test_file_manager_list_directory</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;测试文件管理器的列出目录功能&quot;&quot;&quot;</span></span><br><span class="line">    server = FileManagerServer()</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 测试存在的目录</span></span><br><span class="line">    result = <span class="keyword">await</span> server.handle_list_directory(&#123;<span class="string">&quot;path&quot;</span>: <span class="string">&quot;.&quot;</span>&#125;)</span><br><span class="line">    <span class="keyword">assert</span> <span class="string">&quot;contents&quot;</span> <span class="keyword">in</span> result</span><br><span class="line">    <span class="keyword">assert</span> <span class="built_in">isinstance</span>(result[<span class="string">&quot;contents&quot;</span>], <span class="built_in">list</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 测试不存在的目录</span></span><br><span class="line">    result = <span class="keyword">await</span> server.handle_list_directory(&#123;<span class="string">&quot;path&quot;</span>: <span class="string">&quot;/nonexistent&quot;</span>&#125;)</span><br><span class="line">    <span class="keyword">assert</span> <span class="string">&quot;error&quot;</span> <span class="keyword">in</span> result</span><br></pre></td></tr></table></figure>
<h3 id="集成测试">集成测试</h3>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># tests/test_integration.py</span></span><br><span class="line"><span class="keyword">import</span> pytest</span><br><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">from</span> mcp <span class="keyword">import</span> MCPClient</span><br><span class="line"></span><br><span class="line"><span class="meta">@pytest.mark.asyncio</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">test_server_integration</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;测试服务器集成功能&quot;&quot;&quot;</span></span><br><span class="line">    client = MCPClient(host=<span class="string">&quot;localhost&quot;</span>, port=<span class="number">8080</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 连接服务器</span></span><br><span class="line">        session = <span class="keyword">await</span> client.connect()</span><br><span class="line">        <span class="keyword">assert</span> session <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 测试工具调用</span></span><br><span class="line">        result = <span class="keyword">await</span> session.call_tool(</span><br><span class="line">            tool_name=<span class="string">&quot;say_hello&quot;</span>,</span><br><span class="line">            parameters=&#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;Integration Test&quot;</span>&#125;</span><br><span class="line">        )</span><br><span class="line">        <span class="keyword">assert</span> result == &#123;<span class="string">&quot;message&quot;</span>: <span class="string">&quot;Hello, Integration Test!&quot;</span>&#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 测试资源访问</span></span><br><span class="line">        resource_result = <span class="keyword">await</span> session.get_resource(<span class="string">&quot;config://app&quot;</span>)</span><br><span class="line">        <span class="keyword">assert</span> <span class="string">&quot;contents&quot;</span> <span class="keyword">in</span> resource_result</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        <span class="keyword">await</span> client.disconnect()</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="部署指南">部署指南</h2>
<h3 id="Docker-容器化">Docker 容器化</h3>
<h4 id="Dockerfile">Dockerfile</h4>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> python:<span class="number">3.12</span>-slim</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置工作目录</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /app</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装系统依赖</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apt-get update &amp;&amp; apt-get install -y \</span></span><br><span class="line"><span class="language-bash">    build-essential \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; <span class="built_in">rm</span> -rf /var/lib/apt/lists/*</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置 Python 环境</span></span><br><span class="line"><span class="keyword">ENV</span> PYTHONDONTWRITEBYTECODE=<span class="number">1</span></span><br><span class="line"><span class="keyword">ENV</span> PYTHONUNBUFFERED=<span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装依赖</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> requirements.txt .</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> pip install --no-cache-dir -r requirements.txt</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 复制项目文件</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> src/ ./src/</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建非 root 用户</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> useradd -m appuser</span></span><br><span class="line"><span class="keyword">USER</span> appuser</span><br><span class="line"></span><br><span class="line"><span class="comment"># 暴露端口</span></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">8080</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 健康检查</span></span><br><span class="line"><span class="keyword">HEALTHCHECK</span><span class="language-bash"> --interval=30s --<span class="built_in">timeout</span>=10s --start-period=5s --retries=3 \</span></span><br><span class="line"><span class="language-bash">    CMD curl -f http://localhost:8080/health || <span class="built_in">exit</span> 1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动命令</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [<span class="string">&quot;python&quot;</span>, <span class="string">&quot;src/server.py&quot;</span>, <span class="string">&quot;--host&quot;</span>, <span class="string">&quot;0.0.0.0&quot;</span>, <span class="string">&quot;--port&quot;</span>, <span class="string">&quot;8080&quot;</span>]</span></span><br></pre></td></tr></table></figure>
<h4 id="Docker-Compose">Docker Compose</h4>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3.8&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">mcp-server:</span></span><br><span class="line">    <span class="attr">build:</span> <span class="string">.</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">mcp-server</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">unless-stopped</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;8080:8080&quot;</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">NODE_ENV=production</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">MCP_PORT=8080</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">API_KEY=$&#123;API_KEY&#125;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./data:/app/data</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./logs:/app/logs</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">mcp-network</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">nginx-proxy:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx:alpine</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">mcp-nginx</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">unless-stopped</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;80:80&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;443:443&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./nginx/conf.d:/etc/nginx/conf.d</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./nginx/ssl:/etc/nginx/ssl</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">mcp-server</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">mcp-network</span></span><br><span class="line"></span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line">  <span class="attr">mcp-network:</span></span><br><span class="line">    <span class="attr">driver:</span> <span class="string">bridge</span></span><br></pre></td></tr></table></figure>
<h3 id="Kubernetes-部署">Kubernetes 部署</h3>
<h4 id="Deployment">Deployment</h4>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mcp-server</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">mcp-system</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">mcp-server</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">mcp-server</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mcp-server</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">your-registry/mcp-server:latest</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8080</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">&quot;256Mi&quot;</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">&quot;250m&quot;</span></span><br><span class="line">          <span class="attr">limits:</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">&quot;512Mi&quot;</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">&quot;500m&quot;</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NODE_ENV</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;production&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MCP_PORT</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;8080&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">API_KEY</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">secretKeyRef:</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">mcp-secrets</span></span><br><span class="line">              <span class="attr">key:</span> <span class="string">api-key</span></span><br><span class="line">        <span class="attr">readinessProbe:</span></span><br><span class="line">          <span class="attr">httpGet:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/health</span></span><br><span class="line">            <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">          <span class="attr">initialDelaySeconds:</span> <span class="number">5</span></span><br><span class="line">          <span class="attr">periodSeconds:</span> <span class="number">10</span></span><br><span class="line">        <span class="attr">livenessProbe:</span></span><br><span class="line">          <span class="attr">httpGet:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/health</span></span><br><span class="line">            <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">          <span class="attr">initialDelaySeconds:</span> <span class="number">15</span></span><br><span class="line">          <span class="attr">periodSeconds:</span> <span class="number">20</span></span><br></pre></td></tr></table></figure>
<h4 id="Service">Service</h4>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mcp-server-service</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">mcp-system</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">mcp-server</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">8080</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br></pre></td></tr></table></figure>
<h4 id="Ingress">Ingress</h4>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mcp-server-ingress</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">mcp-system</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/rewrite-target:</span> <span class="string">/</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/ssl-redirect:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">tls:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">hosts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">mcp.yourdomain.com</span></span><br><span class="line">    <span class="attr">secretName:</span> <span class="string">mcp-tls-secret</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">mcp.yourdomain.com</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">        <span class="attr">pathType:</span> <span class="string">Prefix</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">service:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">mcp-server-service</span></span><br><span class="line">            <span class="attr">port:</span></span><br><span class="line">              <span class="attr">number:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>
<h3 id="云服务部署">云服务部署</h3>
<h4 id="AWS-ECS-部署">AWS ECS 部署</h4>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># task-definition.json</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;family&quot;:</span> <span class="string">&quot;mcp-server&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;networkMode&quot;:</span> <span class="string">&quot;awsvpc&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;requiresCompatibilities&quot;:</span> [<span class="string">&quot;FARGATE&quot;</span>],</span><br><span class="line">  <span class="attr">&quot;cpu&quot;:</span> <span class="string">&quot;256&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;memory&quot;:</span> <span class="string">&quot;512&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;executionRoleArn&quot;:</span> <span class="string">&quot;arn:aws:iam::your-account:role/ecs-execution-role&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;containerDefinitions&quot;:</span> [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;name&quot;:</span> <span class="string">&quot;mcp-server&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;image&quot;:</span> <span class="string">&quot;your-account.dkr.ecr.region.amazonaws.com/mcp-server:latest&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;portMappings&quot;:</span> [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">&quot;containerPort&quot;:</span> <span class="number">8080</span>,</span><br><span class="line">          <span class="attr">&quot;protocol&quot;:</span> <span class="string">&quot;tcp&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">      ],</span><br><span class="line">      <span class="attr">&quot;environment&quot;:</span> [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">&quot;name&quot;:</span> <span class="string">&quot;NODE_ENV&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;value&quot;:</span> <span class="string">&quot;production&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">&quot;name&quot;:</span> <span class="string">&quot;MCP_PORT&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;value&quot;:</span> <span class="string">&quot;8080&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">      ],</span><br><span class="line">      <span class="attr">&quot;logConfiguration&quot;:</span> &#123;</span><br><span class="line">        <span class="attr">&quot;logDriver&quot;:</span> <span class="string">&quot;awslogs&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;options&quot;:</span> &#123;</span><br><span class="line">          <span class="attr">&quot;awslogs-group&quot;:</span> <span class="string">&quot;/ecs/mcp-server&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;awslogs-region&quot;:</span> <span class="string">&quot;us-east-1&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;awslogs-stream-prefix&quot;:</span> <span class="string">&quot;ecs&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="最佳实践">最佳实践</h2>
<h3 id="安全最佳实践">安全最佳实践</h3>
<h4 id="1-身份认证与授权">1. 身份认证与授权</h4>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> mcp <span class="keyword">import</span> MCPServer</span><br><span class="line"><span class="keyword">import</span> jwt</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime, timedelta</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SecureServer</span>(<span class="title class_ inherited__">MCPServer</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, secret_key: <span class="built_in">str</span></span>):</span><br><span class="line">        <span class="built_in">super</span>().__init__(name=<span class="string">&quot;SecureServer&quot;</span>, version=<span class="string">&quot;1.0.0&quot;</span>)</span><br><span class="line">        <span class="variable language_">self</span>.secret_key = secret_key</span><br><span class="line">        <span class="variable language_">self</span>.register_middleware(<span class="variable language_">self</span>.auth_middleware)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">auth_middleware</span>(<span class="params">self, request, next_handler</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;认证中间件&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># 跳过初始化请求的认证</span></span><br><span class="line">        <span class="keyword">if</span> request.method == <span class="string">&quot;initialize&quot;</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">await</span> next_handler(request)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 获取认证令牌</span></span><br><span class="line">        auth_header = request.headers.get(<span class="string">&quot;Authorization&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> auth_header <span class="keyword">or</span> <span class="keyword">not</span> auth_header.startswith(<span class="string">&quot;Bearer &quot;</span>):</span><br><span class="line">            <span class="keyword">return</span> &#123;</span><br><span class="line">                <span class="string">&quot;jsonrpc&quot;</span>: <span class="string">&quot;2.0&quot;</span>,</span><br><span class="line">                <span class="string">&quot;error&quot;</span>: &#123;</span><br><span class="line">                    <span class="string">&quot;code&quot;</span>: -<span class="number">32602</span>,</span><br><span class="line">                    <span class="string">&quot;message&quot;</span>: <span class="string">&quot;缺少认证令牌&quot;</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        </span><br><span class="line">        token = auth_header.split(<span class="string">&quot; &quot;</span>)[<span class="number">1</span>]</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># 验证令牌</span></span><br><span class="line">            payload = jwt.decode(</span><br><span class="line">                token, </span><br><span class="line">                <span class="variable language_">self</span>.secret_key, </span><br><span class="line">                algorithms=[<span class="string">&quot;HS256&quot;</span>]</span><br><span class="line">            )</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 检查令牌过期时间</span></span><br><span class="line">            <span class="keyword">if</span> payload.get(<span class="string">&quot;exp&quot;</span>) &lt; datetime.utcnow().timestamp():</span><br><span class="line">                <span class="keyword">return</span> &#123;</span><br><span class="line">                    <span class="string">&quot;jsonrpc&quot;</span>: <span class="string">&quot;2.0&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;error&quot;</span>: &#123;</span><br><span class="line">                        <span class="string">&quot;code&quot;</span>: -<span class="number">32602</span>,</span><br><span class="line">                        <span class="string">&quot;message&quot;</span>: <span class="string">&quot;令牌已过期&quot;</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 将用户信息添加到请求</span></span><br><span class="line">            request.user = payload.get(<span class="string">&quot;user&quot;</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">await</span> next_handler(request)</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">except</span> jwt.InvalidTokenError:</span><br><span class="line">            <span class="keyword">return</span> &#123;</span><br><span class="line">                <span class="string">&quot;jsonrpc&quot;</span>: <span class="string">&quot;2.0&quot;</span>,</span><br><span class="line">                <span class="string">&quot;error&quot;</span>: &#123;</span><br><span class="line">                    <span class="string">&quot;code&quot;</span>: -<span class="number">32602</span>,</span><br><span class="line">                    <span class="string">&quot;message&quot;</span>: <span class="string">&quot;无效的认证令牌&quot;</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure>
<h4 id="2-输入验证">2. 输入验证</h4>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Dict</span>, <span class="type">Any</span></span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">InputValidator</span>:</span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">validate_tool_parameters</span>(<span class="params">parameters: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>], schema: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]</span>) -&gt; <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;验证工具参数&quot;&quot;&quot;</span></span><br><span class="line">        validated = &#123;&#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> param_name, param_schema <span class="keyword">in</span> schema.items():</span><br><span class="line">            <span class="keyword">if</span> param_schema.get(<span class="string">&quot;required&quot;</span>) <span class="keyword">and</span> param_name <span class="keyword">not</span> <span class="keyword">in</span> parameters:</span><br><span class="line">                <span class="keyword">raise</span> ValueError(<span class="string">f&quot;参数 <span class="subst">&#123;param_name&#125;</span> 是必填项&quot;</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> param_name <span class="keyword">not</span> <span class="keyword">in</span> parameters:</span><br><span class="line">                <span class="keyword">if</span> <span class="string">&quot;default&quot;</span> <span class="keyword">in</span> param_schema:</span><br><span class="line">                    validated[param_name] = param_schema[<span class="string">&quot;default&quot;</span>]</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            </span><br><span class="line">            value = parameters[param_name]</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 类型验证</span></span><br><span class="line">            expected_type = param_schema.get(<span class="string">&quot;type&quot;</span>)</span><br><span class="line">            <span class="keyword">if</span> expected_type <span class="keyword">and</span> <span class="keyword">not</span> InputValidator._check_type(value, expected_type):</span><br><span class="line">                <span class="keyword">raise</span> ValueError(<span class="string">f&quot;参数 <span class="subst">&#123;param_name&#125;</span> 类型应为 <span class="subst">&#123;expected_type&#125;</span>&quot;</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 格式验证</span></span><br><span class="line">            <span class="keyword">if</span> <span class="string">&quot;pattern&quot;</span> <span class="keyword">in</span> param_schema <span class="keyword">and</span> <span class="keyword">not</span> re.<span class="keyword">match</span>(param_schema[<span class="string">&quot;pattern&quot;</span>], <span class="built_in">str</span>(value)):</span><br><span class="line">                <span class="keyword">raise</span> ValueError(<span class="string">f&quot;参数 <span class="subst">&#123;param_name&#125;</span> 格式不符合要求&quot;</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 范围验证</span></span><br><span class="line">            <span class="keyword">if</span> <span class="string">&quot;min&quot;</span> <span class="keyword">in</span> param_schema <span class="keyword">and</span> value &lt; param_schema[<span class="string">&quot;min&quot;</span>]:</span><br><span class="line">                <span class="keyword">raise</span> ValueError(<span class="string">f&quot;参数 <span class="subst">&#123;param_name&#125;</span> 最小值为 <span class="subst">&#123;param_schema[<span class="string">&#x27;min&#x27;</span>]&#125;</span>&quot;</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> <span class="string">&quot;max&quot;</span> <span class="keyword">in</span> param_schema <span class="keyword">and</span> value &gt; param_schema[<span class="string">&quot;max&quot;</span>]:</span><br><span class="line">                <span class="keyword">raise</span> ValueError(<span class="string">f&quot;参数 <span class="subst">&#123;param_name&#125;</span> 最大值为 <span class="subst">&#123;param_schema[<span class="string">&#x27;max&#x27;</span>]&#125;</span>&quot;</span>)</span><br><span class="line">            </span><br><span class="line">            validated[param_name] = value</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> validated</span><br><span class="line">    </span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_check_type</span>(<span class="params">value, expected_type: <span class="built_in">str</span></span>) -&gt; <span class="built_in">bool</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;检查值的类型&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> expected_type == <span class="string">&quot;string&quot;</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">isinstance</span>(value, <span class="built_in">str</span>)</span><br><span class="line">        <span class="keyword">elif</span> expected_type == <span class="string">&quot;number&quot;</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">isinstance</span>(value, (<span class="built_in">int</span>, <span class="built_in">float</span>))</span><br><span class="line">        <span class="keyword">elif</span> expected_type == <span class="string">&quot;boolean&quot;</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">isinstance</span>(value, <span class="built_in">bool</span>)</span><br><span class="line">        <span class="keyword">elif</span> expected_type == <span class="string">&quot;array&quot;</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">isinstance</span>(value, <span class="built_in">list</span>)</span><br><span class="line">        <span class="keyword">elif</span> expected_type == <span class="string">&quot;object&quot;</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">isinstance</span>(value, <span class="built_in">dict</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br></pre></td></tr></table></figure>
<h4 id="3-安全通信">3. 安全通信</h4>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> ssl</span><br><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">from</span> aiohttp <span class="keyword">import</span> web</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">create_secure_server</span>(<span class="params">app, host, port, ssl_context</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;创建安全的 HTTPS 服务器&quot;&quot;&quot;</span></span><br><span class="line">    runner = web.AppRunner(app)</span><br><span class="line">    <span class="keyword">await</span> runner.setup()</span><br><span class="line">    </span><br><span class="line">    site = web.TCPSite(</span><br><span class="line">        runner,</span><br><span class="line">        host=host,</span><br><span class="line">        port=port,</span><br><span class="line">        ssl_context=ssl_context</span><br><span class="line">    )</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">await</span> site.start()</span><br><span class="line">    <span class="keyword">return</span> runner</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create_ssl_context</span>(<span class="params">certfile, keyfile</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;创建 SSL 上下文&quot;&quot;&quot;</span></span><br><span class="line">    ssl_context = ssl.create_default_context(ssl.Purpose.CLIENT_AUTH)</span><br><span class="line">    ssl_context.load_cert_chain(certfile=certfile, keyfile=keyfile)</span><br><span class="line">    <span class="keyword">return</span> ssl_context</span><br></pre></td></tr></table></figure>
<h3 id="性能最佳实践">性能最佳实践</h3>
<h4 id="1-连接池管理">1. 连接池管理</h4>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Generic</span>, TypeVar, <span class="type">List</span>, <span class="type">Tuple</span></span><br><span class="line"></span><br><span class="line">T = TypeVar(<span class="string">&#x27;T&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ConnectionPool</span>(<span class="type">Generic</span>[T]):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, create_connection, max_size=<span class="number">10</span>, max_idle_time=<span class="number">300</span></span>):</span><br><span class="line">        <span class="variable language_">self</span>.create_connection = create_connection</span><br><span class="line">        <span class="variable language_">self</span>.max_size = max_size</span><br><span class="line">        <span class="variable language_">self</span>.max_idle_time = max_idle_time</span><br><span class="line">        <span class="variable language_">self</span>.pool: <span class="type">List</span>[<span class="type">Tuple</span>[T, <span class="built_in">float</span>]] = []</span><br><span class="line">        <span class="variable language_">self</span>.lock = asyncio.Lock()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">get_connection</span>(<span class="params">self</span>) -&gt; T:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;获取连接&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">async</span> <span class="keyword">with</span> <span class="variable language_">self</span>.lock:</span><br><span class="line">            <span class="comment"># 清理空闲连接</span></span><br><span class="line">            now = asyncio.get_event_loop().time()</span><br><span class="line">            <span class="variable language_">self</span>.pool = [</span><br><span class="line">                (conn, timestamp) <span class="keyword">for</span> conn, timestamp <span class="keyword">in</span> <span class="variable language_">self</span>.pool</span><br><span class="line">                <span class="keyword">if</span> now - timestamp &lt; <span class="variable language_">self</span>.max_idle_time</span><br><span class="line">            ]</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 如果有可用连接，返回最旧的</span></span><br><span class="line">            <span class="keyword">if</span> <span class="variable language_">self</span>.pool:</span><br><span class="line">                conn, _ = <span class="variable language_">self</span>.pool.pop(<span class="number">0</span>)</span><br><span class="line">                <span class="keyword">return</span> conn</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 如果池未满，创建新连接</span></span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">len</span>(<span class="variable language_">self</span>.pool) &lt; <span class="variable language_">self</span>.max_size:</span><br><span class="line">                conn = <span class="keyword">await</span> <span class="variable language_">self</span>.create_connection()</span><br><span class="line">                <span class="keyword">return</span> conn</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 池已满，等待其他连接释放</span></span><br><span class="line">        <span class="keyword">await</span> asyncio.sleep(<span class="number">0.1</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">await</span> <span class="variable language_">self</span>.get_connection()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">release_connection</span>(<span class="params">self, conn: T</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;释放连接&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">async</span> <span class="keyword">with</span> <span class="variable language_">self</span>.lock:</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">len</span>(<span class="variable language_">self</span>.pool) &lt; <span class="variable language_">self</span>.max_size:</span><br><span class="line">                <span class="variable language_">self</span>.pool.append((conn, asyncio.get_event_loop().time()))</span><br></pre></td></tr></table></figure>
<h4 id="2-缓存策略">2. 缓存策略</h4>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Dict</span>, <span class="type">Any</span>, <span class="type">Optional</span></span><br><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> wraps</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CacheManager</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, default_ttl=<span class="number">300</span></span>):</span><br><span class="line">        <span class="variable language_">self</span>.cache: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Tuple</span>[<span class="type">Any</span>, <span class="built_in">float</span>]] = &#123;&#125;</span><br><span class="line">        <span class="variable language_">self</span>.default_ttl = default_ttl</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get</span>(<span class="params">self, key: <span class="built_in">str</span></span>) -&gt; <span class="type">Optional</span>[<span class="type">Any</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;获取缓存&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> key <span class="keyword">in</span> <span class="variable language_">self</span>.cache:</span><br><span class="line">            value, expire_time = <span class="variable language_">self</span>.cache[key]</span><br><span class="line">            <span class="keyword">if</span> time.time() &lt; expire_time:</span><br><span class="line">                <span class="keyword">return</span> value</span><br><span class="line">            <span class="comment"># 过期缓存清理</span></span><br><span class="line">            <span class="keyword">del</span> <span class="variable language_">self</span>.cache[key]</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">set</span>(<span class="params">self, key: <span class="built_in">str</span>, value: <span class="type">Any</span>, ttl: <span class="type">Optional</span>[<span class="built_in">int</span>] = <span class="literal">None</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;设置缓存&quot;&quot;&quot;</span></span><br><span class="line">        expire_time = time.time() + (ttl <span class="keyword">or</span> <span class="variable language_">self</span>.default_ttl)</span><br><span class="line">        <span class="variable language_">self</span>.cache[key] = (value, expire_time)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">self, key: <span class="built_in">str</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;删除缓存&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> key <span class="keyword">in</span> <span class="variable language_">self</span>.cache:</span><br><span class="line">            <span class="keyword">del</span> <span class="variable language_">self</span>.cache[key]</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">clear</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;清空缓存&quot;&quot;&quot;</span></span><br><span class="line">        <span class="variable language_">self</span>.cache.clear()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 缓存装饰器</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cache_result</span>(<span class="params">cache_manager: CacheManager, ttl: <span class="type">Optional</span>[<span class="built_in">int</span>] = <span class="literal">None</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;缓存结果装饰器&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">decorator</span>(<span class="params">func</span>):</span><br><span class="line"><span class="meta">        @wraps(<span class="params">func</span>)</span></span><br><span class="line">        <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">wrapper</span>(<span class="params">*args, **kwargs</span>):</span><br><span class="line">            <span class="comment"># 生成缓存键</span></span><br><span class="line">            cache_key = <span class="string">f&quot;<span class="subst">&#123;func.__name__&#125;</span>:<span class="subst">&#123;<span class="built_in">str</span>(args)&#125;</span>:<span class="subst">&#123;<span class="built_in">str</span>(kwargs)&#125;</span>&quot;</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 尝试从缓存获取</span></span><br><span class="line">            cached_result = cache_manager.get(cache_key)</span><br><span class="line">            <span class="keyword">if</span> cached_result <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                <span class="keyword">return</span> cached_result</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 执行函数</span></span><br><span class="line">            result = <span class="keyword">await</span> func(*args, **kwargs)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 缓存结果</span></span><br><span class="line">            cache_manager.<span class="built_in">set</span>(cache_key, result, ttl)</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> result</span><br><span class="line">        <span class="keyword">return</span> wrapper</span><br><span class="line">    <span class="keyword">return</span> decorator</span><br></pre></td></tr></table></figure>
<h4 id="3-异步处理">3. 异步处理</h4>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> uuid</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Dict</span>, <span class="type">Any</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AsyncTaskManager</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.tasks: <span class="type">Dict</span>[<span class="built_in">str</span>, asyncio.Task] = &#123;&#125;</span><br><span class="line">        <span class="variable language_">self</span>.task_results: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>] = &#123;&#125;</span><br><span class="line">        <span class="variable language_">self</span>.task_errors: <span class="type">Dict</span>[<span class="built_in">str</span>, Exception] = &#123;&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">create_task</span>(<span class="params">self, coro, task_id: <span class="type">Optional</span>[<span class="built_in">str</span>] = <span class="literal">None</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;创建异步任务&quot;&quot;&quot;</span></span><br><span class="line">        task_id = task_id <span class="keyword">or</span> <span class="built_in">str</span>(uuid.uuid4())</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">task_wrapper</span>():</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                result = <span class="keyword">await</span> coro</span><br><span class="line">                <span class="variable language_">self</span>.task_results[task_id] = result</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                <span class="variable language_">self</span>.task_errors[task_id] = e</span><br><span class="line">            <span class="keyword">finally</span>:</span><br><span class="line">                <span class="keyword">if</span> task_id <span class="keyword">in</span> <span class="variable language_">self</span>.tasks:</span><br><span class="line">                    <span class="keyword">del</span> <span class="variable language_">self</span>.tasks[task_id]</span><br><span class="line">        </span><br><span class="line">        task = asyncio.create_task(task_wrapper())</span><br><span class="line">        <span class="variable language_">self</span>.tasks[task_id] = task</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> task_id</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_task_status</span>(<span class="params">self, task_id: <span class="built_in">str</span></span>) -&gt; <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;获取任务状态&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> task_id <span class="keyword">in</span> <span class="variable language_">self</span>.task_results:</span><br><span class="line">            <span class="keyword">return</span> &#123;</span><br><span class="line">                <span class="string">&quot;status&quot;</span>: <span class="string">&quot;completed&quot;</span>,</span><br><span class="line">                <span class="string">&quot;result&quot;</span>: <span class="variable language_">self</span>.task_results[task_id]</span><br><span class="line">            &#125;</span><br><span class="line">        <span class="keyword">elif</span> task_id <span class="keyword">in</span> <span class="variable language_">self</span>.task_errors:</span><br><span class="line">            <span class="keyword">return</span> &#123;</span><br><span class="line">                <span class="string">&quot;status&quot;</span>: <span class="string">&quot;failed&quot;</span>,</span><br><span class="line">                <span class="string">&quot;error&quot;</span>: <span class="built_in">str</span>(<span class="variable language_">self</span>.task_errors[task_id])</span><br><span class="line">            &#125;</span><br><span class="line">        <span class="keyword">elif</span> task_id <span class="keyword">in</span> <span class="variable language_">self</span>.tasks:</span><br><span class="line">            <span class="keyword">return</span> &#123;<span class="string">&quot;status&quot;</span>: <span class="string">&quot;processing&quot;</span>&#125;</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> &#123;<span class="string">&quot;status&quot;</span>: <span class="string">&quot;unknown&quot;</span>&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">wait_for_task</span>(<span class="params">self, task_id: <span class="built_in">str</span>, timeout: <span class="type">Optional</span>[<span class="built_in">float</span>] = <span class="literal">None</span></span>) -&gt; <span class="type">Any</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;等待任务完成&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> task_id <span class="keyword">not</span> <span class="keyword">in</span> <span class="variable language_">self</span>.tasks:</span><br><span class="line">            <span class="keyword">if</span> task_id <span class="keyword">in</span> <span class="variable language_">self</span>.task_results:</span><br><span class="line">                <span class="keyword">return</span> <span class="variable language_">self</span>.task_results[task_id]</span><br><span class="line">            <span class="keyword">elif</span> task_id <span class="keyword">in</span> <span class="variable language_">self</span>.task_errors:</span><br><span class="line">                <span class="keyword">raise</span> <span class="variable language_">self</span>.task_errors[task_id]</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">raise</span> ValueError(<span class="string">f&quot;任务 <span class="subst">&#123;task_id&#125;</span> 不存在&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        task = <span class="variable language_">self</span>.tasks[task_id]</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">await</span> asyncio.wait_for(task, timeout)</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> task_id <span class="keyword">in</span> <span class="variable language_">self</span>.task_results:</span><br><span class="line">                <span class="keyword">return</span> <span class="variable language_">self</span>.task_results[task_id]</span><br><span class="line">            <span class="keyword">elif</span> task_id <span class="keyword">in</span> <span class="variable language_">self</span>.task_errors:</span><br><span class="line">                <span class="keyword">raise</span> <span class="variable language_">self</span>.task_errors[task_id]</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">raise</span> ValueError(<span class="string">f&quot;任务 <span class="subst">&#123;task_id&#125;</span> 没有结果&quot;</span>)</span><br><span class="line">                </span><br><span class="line">        <span class="keyword">except</span> asyncio.TimeoutError:</span><br><span class="line">            <span class="keyword">raise</span> TimeoutError(<span class="string">f&quot;任务 <span class="subst">&#123;task_id&#125;</span> 超时&quot;</span>)</span><br></pre></td></tr></table></figure>
<h3 id="开发最佳实践">开发最佳实践</h3>
<h4 id="1-代码组织">1. 代码组织</h4>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">mcp-project/</span><br><span class="line">├── src/</span><br><span class="line">│   ├── server/                # 服务器核心代码</span><br><span class="line">│   │   ├── __init__.py</span><br><span class="line">│   │   ├── server.py          # 服务器主类</span><br><span class="line">│   │   ├── middleware.py      # 中间件</span><br><span class="line">│   │   └── lifecycle.py       # 生命周期管理</span><br><span class="line">│   ├── tools/                 # 工具模块</span><br><span class="line">│   │   ├── __init__.py</span><br><span class="line">│   │   ├── weather.py         # 天气工具</span><br><span class="line">│   │   ├── file_manager.py    # 文件管理工具</span><br><span class="line">│   │   └── calculator.py      # 计算器工具</span><br><span class="line">│   ├── resources/             # 资源模块</span><br><span class="line">│   │   ├── __init__.py</span><br><span class="line">│   │   ├── config.py          # 配置资源</span><br><span class="line">│   │   └── status.py          # 状态资源</span><br><span class="line">│   ├── prompts/               # 提示词模块</span><br><span class="line">│   │   ├── __init__.py</span><br><span class="line">│   │   └── templates.py       # 提示词模板</span><br><span class="line">│   ├── utils/                 # 工具函数</span><br><span class="line">│   │   ├── __init__.py</span><br><span class="line">│   │   ├── logger.py          # 日志工具</span><br><span class="line">│   │   ├── validator.py       # 验证工具</span><br><span class="line">│   │   └── cache.py           # 缓存工具</span><br><span class="line">│   └── main.py                # 应用入口</span><br><span class="line">├── tests/                     # 测试代码</span><br><span class="line">├── config/                    # 配置文件</span><br><span class="line">├── docker/                    # Docker 配置</span><br><span class="line">├── docs/                      # 文档</span><br><span class="line">└── requirements.txt           # 依赖管理</span><br></pre></td></tr></table></figure>
<h4 id="2-配置管理">2. 配置管理</h4>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> yaml</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Dict</span>, <span class="type">Any</span>, <span class="type">Optional</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ConfigManager</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, config_file: <span class="built_in">str</span> = <span class="string">&quot;config/config.yaml&quot;</span></span>):</span><br><span class="line">        <span class="variable language_">self</span>.config_file = config_file</span><br><span class="line">        <span class="variable language_">self</span>.config: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>] = &#123;&#125;</span><br><span class="line">        <span class="variable language_">self</span>.load_config()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">load_config</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;加载配置文件&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> os.path.exists(<span class="variable language_">self</span>.config_file):</span><br><span class="line">            <span class="keyword">with</span> <span class="built_in">open</span>(<span class="variable language_">self</span>.config_file, <span class="string">&#x27;r&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">                <span class="variable language_">self</span>.config = yaml.safe_load(f) <span class="keyword">or</span> &#123;&#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 加载环境变量配置</span></span><br><span class="line">        <span class="variable language_">self</span>.load_env_config()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">load_env_config</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;从环境变量加载配置&quot;&quot;&quot;</span></span><br><span class="line">        env_mapping = &#123;</span><br><span class="line">            <span class="string">&quot;MCP_HOST&quot;</span>: (<span class="string">&quot;server&quot;</span>, <span class="string">&quot;host&quot;</span>),</span><br><span class="line">            <span class="string">&quot;MCP_PORT&quot;</span>: (<span class="string">&quot;server&quot;</span>, <span class="string">&quot;port&quot;</span>),</span><br><span class="line">            <span class="string">&quot;MCP_DEBUG&quot;</span>: (<span class="string">&quot;server&quot;</span>, <span class="string">&quot;debug&quot;</span>),</span><br><span class="line">            <span class="string">&quot;API_KEY&quot;</span>: (<span class="string">&quot;services&quot;</span>, <span class="string">&quot;api_key&quot;</span>),</span><br><span class="line">            <span class="string">&quot;LOG_LEVEL&quot;</span>: (<span class="string">&quot;logging&quot;</span>, <span class="string">&quot;level&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> env_var, config_path <span class="keyword">in</span> env_mapping.items():</span><br><span class="line">            <span class="keyword">if</span> env_var <span class="keyword">in</span> os.environ:</span><br><span class="line">                <span class="variable language_">self</span>.set_config_value(config_path, os.environ[env_var])</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_config_value</span>(<span class="params">self, path: <span class="built_in">tuple</span>, default: <span class="type">Any</span> = <span class="literal">None</span></span>) -&gt; <span class="type">Any</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;获取配置值&quot;&quot;&quot;</span></span><br><span class="line">        value = <span class="variable language_">self</span>.config</span><br><span class="line">        <span class="keyword">for</span> key <span class="keyword">in</span> path:</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">isinstance</span>(value, <span class="built_in">dict</span>) <span class="keyword">and</span> key <span class="keyword">in</span> value:</span><br><span class="line">                value = value[key]</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">return</span> default</span><br><span class="line">        <span class="keyword">return</span> value</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">set_config_value</span>(<span class="params">self, path: <span class="built_in">tuple</span>, value: <span class="type">Any</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;设置配置值&quot;&quot;&quot;</span></span><br><span class="line">        current = <span class="variable language_">self</span>.config</span><br><span class="line">        <span class="keyword">for</span> i, key <span class="keyword">in</span> <span class="built_in">enumerate</span>(path[:-<span class="number">1</span>]):</span><br><span class="line">            <span class="keyword">if</span> key <span class="keyword">not</span> <span class="keyword">in</span> current <span class="keyword">or</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(current[key], <span class="built_in">dict</span>):</span><br><span class="line">                current[key] = &#123;&#125;</span><br><span class="line">            current = current[key]</span><br><span class="line">        </span><br><span class="line">        current[path[-<span class="number">1</span>]] = value</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_server_config</span>(<span class="params">self</span>) -&gt; <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;获取服务器配置&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="string">&quot;host&quot;</span>: <span class="variable language_">self</span>.get_config_value((<span class="string">&quot;server&quot;</span>, <span class="string">&quot;host&quot;</span>), <span class="string">&quot;0.0.0.0&quot;</span>),</span><br><span class="line">            <span class="string">&quot;port&quot;</span>: <span class="variable language_">self</span>.get_config_value((<span class="string">&quot;server&quot;</span>, <span class="string">&quot;port&quot;</span>), <span class="number">8080</span>),</span><br><span class="line">            <span class="string">&quot;debug&quot;</span>: <span class="variable language_">self</span>.get_config_value((<span class="string">&quot;server&quot;</span>, <span class="string">&quot;debug&quot;</span>), <span class="literal">False</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_logging_config</span>(<span class="params">self</span>) -&gt; <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;获取日志配置&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="string">&quot;level&quot;</span>: <span class="variable language_">self</span>.get_config_value((<span class="string">&quot;logging&quot;</span>, <span class="string">&quot;level&quot;</span>), <span class="string">&quot;INFO&quot;</span>),</span><br><span class="line">            <span class="string">&quot;file&quot;</span>: <span class="variable language_">self</span>.get_config_value((<span class="string">&quot;logging&quot;</span>, <span class="string">&quot;file&quot;</span>), <span class="string">&quot;logs/mcp-server.log&quot;</span>)</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>
<h4 id="3-错误处理">3. 错误处理</h4>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Dict</span>, <span class="type">Any</span>, <span class="type">Callable</span>, <span class="type">Coroutine</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ErrorHandler</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, logger: logging.Logger</span>):</span><br><span class="line">        <span class="variable language_">self</span>.logger = logger</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">handle_errors</span>(<span class="params">self, func: <span class="type">Callable</span>[..., <span class="type">Coroutine</span>[<span class="type">Any</span>, <span class="type">Any</span>, <span class="type">Any</span>]]</span>) -&gt; <span class="type">Callable</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;错误处理装饰器&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">wrapper</span>(<span class="params">*args, **kwargs</span>):</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">await</span> func(*args, **kwargs)</span><br><span class="line">            <span class="keyword">except</span> ValueError <span class="keyword">as</span> e:</span><br><span class="line">                <span class="variable language_">self</span>.logger.warning(<span class="string">f&quot;参数错误: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="variable language_">self</span>._create_error_response(-<span class="number">32602</span>, <span class="built_in">str</span>(e))</span><br><span class="line">            <span class="keyword">except</span> PermissionError <span class="keyword">as</span> e:</span><br><span class="line">                <span class="variable language_">self</span>.logger.warning(<span class="string">f&quot;权限错误: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="variable language_">self</span>._create_error_response(-<span class="number">32603</span>, <span class="built_in">str</span>(e))</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                <span class="variable language_">self</span>.logger.error(<span class="string">f&quot;服务器错误: <span class="subst">&#123;e&#125;</span>&quot;</span>, exc_info=<span class="literal">True</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="variable language_">self</span>._create_error_response(-<span class="number">32603</span>, <span class="string">&quot;服务器内部错误&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> wrapper</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_create_error_response</span>(<span class="params">self, code: <span class="built_in">int</span>, message: <span class="built_in">str</span>, data: <span class="type">Any</span> = <span class="literal">None</span></span>) -&gt; <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;创建错误响应&quot;&quot;&quot;</span></span><br><span class="line">        error = &#123;</span><br><span class="line">            <span class="string">&quot;code&quot;</span>: code,</span><br><span class="line">            <span class="string">&quot;message&quot;</span>: message</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> data <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            error[<span class="string">&quot;data&quot;</span>] = data</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="string">&quot;jsonrpc&quot;</span>: <span class="string">&quot;2.0&quot;</span>,</span><br><span class="line">            <span class="string">&quot;error&quot;</span>: error</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用示例</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyServer</span>(<span class="title class_ inherited__">MCPServer</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">super</span>().__init__(name=<span class="string">&quot;MyServer&quot;</span>, version=<span class="string">&quot;1.0.0&quot;</span>)</span><br><span class="line">        <span class="variable language_">self</span>.error_handler = ErrorHandler(<span class="variable language_">self</span>.logger)</span><br><span class="line">        <span class="variable language_">self</span>.register_tools()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">register_tools</span>(<span class="params">self</span>):</span><br><span class="line">        tool: ToolRegistration = &#123;</span><br><span class="line">            <span class="string">&quot;name&quot;</span>: <span class="string">&quot;my_tool&quot;</span>,</span><br><span class="line">            <span class="string">&quot;description&quot;</span>: <span class="string">&quot;我的工具&quot;</span>,</span><br><span class="line">            <span class="string">&quot;parameters&quot;</span>: &#123;<span class="string">&quot;param&quot;</span>: &#123;<span class="string">&quot;type&quot;</span>: <span class="string">&quot;string&quot;</span>, <span class="string">&quot;required&quot;</span>: <span class="literal">True</span>&#125;&#125;,</span><br><span class="line">            <span class="string">&quot;handler&quot;</span>: <span class="variable language_">self</span>.error_handler.handle_errors(<span class="variable language_">self</span>.handle_my_tool)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable language_">self</span>.register_tool(tool)</span><br></pre></td></tr></table></figure>
<h3 id="运维最佳实践">运维最佳实践</h3>
<h4 id="1-监控指标">1. 监控指标</h4>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> prometheus_client <span class="keyword">import</span> Counter, Gauge, Histogram, start_http_server</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MetricsCollector</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="comment"># 会话相关指标</span></span><br><span class="line">        <span class="variable language_">self</span>.active_sessions = Gauge(</span><br><span class="line">            <span class="string">&quot;mcp_active_sessions&quot;</span>, </span><br><span class="line">            <span class="string">&quot;当前活跃会话数&quot;</span></span><br><span class="line">        )</span><br><span class="line">        <span class="variable language_">self</span>.session_total = Counter(</span><br><span class="line">            <span class="string">&quot;mcp_session_total&quot;</span>, </span><br><span class="line">            <span class="string">&quot;总会话数&quot;</span></span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 工具调用指标</span></span><br><span class="line">        <span class="variable language_">self</span>.tool_calls = Counter(</span><br><span class="line">            <span class="string">&quot;mcp_tool_calls_total&quot;</span>, </span><br><span class="line">            <span class="string">&quot;工具调用总数&quot;</span>,</span><br><span class="line">            [<span class="string">&quot;tool_name&quot;</span>, <span class="string">&quot;status&quot;</span>]</span><br><span class="line">        )</span><br><span class="line">        <span class="variable language_">self</span>.tool_duration = Histogram(</span><br><span class="line">            <span class="string">&quot;mcp_tool_duration_seconds&quot;</span>, </span><br><span class="line">            <span class="string">&quot;工具调用耗时&quot;</span>,</span><br><span class="line">            [<span class="string">&quot;tool_name&quot;</span>]</span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 错误指标</span></span><br><span class="line">        <span class="variable language_">self</span>.error_total = Counter(</span><br><span class="line">            <span class="string">&quot;mcp_errors_total&quot;</span>, </span><br><span class="line">            <span class="string">&quot;错误总数&quot;</span>,</span><br><span class="line">            [<span class="string">&quot;error_type&quot;</span>]</span><br><span class="line">        )</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">record_session_start</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;记录会话开始&quot;&quot;&quot;</span></span><br><span class="line">        <span class="variable language_">self</span>.session_total.inc()</span><br><span class="line">        <span class="variable language_">self</span>.active_sessions.inc()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">record_session_end</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;记录会话结束&quot;&quot;&quot;</span></span><br><span class="line">        <span class="variable language_">self</span>.active_sessions.dec()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">record_tool_call</span>(<span class="params">self, tool_name, duration, success=<span class="literal">True</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;记录工具调用&quot;&quot;&quot;</span></span><br><span class="line">        status = <span class="string">&quot;success&quot;</span> <span class="keyword">if</span> success <span class="keyword">else</span> <span class="string">&quot;failure&quot;</span></span><br><span class="line">        <span class="variable language_">self</span>.tool_calls.labels(tool_name=tool_name, status=status).inc()</span><br><span class="line">        <span class="variable language_">self</span>.tool_duration.labels(tool_name=tool_name).observe(duration)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">record_error</span>(<span class="params">self, error_type</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;记录错误&quot;&quot;&quot;</span></span><br><span class="line">        <span class="variable language_">self</span>.error_total.labels(error_type=error_type).inc()</span><br></pre></td></tr></table></figure>
<h4 id="2-健康检查">2. 健康检查</h4>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Dict</span>, <span class="type">Any</span></span><br><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">HealthChecker</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, server</span>):</span><br><span class="line">        <span class="variable language_">self</span>.server = server</span><br><span class="line">        <span class="variable language_">self</span>.services = []</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">register_service_check</span>(<span class="params">self, name: <span class="built_in">str</span>, check_func</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;注册服务检查&quot;&quot;&quot;</span></span><br><span class="line">        <span class="variable language_">self</span>.services.append((name, check_func))</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">check_health</span>(<span class="params">self</span>) -&gt; <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;执行健康检查&quot;&quot;&quot;</span></span><br><span class="line">        status = &#123;</span><br><span class="line">            <span class="string">&quot;status&quot;</span>: <span class="string">&quot;healthy&quot;</span>,</span><br><span class="line">            <span class="string">&quot;timestamp&quot;</span>: time.time(),</span><br><span class="line">            <span class="string">&quot;server&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;name&quot;</span>: <span class="variable language_">self</span>.server.name,</span><br><span class="line">                <span class="string">&quot;version&quot;</span>: <span class="variable language_">self</span>.server.version,</span><br><span class="line">                <span class="string">&quot;uptime&quot;</span>: time.time() - <span class="variable language_">self</span>.server.start_time</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&quot;services&quot;</span>: &#123;&#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 检查各个服务</span></span><br><span class="line">        <span class="keyword">for</span> name, check_func <span class="keyword">in</span> <span class="variable language_">self</span>.services:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                service_status = <span class="keyword">await</span> check_func()</span><br><span class="line">                status[<span class="string">&quot;services&quot;</span>][name] = service_status</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span> service_status.get(<span class="string">&quot;status&quot;</span>) != <span class="string">&quot;healthy&quot;</span>:</span><br><span class="line">                    status[<span class="string">&quot;status&quot;</span>] = <span class="string">&quot;unhealthy&quot;</span></span><br><span class="line">                    </span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                status[<span class="string">&quot;services&quot;</span>][name] = &#123;</span><br><span class="line">                    <span class="string">&quot;status&quot;</span>: <span class="string">&quot;error&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;error&quot;</span>: <span class="built_in">str</span>(e)</span><br><span class="line">                &#125;</span><br><span class="line">                status[<span class="string">&quot;status&quot;</span>] = <span class="string">&quot;unhealthy&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> status</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用示例</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyServer</span>(<span class="title class_ inherited__">MCPServer</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">super</span>().__init__(name=<span class="string">&quot;MyServer&quot;</span>, version=<span class="string">&quot;1.0.0&quot;</span>)</span><br><span class="line">        <span class="variable language_">self</span>.start_time = time.time()</span><br><span class="line">        <span class="variable language_">self</span>.health_checker = HealthChecker(<span class="variable language_">self</span>)</span><br><span class="line">        <span class="variable language_">self</span>.setup_health_checks()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">setup_health_checks</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;设置健康检查&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># 检查数据库连接</span></span><br><span class="line">        <span class="variable language_">self</span>.health_checker.register_service_check(</span><br><span class="line">            <span class="string">&quot;database&quot;</span>,</span><br><span class="line">            <span class="variable language_">self</span>.check_database</span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 检查外部API</span></span><br><span class="line">        <span class="variable language_">self</span>.health_checker.register_service_check(</span><br><span class="line">            <span class="string">&quot;external_api&quot;</span>,</span><br><span class="line">            <span class="variable language_">self</span>.check_external_api</span><br><span class="line">        )</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">check_database</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;检查数据库连接&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># 数据库连接检查逻辑</span></span><br><span class="line">            <span class="keyword">return</span> &#123;<span class="string">&quot;status&quot;</span>: <span class="string">&quot;healthy&quot;</span>, <span class="string">&quot;latency&quot;</span>: <span class="number">0.1</span>&#125;</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">return</span> &#123;<span class="string">&quot;status&quot;</span>: <span class="string">&quot;unhealthy&quot;</span>, <span class="string">&quot;error&quot;</span>: <span class="built_in">str</span>(e)&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">check_external_api</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;检查外部API&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># 外部API检查逻辑</span></span><br><span class="line">            <span class="keyword">return</span> &#123;<span class="string">&quot;status&quot;</span>: <span class="string">&quot;healthy&quot;</span>, <span class="string">&quot;latency&quot;</span>: <span class="number">0.5</span>&#125;</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">return</span> &#123;<span class="string">&quot;status&quot;</span>: <span class="string">&quot;unhealthy&quot;</span>, <span class="string">&quot;error&quot;</span>: <span class="built_in">str</span>(e)&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">handle_health_request</span>(<span class="params">self, request</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;处理健康检查请求&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">await</span> <span class="variable language_">self</span>.health_checker.check_health()</span><br></pre></td></tr></table></figure>
<hr>
<p><strong>官方资源</strong>：</p>
<ul class="lvl-0">
<li class="lvl-2">
<p><a target="_blank" rel="noopener" href="https://modelcontextprotocol.io/">MCP 官方网站</a></p>
</li>
<li class="lvl-2">
<p><a target="_blank" rel="noopener" href="https://www.claudemcp.com/zh/specification">协议规范文档</a></p>
</li>
<li class="lvl-2">
<p><a target="_blank" rel="noopener" href="https://github.com/modelcontextprotocol">GitHub 仓库</a></p>
</li>
<li class="lvl-2">
<p><a target="_blank" rel="noopener" href="https://discord.gg/mcp">社区讨论</a></p>
</li>
</ul>

    </div>

    
    
    

      <footer class="post-footer">
          
          <div class="post-tags">
              <a href="/tags/AI/" rel="tag"><i class="fa fa-tag"></i> AI</a>
              <a href="/tags/web/" rel="tag"><i class="fa fa-tag"></i> web</a>
          </div>

        



        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2025/10/23/AI/playwright/" rel="prev" title="playwright使用">
      <i class="fa fa-chevron-left"></i> playwright使用
    </a></div>
      <div class="post-nav-item">
    <a href="/2025/10/23/AI/LangChain%E5%9F%BA%E7%A1%80%E4%BD%BF%E7%94%A8/" rel="next" title="LangChain基础使用">
      LangChain基础使用 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
            
    <div class="comments" id="gitalk-container"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link"><span class="nav-number">1.</span> <span class="nav-text">MCP 开发指南：构建模型上下文协议服务器</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%9B%AE%E5%BD%95"><span class="nav-number">1.1.</span> <span class="nav-text">目录</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BF%AB%E9%80%9F%E5%BC%80%E5%A7%8B"><span class="nav-number">1.2.</span> <span class="nav-text">快速开始</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87"><span class="nav-number">1.2.1.</span> <span class="nav-text">环境准备</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5%E5%88%86%E9%92%9F%E5%88%9B%E5%BB%BA%E7%AC%AC%E4%B8%80%E4%B8%AA-MCP-%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="nav-number">1.2.2.</span> <span class="nav-text">5分钟创建第一个 MCP 服务器</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Step-1-%E5%88%9B%E5%BB%BA%E9%A1%B9%E7%9B%AE%E7%9B%AE%E5%BD%95"><span class="nav-number">1.2.2.1.</span> <span class="nav-text">Step 1: 创建项目目录</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Step-2-%E7%BC%96%E5%86%99%E5%9F%BA%E7%A1%80%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%BB%A3%E7%A0%81"><span class="nav-number">1.2.2.2.</span> <span class="nav-text">Step 2: 编写基础服务器代码</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Step-3-%E5%90%AF%E5%8A%A8%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="nav-number">1.2.2.3.</span> <span class="nav-text">Step 3: 启动服务器</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Step-4-%E6%B5%8B%E8%AF%95%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="nav-number">1.2.2.4.</span> <span class="nav-text">Step 4: 测试服务器</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8D%8F%E8%AE%AE%E6%A6%82%E8%BF%B0"><span class="nav-number">1.3.</span> <span class="nav-text">协议概述</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF-MCP"><span class="nav-number">1.3.1.</span> <span class="nav-text">什么是 MCP</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A0%B8%E5%BF%83%E4%BB%B7%E5%80%BC"><span class="nav-number">1.3.2.</span> <span class="nav-text">核心价值</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8D%8F%E8%AE%AE%E7%89%B9%E7%82%B9"><span class="nav-number">1.3.3.</span> <span class="nav-text">协议特点</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%A0%B8%E5%BF%83%E6%9E%B6%E6%9E%84"><span class="nav-number">1.4.</span> <span class="nav-text">核心架构</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%89%E5%B1%82%E6%9E%B6%E6%9E%84%E6%A8%A1%E5%BC%8F"><span class="nav-number">1.4.1.</span> <span class="nav-text">三层架构模式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BB%84%E4%BB%B6%E8%AF%A6%E6%83%85"><span class="nav-number">1.4.2.</span> <span class="nav-text">组件详情</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%BB%E6%9C%BA-Host"><span class="nav-number">1.4.2.1.</span> <span class="nav-text">主机 (Host)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF-Client"><span class="nav-number">1.4.2.2.</span> <span class="nav-text">客户端 (Client)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9C%8D%E5%8A%A1%E5%99%A8-Server"><span class="nav-number">1.4.2.3.</span> <span class="nav-text">服务器 (Server)</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8D%8F%E8%AE%AE%E5%9F%BA%E7%A1%80"><span class="nav-number">1.5.</span> <span class="nav-text">协议基础</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B6%88%E6%81%AF%E7%B1%BB%E5%9E%8B"><span class="nav-number">1.5.1.</span> <span class="nav-text">消息类型</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-%E8%AF%B7%E6%B1%82-Request"><span class="nav-number">1.5.1.1.</span> <span class="nav-text">1. 请求 (Request)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-%E5%93%8D%E5%BA%94-Response"><span class="nav-number">1.5.1.2.</span> <span class="nav-text">2. 响应 (Response)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-%E9%80%9A%E7%9F%A5-Notification"><span class="nav-number">1.5.1.3.</span> <span class="nav-text">3. 通知 (Notification)</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%94%99%E8%AF%AF%E7%A0%81%E8%A7%84%E8%8C%83"><span class="nav-number">1.5.2.</span> <span class="nav-text">错误码规范</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E7%AE%A1%E7%90%86"><span class="nav-number">1.6.</span> <span class="nav-text">生命周期管理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BC%9A%E8%AF%9D%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F"><span class="nav-number">1.6.1.</span> <span class="nav-text">会话生命周期</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-%E5%88%9D%E5%A7%8B%E5%8C%96%E9%98%B6%E6%AE%B5"><span class="nav-number">1.6.1.1.</span> <span class="nav-text">1. 初始化阶段</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-%E6%93%8D%E4%BD%9C%E9%98%B6%E6%AE%B5"><span class="nav-number">1.6.1.2.</span> <span class="nav-text">2. 操作阶段</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-%E5%85%B3%E9%97%AD%E9%98%B6%E6%AE%B5"><span class="nav-number">1.6.1.3.</span> <span class="nav-text">3. 关闭阶段</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%89%88%E6%9C%AC%E5%8D%8F%E5%95%86"><span class="nav-number">1.6.2.</span> <span class="nav-text">版本协商</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%83%BD%E5%8A%9B%E5%8D%8F%E5%95%86"><span class="nav-number">1.6.3.</span> <span class="nav-text">能力协商</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BC%A0%E8%BE%93%E6%9C%BA%E5%88%B6"><span class="nav-number">1.7.</span> <span class="nav-text">传输机制</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A0%87%E5%87%86%E8%BE%93%E5%85%A5%E8%BE%93%E5%87%BA-stdio"><span class="nav-number">1.7.1.</span> <span class="nav-text">标准输入输出 (stdio)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9F%BA%E4%BA%8E-SSE-%E7%9A%84-HTTP"><span class="nav-number">1.7.2.</span> <span class="nav-text">基于 SSE 的 HTTP</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9C%8D%E5%8A%A1%E7%AB%AF%E5%BC%80%E5%8F%91"><span class="nav-number">1.8.</span> <span class="nav-text">服务端开发</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A0%B8%E5%BF%83%E7%BB%84%E4%BB%B6"><span class="nav-number">1.8.1.</span> <span class="nav-text">核心组件</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%B1%BB"><span class="nav-number">1.8.1.1.</span> <span class="nav-text">1. 服务器类</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-%E5%B7%A5%E5%85%B7%E5%BC%80%E5%8F%91"><span class="nav-number">1.8.1.2.</span> <span class="nav-text">2. 工具开发</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86"><span class="nav-number">1.8.1.3.</span> <span class="nav-text">3. 资源管理</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-%E6%8F%90%E7%A4%BA%E8%AF%8D%E7%AE%A1%E7%90%86"><span class="nav-number">1.8.1.4.</span> <span class="nav-text">4. 提示词管理</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BA%8B%E4%BB%B6%E7%B3%BB%E7%BB%9F"><span class="nav-number">1.8.2.</span> <span class="nav-text">事件系统</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%BC%80%E5%8F%91"><span class="nav-number">1.9.</span> <span class="nav-text">客户端开发</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%9F%BA%E7%A1%80"><span class="nav-number">1.9.1.</span> <span class="nav-text">客户端基础</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%BF%9E%E6%8E%A5%E7%AE%A1%E7%90%86"><span class="nav-number">1.9.1.1.</span> <span class="nav-text">连接管理</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%BC%82%E6%AD%A5%E6%93%8D%E4%BD%9C%E5%A4%84%E7%90%86"><span class="nav-number">1.9.1.2.</span> <span class="nav-text">异步操作处理</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BA%8B%E4%BB%B6%E8%AE%A2%E9%98%85"><span class="nav-number">1.9.1.3.</span> <span class="nav-text">事件订阅</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%9E%E6%88%98%E7%A4%BA%E4%BE%8B"><span class="nav-number">1.10.</span> <span class="nav-text">实战示例</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%A4%BA%E4%BE%8B-1-%E6%96%87%E4%BB%B6%E7%AE%A1%E7%90%86%E5%99%A8%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="nav-number">1.10.1.</span> <span class="nav-text">示例 1: 文件管理器服务器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%A4%BA%E4%BE%8B-2-%E5%A4%A9%E6%B0%94%E6%9F%A5%E8%AF%A2%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="nav-number">1.10.2.</span> <span class="nav-text">示例 2: 天气查询服务器</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%B0%83%E8%AF%95%E4%B8%8E%E6%B5%8B%E8%AF%95"><span class="nav-number">1.11.</span> <span class="nav-text">调试与测试</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#MCP-%E6%A3%80%E6%9F%A5%E5%99%A8"><span class="nav-number">1.11.1.</span> <span class="nav-text">MCP 检查器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%97%A5%E5%BF%97%E9%85%8D%E7%BD%AE"><span class="nav-number">1.11.2.</span> <span class="nav-text">日志配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95"><span class="nav-number">1.11.3.</span> <span class="nav-text">单元测试</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%9B%86%E6%88%90%E6%B5%8B%E8%AF%95"><span class="nav-number">1.11.4.</span> <span class="nav-text">集成测试</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%83%A8%E7%BD%B2%E6%8C%87%E5%8D%97"><span class="nav-number">1.12.</span> <span class="nav-text">部署指南</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Docker-%E5%AE%B9%E5%99%A8%E5%8C%96"><span class="nav-number">1.12.1.</span> <span class="nav-text">Docker 容器化</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Dockerfile"><span class="nav-number">1.12.1.1.</span> <span class="nav-text">Dockerfile</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Docker-Compose"><span class="nav-number">1.12.1.2.</span> <span class="nav-text">Docker Compose</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Kubernetes-%E9%83%A8%E7%BD%B2"><span class="nav-number">1.12.2.</span> <span class="nav-text">Kubernetes 部署</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Deployment"><span class="nav-number">1.12.2.1.</span> <span class="nav-text">Deployment</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Service"><span class="nav-number">1.12.2.2.</span> <span class="nav-text">Service</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Ingress"><span class="nav-number">1.12.2.3.</span> <span class="nav-text">Ingress</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BA%91%E6%9C%8D%E5%8A%A1%E9%83%A8%E7%BD%B2"><span class="nav-number">1.12.3.</span> <span class="nav-text">云服务部署</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#AWS-ECS-%E9%83%A8%E7%BD%B2"><span class="nav-number">1.12.3.1.</span> <span class="nav-text">AWS ECS 部署</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="nav-number">1.13.</span> <span class="nav-text">最佳实践</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%89%E5%85%A8%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="nav-number">1.13.1.</span> <span class="nav-text">安全最佳实践</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-%E8%BA%AB%E4%BB%BD%E8%AE%A4%E8%AF%81%E4%B8%8E%E6%8E%88%E6%9D%83"><span class="nav-number">1.13.1.1.</span> <span class="nav-text">1. 身份认证与授权</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-%E8%BE%93%E5%85%A5%E9%AA%8C%E8%AF%81"><span class="nav-number">1.13.1.2.</span> <span class="nav-text">2. 输入验证</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-%E5%AE%89%E5%85%A8%E9%80%9A%E4%BF%A1"><span class="nav-number">1.13.1.3.</span> <span class="nav-text">3. 安全通信</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%80%A7%E8%83%BD%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="nav-number">1.13.2.</span> <span class="nav-text">性能最佳实践</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-%E8%BF%9E%E6%8E%A5%E6%B1%A0%E7%AE%A1%E7%90%86"><span class="nav-number">1.13.2.1.</span> <span class="nav-text">1. 连接池管理</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-%E7%BC%93%E5%AD%98%E7%AD%96%E7%95%A5"><span class="nav-number">1.13.2.2.</span> <span class="nav-text">2. 缓存策略</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-%E5%BC%82%E6%AD%A5%E5%A4%84%E7%90%86"><span class="nav-number">1.13.2.3.</span> <span class="nav-text">3. 异步处理</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BC%80%E5%8F%91%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="nav-number">1.13.3.</span> <span class="nav-text">开发最佳实践</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-%E4%BB%A3%E7%A0%81%E7%BB%84%E7%BB%87"><span class="nav-number">1.13.3.1.</span> <span class="nav-text">1. 代码组织</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86"><span class="nav-number">1.13.3.2.</span> <span class="nav-text">2. 配置管理</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86"><span class="nav-number">1.13.3.3.</span> <span class="nav-text">3. 错误处理</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BF%90%E7%BB%B4%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="nav-number">1.13.4.</span> <span class="nav-text">运维最佳实践</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-%E7%9B%91%E6%8E%A7%E6%8C%87%E6%A0%87"><span class="nav-number">1.13.4.1.</span> <span class="nav-text">1. 监控指标</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-%E5%81%A5%E5%BA%B7%E6%A3%80%E6%9F%A5"><span class="nav-number">1.13.4.2.</span> <span class="nav-text">2. 健康检查</span></a></li></ol></li></ol></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="三子曰"
      src="https://cdn.jsdelivr.net/gh/MengChangWang/Blog_Image@main/img/avatar.png">
  <p class="site-author-name" itemprop="name">三子曰</p>
  <div class="site-description" itemprop="description">欢迎来到我的博客</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">64</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">6</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">23</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/wangmc1024" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;wangmc1024" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:wangmc1024@gmail.com" title="E-Mail → mailto:wangmc1024@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



      </div>
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; Wed Mar 27 2024 08:00:00 GMT+0800 (中国标准时间) – 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">三子曰</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="站点总字数">753k</span>
</div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script size="300" alpha="0.6" zIndex="-1" src="/lib/canvas-ribbon/canvas-ribbon.js"></script>
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/lozad@1/dist/lozad.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  
  <script>
    (function(){
      var canonicalURL, curProtocol;
      //Get the <link> tag
      var x=document.getElementsByTagName("link");
		//Find the last canonical URL
		if(x.length > 0){
			for (i=0;i<x.length;i++){
				if(x[i].rel.toLowerCase() == 'canonical' && x[i].href){
					canonicalURL=x[i].href;
				}
			}
		}
    //Get protocol
	    if (!canonicalURL){
	    	curProtocol = window.location.protocol.split(':')[0];
	    }
	    else{
	    	curProtocol = canonicalURL.split(':')[0];
	    }
      //Get current URL if the canonical URL does not exist
	    if (!canonicalURL) canonicalURL = window.location.href;
	    //Assign script content. Replace current URL with the canonical URL
      !function(){var e=/([http|https]:\/\/[a-zA-Z0-9\_\.]+\.baidu\.com)/gi,r=canonicalURL,t=document.referrer;if(!e.test(r)){var n=(String(curProtocol).toLowerCase() === 'https')?"https://sp0.baidu.com/9_Q4simg2RQJ8t7jm9iCKT-xh_/s.gif":"//api.share.baidu.com/s.gif";t?(n+="?r="+encodeURIComponent(document.referrer),r&&(n+="&l="+r)):r&&(n+="?l="+r);var i=new Image;i.src=n}}(window);})();
  </script>















  

  

<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.css">

<script>
NexT.utils.loadComments(document.querySelector('#gitalk-container'), () => {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js', () => {
    var gitalk = new Gitalk({
      clientID    : '2719e26e1ea715ee8429',
      clientSecret: '77a4ce8e9410a002f05c8f2c2b398c952a012d7c',
      repo        : 'wangmc1024.github.io',
      owner       : 'wangmc1024',
      admin       : ['wangmc1024'],
      id          : 'e4df1d073269b17f988dafd7c86b435c',
        language: 'zh-CN',
      distractionFreeMode: true
    });
    gitalk.render('gitalk-container');
  }, window.Gitalk);
});
</script>



</body>
</html>

<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 8.0.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"wangmc1024.github.io","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":false,"style":"mac"},"back2top":{"enable":true,"sidebar":true,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":"gitalk","storage":true,"lazyload":false,"nav":null,"activeClass":"gitalk"},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"db.json"};
  </script>

  <meta name="description" content="如题，结合官方文档与网络帖子，利用AI整理">
<meta property="og:type" content="article">
<meta property="og:title" content="PyBind11使用指北(补充)">
<meta property="og:url" content="https://wangmc1024.github.io/2025/09/09/C++/pybind11%20%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97%20-%20%E5%AE%98%E6%96%B9%E6%96%87%E6%A1%A3%E8%A1%A5%E5%85%85%E5%86%85%E5%AE%B9/index.html">
<meta property="og:site_name" content="Computer Science">
<meta property="og:description" content="如题，结合官方文档与网络帖子，利用AI整理">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2025-09-09T08:00:00.000Z">
<meta property="article:modified_time" content="2025-10-19T11:05:00.158Z">
<meta property="article:author" content="三子曰">
<meta property="article:tag" content="C++">
<meta property="article:tag" content="python">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://wangmc1024.github.io/2025/09/09/C++/pybind11%20%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97%20-%20%E5%AE%98%E6%96%B9%E6%96%87%E6%A1%A3%E8%A1%A5%E5%85%85%E5%86%85%E5%AE%B9/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>PyBind11使用指北(补充) | Computer Science</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>


<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Computer Science</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">WangMC Blog</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>时间轴</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    


    <main class="main">
      <div class="main-inner">
        <div id="spa-content-wrap" class="content-wrap">
            

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://wangmc1024.github.io/2025/09/09/C++/pybind11%20%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97%20-%20%E5%AE%98%E6%96%B9%E6%96%87%E6%A1%A3%E8%A1%A5%E5%85%85%E5%86%85%E5%AE%B9/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://cdn.jsdelivr.net/gh/MengChangWang/Blog_Image@main/img/avatar.png">
      <meta itemprop="name" content="三子曰">
      <meta itemprop="description" content="欢迎来到我的博客">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Computer Science">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          PyBind11使用指北(补充)
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2025-09-09 16:00:00" itemprop="dateCreated datePublished" datetime="2025-09-09T16:00:00+08:00">2025-09-09</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2025-10-19 19:05:00" itemprop="dateModified" datetime="2025-10-19T19:05:00+08:00">2025-10-19</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%BC%96%E7%A8%8B/" itemprop="url" rel="index"><span itemprop="name">编程</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span id="busuanzi_value_page_pv"></span>
            </span><br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>44k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>40 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <blockquote>
<p>如题，结合官方文档与网络帖子，利用AI整理</p>
</blockquote>
<span id="more"></span>
<h1>pybind11 使用指南 - 官方文档补充内容</h1>
<h2 id="目录">目录</h2>
<ol>
<li class="lvl-3">
<p><a href="#%E9%AB%98%E7%BA%A7%E7%B1%BB%E7%89%B9%E6%80%A7">高级类特性</a></p>
</li>
<li class="lvl-3">
<p><a href="#%E6%9E%84%E5%BB%BA%E7%B3%BB%E7%BB%9F%E8%AF%A6%E8%A7%A3">构建系统详解</a></p>
</li>
<li class="lvl-3">
<p><a href="#%E8%BF%94%E5%9B%9E%E5%80%BC%E7%AD%96%E7%95%A5">返回值策略</a></p>
</li>
<li class="lvl-3">
<p><a href="#%E6%99%BA%E8%83%BD%E6%8C%87%E9%92%88">智能指针</a></p>
</li>
<li class="lvl-3">
<p><a href="#%E7%B1%BB%E5%9E%8B%E8%BD%AC%E6%8D%A2">类型转换</a></p>
</li>
<li class="lvl-3">
<p><a href="#%E5%B5%8C%E5%85%A5python%E8%A7%A3%E9%87%8A%E5%99%A8">嵌入 Python 解释器</a></p>
</li>
<li class="lvl-3">
<p><a href="#%E5%A4%9A%E7%BA%BF%E7%A8%8B%E4%B8%8Egil%E7%AE%A1%E7%90%86">多线程与 GIL 管理</a></p>
</li>
<li class="lvl-3">
<p><a href="#%E5%AD%90%E8%A7%A3%E9%87%8A%E5%99%A8">子解释器</a></p>
</li>
<li class="lvl-3">
<p><a href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E7%B1%BB%E5%9E%8B%E8%BD%AC%E6%8D%A2">自定义类型转换</a></p>
</li>
<li class="lvl-4">
<p><a href="#%E5%85%B6%E4%BB%96%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7">其他高级特性</a></p>
</li>
</ol>
<h2 id="高级类特性">高级类特性</h2>
<h3 id="1-动态属性">1. 动态属性</h3>
<p>默认情况下，C++ 类在 Python 中不支持动态添加属性。要启用此功能，需要使用py::dynamic_attr标签：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;pybind11/pybind11.h&gt;</span><br><span class="line"></span><br><span class="line">namespace py = pybind11;</span><br><span class="line"></span><br><span class="line">class Pet &#123;</span><br><span class="line">public:</span><br><span class="line">    Pet(const std::string&amp; name) : name(name) &#123;&#125;</span><br><span class="line">    </span><br><span class="line">    std::string get_name() const &#123; return name; &#125;</span><br><span class="line">    void set_name(const std::string&amp; new_name) &#123; name = new_name; &#125;</span><br><span class="line"></span><br><span class="line">private:</span><br><span class="line">    std::string name;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">PYBIND11_MODULE(example, m) &#123;</span><br><span class="line">    py::class_&lt;Pet&gt;(m, &quot;Pet&quot;, py::dynamic_attr())</span><br><span class="line">        .def(py::init&lt;const std::string&amp;&gt;())</span><br><span class="line">        .def(&quot;get_name&quot;, &amp;Pet::get_name)</span><br><span class="line">        .def(&quot;set_name&quot;, &amp;Pet::set_name)</span><br><span class="line">        .def_readwrite(&quot;name&quot;, &amp;Pet::name);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Python 使用：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">import example</span><br><span class="line"></span><br><span class="line">p = example.Pet(&quot;小狗&quot;)</span><br><span class="line">p.age = 2  # 动态添加属性</span><br><span class="line">p.color = &quot;棕色&quot;  # 动态添加属性</span><br><span class="line"></span><br><span class="line">print(p.name)   # 输出：小狗</span><br><span class="line">print(p.age)    # 输出：2</span><br><span class="line">print(p.color)  # 输出：棕色</span><br></pre></td></tr></table></figure>
<h3 id="2-继承与自动向下转型">2. 继承与自动向下转型</h3>
<p>对于多态类（含有虚函数），pybind11 会自动进行向下转型：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;pybind11/pybind11.h&gt;</span><br><span class="line">#include &lt;string&gt;</span><br><span class="line"></span><br><span class="line">namespace py = pybind11;</span><br><span class="line"></span><br><span class="line">class Animal &#123;</span><br><span class="line">public:</span><br><span class="line">    virtual ~Animal() = default;</span><br><span class="line">    virtual std::string speak() const = 0;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">class Dog : public Animal &#123;</span><br><span class="line">public:</span><br><span class="line">    std::string speak() const override &#123;</span><br><span class="line">        return &quot;汪汪！&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">class Cat : public Animal &#123;</span><br><span class="line">public:</span><br><span class="line">    std::string speak() const override &#123;</span><br><span class="line">        return &quot;喵喵！&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">// 返回基类指针</span><br><span class="line">Animal* create_animal(const std::string&amp; type) &#123;</span><br><span class="line">    if (type == &quot;dog&quot;) return new Dog();</span><br><span class="line">    if (type == &quot;cat&quot;) return new Cat();</span><br><span class="line">    throw std::invalid_argument(&quot;未知动物类型&quot;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PYBIND11_MODULE(example, m) &#123;</span><br><span class="line">    py::class_&lt;Animal&gt;(m, &quot;Animal&quot;)</span><br><span class="line">        .def(&quot;speak&quot;, &amp;Animal::speak);</span><br><span class="line">    </span><br><span class="line">    py::class_&lt;Dog, Animal&gt;(m, &quot;Dog&quot;)</span><br><span class="line">        .def(py::init&lt;&gt;());</span><br><span class="line">    </span><br><span class="line">    py::class_&lt;Cat, Animal&gt;(m, &quot;Cat&quot;)</span><br><span class="line">        .def(py::init&lt;&gt;());</span><br><span class="line">    </span><br><span class="line">    m.def(&quot;create_animal&quot;, &amp;create_animal, </span><br><span class="line">          py::return_value_policy::take_ownership);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Python 使用：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">import example</span><br><span class="line"></span><br><span class="line">animal = example.create_animal(&quot;dog&quot;)</span><br><span class="line">print(type(animal))  # 输出：&lt;class &#x27;example.Dog&#x27;&gt;（自动向下转型）</span><br><span class="line">print(animal.speak())  # 输出：汪汪！</span><br></pre></td></tr></table></figure>
<h3 id="3-运算符重载">3. 运算符重载</h3>
<p>使用pybind11/operators.h头文件支持运算符重载：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;pybind11/pybind11.h&gt;</span><br><span class="line">#include &lt;pybind11/operators.h&gt;</span><br><span class="line"></span><br><span class="line">namespace py = pybind11;</span><br><span class="line"></span><br><span class="line">class Vector2 &#123;</span><br><span class="line">public:</span><br><span class="line">    float x, y;</span><br><span class="line">    </span><br><span class="line">    Vector2(float x = 0, float y = 0) : x(x), y(y) &#123;&#125;</span><br><span class="line">    </span><br><span class="line">    Vector2 operator+(const Vector2&amp; other) const &#123;</span><br><span class="line">        return Vector2(x + other.x, y + other.y);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    Vector2 operator*(float scalar) const &#123;</span><br><span class="line">        return Vector2(x * scalar, y * scalar);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    bool operator==(const Vector2&amp; other) const &#123;</span><br><span class="line">        return x == other.x &amp;&amp; y == other.y;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">PYBIND11_MODULE(example, m) &#123;</span><br><span class="line">    py::class_&lt;Vector2&gt;(m, &quot;Vector2&quot;)</span><br><span class="line">        .def(py::init&lt;float, float&gt;())</span><br><span class="line">        .def_readwrite(&quot;x&quot;, &amp;Vector2::x)</span><br><span class="line">        .def_readwrite(&quot;y&quot;, &amp;Vector2::y)</span><br><span class="line">        </span><br><span class="line">        // 运算符重载</span><br><span class="line">        .def(py::self + py::self)          // + 运算符</span><br><span class="line">        .def(py::self * float())           // * 运算符（向量 * 标量）</span><br><span class="line">        .def(float() * py::self)           // * 运算符（标量 * 向量）</span><br><span class="line">        .def(py::self == py::self);        // == 运算符</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="4-枚举类型绑定">4. 枚举类型绑定</h3>
<p>使用py::native_enum绑定 C++ 枚举到 Python 原生枚举：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;pybind11/pybind11.h&gt;</span><br><span class="line">#include &lt;pybind11/native_enum.h&gt;</span><br><span class="line"></span><br><span class="line">namespace py = pybind11;</span><br><span class="line"></span><br><span class="line">class Pet &#123;</span><br><span class="line">public:</span><br><span class="line">    enum class Kind &#123;</span><br><span class="line">        Dog,</span><br><span class="line">        Cat,</span><br><span class="line">        Bird</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    enum Attributes &#123;</span><br><span class="line">        None = 0,</span><br><span class="line">        Friendly = 1 &lt;&lt; 0,</span><br><span class="line">        Playful = 1 &lt;&lt; 1,</span><br><span class="line">        Lazy = 1 &lt;&lt; 2</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    Pet(const std::string&amp; name, Kind kind) </span><br><span class="line">        : name(name), kind(kind), attributes(None) &#123;&#125;</span><br><span class="line">    </span><br><span class="line">    std::string name;</span><br><span class="line">    Kind kind;</span><br><span class="line">    Attributes attributes;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">PYBIND11_MODULE(example, m) &#123;</span><br><span class="line">    py::class_&lt;Pet&gt;(m, &quot;Pet&quot;)</span><br><span class="line">        .def(py::init&lt;const std::string&amp;, Pet::Kind&gt;())</span><br><span class="line">        .def_readwrite(&quot;name&quot;, &amp;Pet::name)</span><br><span class="line">        .def_readwrite(&quot;kind&quot;, &amp;Pet::kind)</span><br><span class="line">        .def_readwrite(&quot;attributes&quot;, &amp;Pet::attributes);</span><br><span class="line">    </span><br><span class="line">    // 绑定枚举</span><br><span class="line">    py::native_enum&lt;Pet::Kind&gt;(m, &quot;Kind&quot;)</span><br><span class="line">        .value(&quot;Dog&quot;, Pet::Kind::Dog)</span><br><span class="line">        .value(&quot;Cat&quot;, Pet::Kind::Cat)</span><br><span class="line">        .value(&quot;Bird&quot;, Pet::Kind::Bird)</span><br><span class="line">        .export_values()</span><br><span class="line">        .finalize();</span><br><span class="line">    </span><br><span class="line">    py::native_enum&lt;Pet::Attributes&gt;(m, &quot;Attributes&quot;)</span><br><span class="line">        .value(&quot;None&quot;, Pet::Attributes::None)</span><br><span class="line">        .value(&quot;Friendly&quot;, Pet::Attributes::Friendly)</span><br><span class="line">        .value(&quot;Playful&quot;, Pet::Attributes::Playful)</span><br><span class="line">        .value(&quot;Lazy&quot;, Pet::Attributes::Lazy)</span><br><span class="line">        .export_values()</span><br><span class="line">        .finalize();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="构建系统详解">构建系统详解</h2>
<h3 id="1-CMake-构建">1. CMake 构建</h3>
<p><strong>基础 CMakeLists.txt：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">cmake_minimum_required(VERSION 3.15...3.27)</span><br><span class="line">project(example LANGUAGES CXX)</span><br><span class="line"></span><br><span class="line"># 查找pybind11</span><br><span class="line">find_package(pybind11 CONFIG REQUIRED)</span><br><span class="line"></span><br><span class="line"># 创建Python扩展模块</span><br><span class="line">pybind11_add_module(example example.cpp)</span><br><span class="line"></span><br><span class="line"># 安装到当前目录</span><br><span class="line">install(TARGETS example DESTINATION .)</span><br></pre></td></tr></table></figure>
<p><strong>高级 CMake 配置：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">cmake_minimum_required(VERSION 3.15...3.27)</span><br><span class="line">project(example LANGUAGES CXX)</span><br><span class="line"></span><br><span class="line"># 设置C++标准</span><br><span class="line">set(CMAKE_CXX_STANDARD 17)</span><br><span class="line">set(CMAKE_CXX_STANDARD_REQUIRED ON)</span><br><span class="line">set(CMAKE_CXX_EXTENSIONS OFF)</span><br><span class="line"></span><br><span class="line"># 查找Python</span><br><span class="line">find_package(Python COMPONENTS Interpreter Development REQUIRED)</span><br><span class="line"></span><br><span class="line"># 查找pybind11</span><br><span class="line">find_package(pybind11 CONFIG REQUIRED)</span><br><span class="line"></span><br><span class="line"># 创建扩展模块</span><br><span class="line">pybind11_add_module(example </span><br><span class="line">    src/bindings.cpp</span><br><span class="line">    src/algorithm.cpp</span><br><span class="line">    src/data_structures.cpp</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"># 设置编译选项</span><br><span class="line">target_compile_options(example PRIVATE</span><br><span class="line">    -O3</span><br><span class="line">    -Wall</span><br><span class="line">    -Wextra</span><br><span class="line">    -Wpedantic</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"># 设置链接选项</span><br><span class="line">target_link_libraries(example PRIVATE</span><br><span class="line">    pybind11::module</span><br><span class="line">    my_custom_library</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"># 设置安装路径</span><br><span class="line">install(TARGETS example </span><br><span class="line">    DESTINATION $&#123;CMAKE_CURRENT_SOURCE_DIR&#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<h3 id="2-pyproject-toml-构建">2. pyproject.toml 构建</h3>
<p><strong>使用 scikit-build-core：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[build-system]</span><br><span class="line">requires = [&quot;scikit-build-core&gt;=0.5&quot;, &quot;pybind11&gt;=2.11&quot;]</span><br><span class="line">build-backend = &quot;scikit_build_core.build&quot;</span><br><span class="line"></span><br><span class="line">[project]</span><br><span class="line">name = &quot;example&quot;</span><br><span class="line">version = &quot;0.1.0&quot;</span><br><span class="line">authors = [</span><br><span class="line">    &#123; name = &quot;Your Name&quot;, email = &quot;your.email@example.com&quot; &#125;</span><br><span class="line">]</span><br><span class="line">description = &quot;pybind11示例项目&quot;</span><br><span class="line">long_description = file: &quot;README.md&quot;</span><br><span class="line">long_description_content_type = &quot;text/markdown&quot;</span><br><span class="line">requires-python = &quot;&gt;=3.8&quot;</span><br></pre></td></tr></table></figure>
<p><strong>使用 meson-python：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[build-system]</span><br><span class="line">requires = [&quot;meson-python&gt;=0.12&quot;, &quot;pybind11&gt;=2.11&quot;]</span><br><span class="line">build-backend = &quot;mesonpy&quot;</span><br><span class="line"></span><br><span class="line">[project]</span><br><span class="line">name = &quot;example&quot;</span><br><span class="line">version = &quot;0.1.0&quot;</span><br></pre></td></tr></table></figure>
<h3 id="3-setuptools-构建高级配置">3. setuptools 构建高级配置</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line">from setuptools import setup, Extension</span><br><span class="line">from pybind11.setup_helpers import Pybind11Extension, build_ext</span><br><span class="line">from pybind11 import get_cmake_dir</span><br><span class="line">import glob</span><br><span class="line"></span><br><span class="line"># 并行编译</span><br><span class="line">def parallel_compile_test_parallel_compile(self, sources, output_dir=None, macros=None,</span><br><span class="line">                                          include_dirs=None, debug=0, extra_preargs=None,</span><br><span class="line">                                          extra_postargs=None, depends=None):</span><br><span class="line">    import multiprocessing</span><br><span class="line">    from setuptools._distutils.ccompiler import CCompiler</span><br><span class="line">    from setuptools._distutils import log</span><br><span class="line"></span><br><span class="line">    # 复制原始实现</span><br><span class="line">    original_compile = CCompiler._compile</span><br><span class="line"></span><br><span class="line">    def _compile_single(source):</span><br><span class="line">        return original_compile(self, source, output_dir, macros, include_dirs,</span><br><span class="line">                               debug, extra_preargs, extra_postargs, depends)</span><br><span class="line"></span><br><span class="line">    # 使用多进程编译</span><br><span class="line">    if not sources:</span><br><span class="line">        return</span><br><span class="line">    num_jobs = multiprocessing.cpu_count()</span><br><span class="line">    log.info(f&quot;Using &#123;num_jobs&#125; parallel jobs for compilation&quot;)</span><br><span class="line">    </span><br><span class="line">    import multiprocessing.pool</span><br><span class="line">    pool = multiprocessing.pool.ThreadPool(num_jobs)</span><br><span class="line">    try:</span><br><span class="line">        pool.map(_compile_single, sources)</span><br><span class="line">    finally:</span><br><span class="line">        pool.close()</span><br><span class="line">        pool.join()</span><br><span class="line"></span><br><span class="line"># 应用并行编译补丁</span><br><span class="line">import setuptools._distutils.ccompiler</span><br><span class="line">setuptools._distutils.ccompiler.CCompiler._compile = parallel_compile_test_parallel_compile</span><br><span class="line"></span><br><span class="line"># 扩展模块</span><br><span class="line">ext_modules = [</span><br><span class="line">    Pybind11Extension(</span><br><span class="line">        &quot;example.core&quot;,</span><br><span class="line">        sorted(glob.glob(&quot;src/core/*.cpp&quot;)),</span><br><span class="line">        include_dirs=[&quot;src/include&quot;],</span><br><span class="line">        libraries=[&quot;my_custom_lib&quot;],</span><br><span class="line">        library_dirs=[&quot;lib&quot;],</span><br><span class="line">        extra_compile_args=[&quot;-O3&quot;, &quot;-std=c++17&quot;, &quot;-Wall&quot;],</span><br><span class="line">        extra_link_args=[&quot;-Wl,-rpath,$ORIGIN/lib&quot;],</span><br><span class="line">    ),</span><br><span class="line">    Pybind11Extension(</span><br><span class="line">        &quot;example.utils&quot;,</span><br><span class="line">        sorted(glob.glob(&quot;src/utils/*.cpp&quot;)),</span><br><span class="line">        include_dirs=[&quot;src/include&quot;],</span><br><span class="line">        extra_compile_args=[&quot;-O3&quot;, &quot;-std=c++17&quot;],</span><br><span class="line">    ),</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">setup(</span><br><span class="line">    name=&quot;example&quot;,</span><br><span class="line">    version=&quot;1.0.0&quot;,</span><br><span class="line">    author=&quot;Your Name&quot;,</span><br><span class="line">    author_email=&quot;your.email@example.com&quot;,</span><br><span class="line">    description=&quot;pybind11示例项目&quot;,</span><br><span class="line">    long_description=open(&quot;README.md&quot;).read(),</span><br><span class="line">    long_description_content_type=&quot;text/markdown&quot;,</span><br><span class="line">    url=&quot;https://github.com/yourusername/example&quot;,</span><br><span class="line">    ext_modules=ext_modules,</span><br><span class="line">    cmdclass=&#123;&quot;build_ext&quot;: build_ext&#125;,</span><br><span class="line">    zip_safe=False,</span><br><span class="line">    packages=[&quot;example&quot;],</span><br><span class="line">    package_dir=&#123;&quot;example&quot;: &quot;python/example&quot;&#125;,</span><br><span class="line">    package_data=&#123;&quot;example&quot;: [&quot;py.typed&quot;]&#125;,</span><br><span class="line">    classifiers=[</span><br><span class="line">        &quot;Programming Language :: C++&quot;,</span><br><span class="line">        &quot;Programming Language :: Python :: 3&quot;,</span><br><span class="line">        &quot;License :: OSI Approved :: MIT License&quot;,</span><br><span class="line">        &quot;Operating System :: OS Independent&quot;,</span><br><span class="line">    ],</span><br><span class="line">    python_requires=&quot;&gt;=3.8&quot;,</span><br><span class="line">    install_requires=[&quot;numpy&gt;=1.21&quot;],</span><br><span class="line">    extras_require=&#123;</span><br><span class="line">        &quot;dev&quot;: [</span><br><span class="line">            &quot;pytest&gt;=6.0&quot;,</span><br><span class="line">            &quot;pytest-cov&gt;=2.0&quot;,</span><br><span class="line">            &quot;black&gt;=21.0&quot;,</span><br><span class="line">            &quot;flake8&gt;=3.9&quot;,</span><br><span class="line">        ]</span><br><span class="line">    &#125;,</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<h2 id="返回值策略">返回值策略</h2>
<h3 id="1-策略概述">1. 策略概述</h3>
<table>
<thead>
<tr>
<th>策略</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>return_value_policy::take_ownership</td>
<td>接管现有对象的所有权，Python 会在引用计数为零时删除对象</td>
</tr>
<tr>
<td>return_value_policy::copy</td>
<td>创建返回对象的副本，由 Python 拥有</td>
</tr>
<tr>
<td>return_value_policy::move</td>
<td>使用 std::move 转移内容到新实例</td>
</tr>
<tr>
<td>return_value_policy::reference</td>
<td>引用现有对象但不接管所有权</td>
</tr>
<tr>
<td>return_value_policy::reference_internal</td>
<td>引用内部对象，确保父对象存活</td>
</tr>
<tr>
<td>return_value_policy::automatic</td>
<td>自动选择策略（默认）</td>
</tr>
<tr>
<td>return_value_policy::automatic_reference</td>
<td>类似 automatic，但对指针使用 reference 策略</td>
</tr>
</tbody>
</table>
<h3 id="2-使用示例">2. 使用示例</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;pybind11/pybind11.h&gt;</span><br><span class="line">#include &lt;memory&gt;</span><br><span class="line"></span><br><span class="line">namespace py = pybind11;</span><br><span class="line"></span><br><span class="line">class MyClass &#123;</span><br><span class="line">public:</span><br><span class="line">    MyClass(int value) : value(value) &#123;&#125;</span><br><span class="line">    int get_value() const &#123; return value; &#125;</span><br><span class="line">    </span><br><span class="line">private:</span><br><span class="line">    int value;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">// 静态对象 - 使用reference策略</span><br><span class="line">MyClass static_instance(42);</span><br><span class="line">MyClass&amp; get_static_instance() &#123;</span><br><span class="line">    return static_instance;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 动态分配 - 使用take_ownership策略</span><br><span class="line">MyClass* create_instance(int value) &#123;</span><br><span class="line">    return new MyClass(value);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 内部对象 - 使用reference_internal策略</span><br><span class="line">class Container &#123;</span><br><span class="line">public:</span><br><span class="line">    Container() : internal(100) &#123;&#125;</span><br><span class="line">    MyClass&amp; get_internal() &#123; return internal; &#125;</span><br><span class="line">    </span><br><span class="line">private:</span><br><span class="line">    MyClass internal;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">PYBIND11_MODULE(example, m) &#123;</span><br><span class="line">    py::class_&lt;MyClass&gt;(m, &quot;MyClass&quot;)</span><br><span class="line">        .def(py::init&lt;int&gt;())</span><br><span class="line">        .def(&quot;get_value&quot;, &amp;MyClass::get_value);</span><br><span class="line">    </span><br><span class="line">    py::class_&lt;Container&gt;(m, &quot;Container&quot;)</span><br><span class="line">        .def(py::init&lt;&gt;())</span><br><span class="line">        .def(&quot;get_internal&quot;, &amp;Container::get_internal, </span><br><span class="line">             py::return_value_policy::reference_internal);</span><br><span class="line">    </span><br><span class="line">    // 静态对象 - 使用reference策略</span><br><span class="line">    m.def(&quot;get_static_instance&quot;, &amp;get_static_instance, </span><br><span class="line">          py::return_value_policy::reference);</span><br><span class="line">    </span><br><span class="line">    // 动态对象 - 使用take_ownership策略</span><br><span class="line">    m.def(&quot;create_instance&quot;, &amp;create_instance, </span><br><span class="line">          py::return_value_policy::take_ownership);</span><br><span class="line">    </span><br><span class="line">    // 智能指针 - 自动处理</span><br><span class="line">    m.def(&quot;create_shared&quot;, []() &#123;</span><br><span class="line">        return std::make_shared&lt;MyClass&gt;(200);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="3-常见错误及解决方案">3. 常见错误及解决方案</h3>
<p><strong>错误示例：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// 危险！静态对象使用默认策略会导致double free</span><br><span class="line">m.def(&quot;get_static&quot;, &amp;get_static_instance);  // 错误</span><br></pre></td></tr></table></figure>
<p><strong>正确做法：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// 正确：使用reference策略</span><br><span class="line">m.def(&quot;get_static&quot;, &amp;get_static_instance, py::return_value_policy::reference);</span><br></pre></td></tr></table></figure>
<h2 id="智能指针">智能指针</h2>
<h3 id="1-py-smart-holder（推荐）">1. py::smart_holder（推荐）</h3>
<p>pybind11 v3 引入的智能持有者，支持双向转换：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;pybind11/pybind11.h&gt;</span><br><span class="line">#include &lt;memory&gt;</span><br><span class="line"></span><br><span class="line">namespace py = pybind11;</span><br><span class="line"></span><br><span class="line">class MyClass &#123;</span><br><span class="line">public:</span><br><span class="line">    MyClass(int value) : value(value) &#123;&#125;</span><br><span class="line">    int get_value() const &#123; return value; &#125;</span><br><span class="line">    </span><br><span class="line">private:</span><br><span class="line">    int value;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">PYBIND11_MODULE(example, m) &#123;</span><br><span class="line">    // 使用py::smart_holder</span><br><span class="line">    py::class_&lt;MyClass, py::smart_holder&gt;(m, &quot;MyClass&quot;)</span><br><span class="line">        .def(py::init&lt;int&gt;())</span><br><span class="line">        .def(&quot;get_value&quot;, &amp;MyClass::get_value);</span><br><span class="line">    </span><br><span class="line">    // 支持unique_ptr和shared_ptr双向转换</span><br><span class="line">    m.def(&quot;create_unique&quot;, []() &#123;</span><br><span class="line">        return std::make_unique&lt;MyClass&gt;(10);</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    m.def(&quot;create_shared&quot;, []() &#123;</span><br><span class="line">        return std::make_shared&lt;MyClass&gt;(20);</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    m.def(&quot;process_unique&quot;, [](std::unique_ptr&lt;MyClass&gt; ptr) &#123;</span><br><span class="line">        return ptr-&gt;get_value() * 2;</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    m.def(&quot;process_shared&quot;, [](std::shared_ptr&lt;MyClass&gt; ptr) &#123;</span><br><span class="line">        return ptr-&gt;get_value() * 3;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Python 使用：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">import example</span><br><span class="line"></span><br><span class="line"># 从Python传递到C++</span><br><span class="line">obj = example.MyClass(5)</span><br><span class="line">print(example.process_unique(obj))  # 输出：10（obj不再有效）</span><br><span class="line"></span><br><span class="line">obj2 = example.MyClass(6)</span><br><span class="line">print(example.process_shared(obj2))  # 输出：18（obj2仍然有效）</span><br><span class="line"></span><br><span class="line"># 从C++返回</span><br><span class="line">unique_obj = example.create_unique()</span><br><span class="line">shared_obj = example.create_shared()</span><br></pre></td></tr></table></figure>
<h3 id="2-std-unique-ptr">2. std::unique_ptr</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;pybind11/pybind11.h&gt;</span><br><span class="line">#include &lt;memory&gt;</span><br><span class="line"></span><br><span class="line">namespace py = pybind11;</span><br><span class="line"></span><br><span class="line">class MyClass &#123;</span><br><span class="line">public:</span><br><span class="line">    MyClass(int value) : value(value) &#123;&#125;</span><br><span class="line">    int get_value() const &#123; return value; &#125;</span><br><span class="line">    </span><br><span class="line">private:</span><br><span class="line">    int value;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">PYBIND11_MODULE(example, m) &#123;</span><br><span class="line">    py::class_&lt;MyClass&gt;(m, &quot;MyClass&quot;)</span><br><span class="line">        .def(py::init&lt;int&gt;())</span><br><span class="line">        .def(&quot;get_value&quot;, &amp;MyClass::get_value);</span><br><span class="line">    </span><br><span class="line">    // 返回unique_ptr</span><br><span class="line">    m.def(&quot;create&quot;, []() &#123;</span><br><span class="line">        return std::make_unique&lt;MyClass&gt;(10);</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    // 接受unique_ptr（会转移所有权）</span><br><span class="line">    m.def(&quot;take_ownership&quot;, [](std::unique_ptr&lt;MyClass&gt; ptr) &#123;</span><br><span class="line">        return ptr-&gt;get_value();</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="3-std-shared-ptr">3. std::shared_ptr</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;pybind11/pybind11.h&gt;</span><br><span class="line">#include &lt;memory&gt;</span><br><span class="line"></span><br><span class="line">namespace py = pybind11;</span><br><span class="line"></span><br><span class="line">class MyClass &#123;</span><br><span class="line">public:</span><br><span class="line">    MyClass(int value) : value(value) &#123;&#125;</span><br><span class="line">    int get_value() const &#123; return value; &#125;</span><br><span class="line">    </span><br><span class="line">private:</span><br><span class="line">    int value;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">PYBIND11_MODULE(example, m) &#123;</span><br><span class="line">    // 使用shared_ptr作为持有者</span><br><span class="line">    py::class_&lt;MyClass, std::shared_ptr&lt;MyClass&gt;&gt;(m, &quot;MyClass&quot;)</span><br><span class="line">        .def(py::init&lt;int&gt;())</span><br><span class="line">        .def(&quot;get_value&quot;, &amp;MyClass::get_value);</span><br><span class="line">    </span><br><span class="line">    m.def(&quot;create&quot;, []() &#123;</span><br><span class="line">        return std::make_shared&lt;MyClass&gt;(10);</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    m.def(&quot;share&quot;, [](std::shared_ptr&lt;MyClass&gt; ptr) &#123;</span><br><span class="line">        return ptr;  // 共享所有权</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="4-自定义智能指针">4. 自定义智能指针</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;pybind11/pybind11.h&gt;</span><br><span class="line">#include &lt;memory&gt;</span><br><span class="line"></span><br><span class="line">namespace py = pybind11;</span><br><span class="line"></span><br><span class="line">// 自定义智能指针</span><br><span class="line">template &lt;typename T&gt;</span><br><span class="line">class MySmartPtr &#123;</span><br><span class="line">public:</span><br><span class="line">    MySmartPtr(T* ptr) : ptr(ptr) &#123;&#125;</span><br><span class="line">    ~MySmartPtr() &#123; delete ptr; &#125;</span><br><span class="line">    </span><br><span class="line">    T* get() const &#123; return ptr; &#125;</span><br><span class="line">    T&amp; operator*() const &#123; return *ptr; &#125;</span><br><span class="line">    T* operator-&gt;() const &#123; return ptr; &#125;</span><br><span class="line">    </span><br><span class="line">private:</span><br><span class="line">    T* ptr;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">class MyClass &#123;</span><br><span class="line">public:</span><br><span class="line">    MyClass(int value) : value(value) &#123;&#125;</span><br><span class="line">    int get_value() const &#123; return value; &#125;</span><br><span class="line">    </span><br><span class="line">private:</span><br><span class="line">    int value;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">// 声明自定义持有者类型</span><br><span class="line">PYBIND11_DECLARE_HOLDER_TYPE(T, MySmartPtr&lt;T&gt;)</span><br><span class="line"></span><br><span class="line">// 特化holder_helper（如果需要）</span><br><span class="line">namespace pybind11 &#123; namespace detail &#123;</span><br><span class="line">    template &lt;typename T&gt;</span><br><span class="line">    struct holder_helper&lt;MySmartPtr&lt;T&gt;&gt; &#123;</span><br><span class="line">        static const T* get(const MySmartPtr&lt;T&gt;&amp; p) &#123; return p.get(); &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;&#125;</span><br><span class="line"></span><br><span class="line">PYBIND11_MODULE(example, m) &#123;</span><br><span class="line">    py::class_&lt;MyClass, MySmartPtr&lt;MyClass&gt;&gt;(m, &quot;MyClass&quot;)</span><br><span class="line">        .def(py::init&lt;int&gt;())</span><br><span class="line">        .def(&quot;get_value&quot;, &amp;MyClass::get_value);</span><br><span class="line">    </span><br><span class="line">    m.def(&quot;create&quot;, []() &#123;</span><br><span class="line">        return MySmartPtr&lt;MyClass&gt;(new MyClass(10));</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="类型转换">类型转换</h2>
<h3 id="1-基础类型转换">1. 基础类型转换</h3>
<p>pybind11 支持以下基础类型的自动转换：</p>
<table>
<thead>
<tr>
<th>C++ 类型</th>
<th>Python 类型</th>
</tr>
</thead>
<tbody>
<tr>
<td>bool</td>
<td>bool</td>
</tr>
<tr>
<td>char</td>
<td>str (长度 1)</td>
</tr>
<tr>
<td>signed char</td>
<td>int</td>
</tr>
<tr>
<td>unsigned char</td>
<td>int</td>
</tr>
<tr>
<td>short</td>
<td>int</td>
</tr>
<tr>
<td>unsigned short</td>
<td>int</td>
</tr>
<tr>
<td>int</td>
<td>int</td>
</tr>
<tr>
<td>unsigned int</td>
<td>int</td>
</tr>
<tr>
<td>long</td>
<td>int</td>
</tr>
<tr>
<td>unsigned long</td>
<td>int</td>
</tr>
<tr>
<td>long long</td>
<td>int</td>
</tr>
<tr>
<td>unsigned long long</td>
<td>int</td>
</tr>
<tr>
<td>float</td>
<td>float</td>
</tr>
<tr>
<td>double</td>
<td>float</td>
</tr>
<tr>
<td>long double</td>
<td>float</td>
</tr>
<tr>
<td>const char*</td>
<td>str</td>
</tr>
<tr>
<td>std::string</td>
<td>str</td>
</tr>
<tr>
<td>std::wstring</td>
<td>str (UTF-8)</td>
</tr>
</tbody>
</table>
<h3 id="2-STL-容器转换">2. STL 容器转换</h3>
<p>需要包含pybind11/stl.h头文件：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;pybind11/pybind11.h&gt;</span><br><span class="line">#include &lt;pybind11/stl.h&gt;</span><br><span class="line">#include &lt;vector&gt;</span><br><span class="line">#include &lt;list&gt;</span><br><span class="line">#include &lt;map&gt;</span><br><span class="line">#include &lt;set&gt;</span><br><span class="line">#include &lt;unordered_map&gt;</span><br><span class="line">#include &lt;unordered_set&gt;</span><br><span class="line"></span><br><span class="line">namespace py = pybind11;</span><br><span class="line"></span><br><span class="line">// 向量转换</span><br><span class="line">std::vector&lt;int&gt; double_vector(const std::vector&lt;int&gt;&amp; v) &#123;</span><br><span class="line">    std::vector&lt;int&gt; result;</span><br><span class="line">    for (int x : v) &#123;</span><br><span class="line">        result.push_back(x * 2);</span><br><span class="line">    &#125;</span><br><span class="line">    return result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 映射转换</span><br><span class="line">std::map&lt;std::string, int&gt; count_words(const std::vector&lt;std::string&gt;&amp; words) &#123;</span><br><span class="line">    std::map&lt;std::string, int&gt; counts;</span><br><span class="line">    for (const auto&amp; word : words) &#123;</span><br><span class="line">        counts[word]++;</span><br><span class="line">    &#125;</span><br><span class="line">    return counts;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 集合转换</span><br><span class="line">std::set&lt;int&gt; unique_elements(const std::vector&lt;int&gt;&amp; v) &#123;</span><br><span class="line">    return std::set&lt;int&gt;(v.begin(), v.end());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PYBIND11_MODULE(example, m) &#123;</span><br><span class="line">    m.def(&quot;double_vector&quot;, &amp;double_vector);</span><br><span class="line">    m.def(&quot;count_words&quot;, &amp;count_words);</span><br><span class="line">    m.def(&quot;unique_elements&quot;, &amp;unique_elements);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Python 使用：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">import example</span><br><span class="line"></span><br><span class="line"># 向量转换</span><br><span class="line">print(example.double_vector([1, 2, 3, 4]))  # 输出：[2, 4, 6, 8]</span><br><span class="line"></span><br><span class="line"># 映射转换</span><br><span class="line">words = [&quot;apple&quot;, &quot;banana&quot;, &quot;apple&quot;, &quot;orange&quot;]</span><br><span class="line">print(example.count_words(words))  # 输出：&#123;&#x27;apple&#x27;: 2, &#x27;banana&#x27;: 1, &#x27;orange&#x27;: 1&#125;</span><br><span class="line"></span><br><span class="line"># 集合转换</span><br><span class="line">print(example.unique_elements([1, 2, 2, 3, 3, 3]))  # 输出：&#123;1, 2, 3&#125;</span><br></pre></td></tr></table></figure>
<h3 id="3-字符串和字节转换">3. 字符串和字节转换</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;pybind11/pybind11.h&gt;</span><br><span class="line">#include &lt;string&gt;</span><br><span class="line">#include &lt;vector&gt;</span><br><span class="line"></span><br><span class="line">namespace py = pybind11;</span><br><span class="line"></span><br><span class="line">// 字符串处理</span><br><span class="line">std::string reverse_string(const std::string&amp; s) &#123;</span><br><span class="line">    return std::string(s.rbegin(), s.rend());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 字节处理</span><br><span class="line">std::vector&lt;uint8_t&gt; process_bytes(const std::vector&lt;uint8_t&gt;&amp; data) &#123;</span><br><span class="line">    std::vector&lt;uint8_t&gt; result;</span><br><span class="line">    for (uint8_t byte : data) &#123;</span><br><span class="line">        result.push_back(byte ^ 0xAA);  // 简单的XOR加密</span><br><span class="line">    &#125;</span><br><span class="line">    return result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PYBIND11_MODULE(example, m) &#123;</span><br><span class="line">    m.def(&quot;reverse_string&quot;, &amp;reverse_string);</span><br><span class="line">    m.def(&quot;process_bytes&quot;, &amp;process_bytes);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="4-时间类型转换">4. 时间类型转换</h3>
<p>需要包含pybind11/chrono.h头文件：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;pybind11/pybind11.h&gt;</span><br><span class="line">#include &lt;pybind11/chrono.h&gt;</span><br><span class="line">#include &lt;chrono&gt;</span><br><span class="line">#include &lt;ctime&gt;</span><br><span class="line"></span><br><span class="line">namespace py = pybind11;</span><br><span class="line">using namespace std::chrono;</span><br><span class="line"></span><br><span class="line">// 时间点转换</span><br><span class="line">system_clock::time_point add_seconds(system_clock::time_point tp, int seconds) &#123;</span><br><span class="line">    return tp + seconds(seconds);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 时间段转换</span><br><span class="line">seconds time_difference(system_clock::time_point start, system_clock::time_point end) &#123;</span><br><span class="line">    return duration_cast&lt;seconds&gt;(end - start);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PYBIND11_MODULE(example, m) &#123;</span><br><span class="line">    m.def(&quot;add_seconds&quot;, &amp;add_seconds);</span><br><span class="line">    m.def(&quot;time_difference&quot;, &amp;time_difference);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Python 使用：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">import example</span><br><span class="line">import datetime</span><br><span class="line"></span><br><span class="line"># 时间点转换</span><br><span class="line">now = datetime.datetime.now()</span><br><span class="line">later = example.add_seconds(now, 3600)  # 加1小时</span><br><span class="line">print(later)</span><br><span class="line"></span><br><span class="line"># 时间段转换</span><br><span class="line">start = datetime.datetime(2023, 1, 1)</span><br><span class="line">end = datetime.datetime(2023, 1, 2)</span><br><span class="line">diff = example.time_difference(start, end)</span><br><span class="line">print(diff.total_seconds())  # 输出：86400.0</span><br></pre></td></tr></table></figure>
<h2 id="嵌入-Python-解释器">嵌入 Python 解释器</h2>
<h3 id="1-基础嵌入">1. 基础嵌入</h3>
<p><strong>CMake 配置：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cmake_minimum_required(VERSION 3.15...3.27)</span><br><span class="line">project(embedded_example LANGUAGES CXX)</span><br><span class="line"></span><br><span class="line">find_package(pybind11 CONFIG REQUIRED)</span><br><span class="line"></span><br><span class="line">add_executable(embedded_example main.cpp)</span><br><span class="line">target_link_libraries(embedded_example PRIVATE pybind11::embed)</span><br></pre></td></tr></table></figure>
<p><strong>C++ 代码：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;pybind11/embed.h&gt;</span><br><span class="line">#include &lt;iostream&gt;</span><br><span class="line"></span><br><span class="line">namespace py = pybind11;</span><br><span class="line"></span><br><span class="line">int main() &#123;</span><br><span class="line">    // 启动Python解释器</span><br><span class="line">    py::scoped_interpreter guard&#123;&#125;;</span><br><span class="line">    </span><br><span class="line">    try &#123;</span><br><span class="line">        // 执行Python代码</span><br><span class="line">        py::print(&quot;Hello from embedded Python!&quot;);</span><br><span class="line">        </span><br><span class="line">        // 使用Python标准库</span><br><span class="line">        py::module math = py::module::import(&quot;math&quot;);</span><br><span class="line">        double result = math.attr(&quot;sqrt&quot;)(25.0).cast&lt;double&gt;();</span><br><span class="line">        std::cout &lt;&lt; &quot;sqrt(25) = &quot; &lt;&lt; result &lt;&lt; std::endl;</span><br><span class="line">        </span><br><span class="line">        // 执行多行Python代码</span><br><span class="line">        py::exec(R&quot;(</span><br><span class="line">            import sys</span><br><span class="line">            print(f&quot;Python version: &#123;sys.version&#125;&quot;)</span><br><span class="line">            </span><br><span class="line">            def add(a, b):</span><br><span class="line">                return a + b</span><br><span class="line">            </span><br><span class="line">            result = add(3, 4)</span><br><span class="line">            print(f&quot;3 + 4 = &#123;result&#125;&quot;)</span><br><span class="line">        )&quot;);</span><br><span class="line">        </span><br><span class="line">        // 调用Python函数</span><br><span class="line">        auto add = py::eval(&quot;add&quot;).cast&lt;py::function&gt;();</span><br><span class="line">        int sum_result = add(5, 6).cast&lt;int&gt;();</span><br><span class="line">        std::cout &lt;&lt; &quot;5 + 6 = &quot; &lt;&lt; sum_result &lt;&lt; std::endl;</span><br><span class="line">        </span><br><span class="line">    &#125; catch (const py::error_already_set&amp; e) &#123;</span><br><span class="line">        std::cerr &lt;&lt; &quot;Python error: &quot; &lt;&lt; e.what() &lt;&lt; std::endl;</span><br><span class="line">        return 1;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // 解释器会在guard析构时自动关闭</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="2-嵌入模块">2. 嵌入模块</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;pybind11/embed.h&gt;</span><br><span class="line">#include &lt;pybind11/pybind11.h&gt;</span><br><span class="line"></span><br><span class="line">namespace py = pybind11;</span><br><span class="line"></span><br><span class="line">// 嵌入的C++模块</span><br><span class="line">PYBIND11_EMBEDDED_MODULE(embedded_module, m) &#123;</span><br><span class="line">    m.def(&quot;multiply&quot;, [](int a, int b) &#123;</span><br><span class="line">        return a * b;</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    m.def(&quot;greet&quot;, [](const std::string&amp; name) &#123;</span><br><span class="line">        return &quot;Hello, &quot; + name + &quot;!&quot;;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">int main() &#123;</span><br><span class="line">    py::scoped_interpreter guard&#123;&#125;;</span><br><span class="line">    </span><br><span class="line">    try &#123;</span><br><span class="line">        // 导入嵌入的模块</span><br><span class="line">        py::module em = py::module::import(&quot;embedded_module&quot;);</span><br><span class="line">        </span><br><span class="line">        // 调用嵌入模块的函数</span><br><span class="line">        int product = em.attr(&quot;multiply&quot;)(3, 4).cast&lt;int&gt;();</span><br><span class="line">        std::cout &lt;&lt; &quot;3 * 4 = &quot; &lt;&lt; product &lt;&lt; std::endl;</span><br><span class="line">        </span><br><span class="line">        std::string greeting = em.attr(&quot;greet&quot;)(&quot;World&quot;).cast&lt;std::string&gt;();</span><br><span class="line">        std::cout &lt;&lt; greeting &lt;&lt; std::endl;</span><br><span class="line">        </span><br><span class="line">        // 在Python中使用嵌入模块</span><br><span class="line">        py::exec(R&quot;(</span><br><span class="line">            result = embedded_module.multiply(5, 6)</span><br><span class="line">            print(f&quot;5 * 6 = &#123;result&#125;&quot;)</span><br><span class="line">            </span><br><span class="line">            message = embedded_module.greet(&quot;Python&quot;)</span><br><span class="line">            print(message)</span><br><span class="line">        )&quot;);</span><br><span class="line">        </span><br><span class="line">    &#125; catch (const py::error_already_set&amp; e) &#123;</span><br><span class="line">        std::cerr &lt;&lt; &quot;Error: &quot; &lt;&lt; e.what() &lt;&lt; std::endl;</span><br><span class="line">        return 1;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="3-导入本地-Python-文件">3. 导入本地 Python 文件</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;pybind11/embed.h&gt;</span><br><span class="line">#include &lt;iostream&gt;</span><br><span class="line">#include &lt;filesystem&gt;</span><br><span class="line"></span><br><span class="line">namespace py = pybind11;</span><br><span class="line">namespace fs = std::filesystem;</span><br><span class="line"></span><br><span class="line">int main() &#123;</span><br><span class="line">    py::scoped_interpreter guard&#123;&#125;;</span><br><span class="line">    </span><br><span class="line">    try &#123;</span><br><span class="line">        // 添加当前目录到Python路径</span><br><span class="line">        py::module sys = py::module::import(&quot;sys&quot;);</span><br><span class="line">        sys.attr(&quot;path&quot;).cast&lt;py::list&gt;().append(fs::current_path().string());</span><br><span class="line">        </span><br><span class="line">        // 导入本地Python模块</span><br><span class="line">        py::module my_module = py::module::import(&quot;my_python_module&quot;);</span><br><span class="line">        </span><br><span class="line">        // 调用Python函数</span><br><span class="line">        int result = my_module.attr(&quot;my_function&quot;)(10, 20).cast&lt;int&gt;();</span><br><span class="line">        std::cout &lt;&lt; &quot;Result from Python: &quot; &lt;&lt; result &lt;&lt; std::endl;</span><br><span class="line">        </span><br><span class="line">    &#125; catch (const py::error_already_set&amp; e) &#123;</span><br><span class="line">        std::cerr &lt;&lt; &quot;Error: &quot; &lt;&lt; e.what() &lt;&lt; std::endl;</span><br><span class="line">        return 1;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="多线程与-GIL-管理">多线程与 GIL 管理</h2>
<h3 id="1-GIL-释放与获取">1. GIL 释放与获取</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;pybind11/pybind11.h&gt;</span><br><span class="line">#include &lt;pybind11/functional.h&gt;</span><br><span class="line">#include &lt;thread&gt;</span><br><span class="line">#include &lt;chrono&gt;</span><br><span class="line">#include &lt;iostream&gt;</span><br><span class="line"></span><br><span class="line">namespace py = pybind11;</span><br><span class="line"></span><br><span class="line">// 长时间运行的C++函数 - 应该释放GIL</span><br><span class="line">void long_running_task() &#123;</span><br><span class="line">    // 释放GIL</span><br><span class="line">    py::gil_scoped_release release;</span><br><span class="line">    </span><br><span class="line">    std::cout &lt;&lt; &quot;Long running task started (thread: &quot; </span><br><span class="line">              &lt;&lt; std::this_thread::get_id() &lt;&lt; &quot;)&quot; &lt;&lt; std::endl;</span><br><span class="line">    </span><br><span class="line">    // 模拟长时间计算</span><br><span class="line">    for (int i = 0; i &lt; 5; ++i) &#123;</span><br><span class="line">        std::this_thread::sleep_for(std::chrono::seconds(1));</span><br><span class="line">        std::cout &lt;&lt; &quot;Task progress: &quot; &lt;&lt; (i + 1) &lt;&lt; &quot;/5&quot; &lt;&lt; std::endl;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    std::cout &lt;&lt; &quot;Long running task completed&quot; &lt;&lt; std::endl;</span><br><span class="line">    </span><br><span class="line">    // GIL会在release析构时自动重新获取</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 使用call_guard自动管理GIL</span><br><span class="line">void task_with_guard() &#123;</span><br><span class="line">    std::cout &lt;&lt; &quot;Task with guard started&quot; &lt;&lt; std::endl;</span><br><span class="line">    std::this_thread::sleep_for(std::chrono::seconds(3));</span><br><span class="line">    std::cout &lt;&lt; &quot;Task with guard completed&quot; &lt;&lt; std::endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 多线程函数</span><br><span class="line">void run_in_threads() &#123;</span><br><span class="line">    std::thread t1(long_running_task);</span><br><span class="line">    std::thread t2(long_running_task);</span><br><span class="line">    </span><br><span class="line">    t1.join();</span><br><span class="line">    t2.join();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PYBIND11_MODULE(example, m) &#123;</span><br><span class="line">    // 直接释放GIL</span><br><span class="line">    m.def(&quot;long_running_task&quot;, &amp;long_running_task);</span><br><span class="line">    </span><br><span class="line">    // 使用call_guard释放GIL</span><br><span class="line">    m.def(&quot;task_with_guard&quot;, &amp;task_with_guard, </span><br><span class="line">          py::call_guard&lt;py::gil_scoped_release&gt;());</span><br><span class="line">    </span><br><span class="line">    // 多线程示例</span><br><span class="line">    m.def(&quot;run_in_threads&quot;, &amp;run_in_threads);</span><br><span class="line">    </span><br><span class="line">    // 线程安全的函数调用</span><br><span class="line">    m.def(&quot;thread_safe_function&quot;, [](int value) &#123;</span><br><span class="line">        // 在关键部分获取GIL</span><br><span class="line">        py::gil_scoped_acquire acquire;</span><br><span class="line">        py::print(&quot;Thread-safe function called with value:&quot;, value);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Python 使用：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">import example</span><br><span class="line">import threading</span><br><span class="line">import time</span><br><span class="line"></span><br><span class="line"># 测试长时间任务</span><br><span class="line">print(&quot;Testing long running task...&quot;)</span><br><span class="line">thread1 = threading.Thread(target=example.long_running_task)</span><br><span class="line">thread2 = threading.Thread(target=example.long_running_task)</span><br><span class="line"></span><br><span class="line">thread1.start()</span><br><span class="line">thread2.start()</span><br><span class="line"></span><br><span class="line"># 主线程可以继续执行其他任务</span><br><span class="line">for i in range(3):</span><br><span class="line">    print(f&quot;Main thread working... &#123;i&#125;&quot;)</span><br><span class="line">    time.sleep(1)</span><br><span class="line"></span><br><span class="line">thread1.join()</span><br><span class="line">thread2.join()</span><br><span class="line"></span><br><span class="line"># 测试带guard的任务</span><br><span class="line">print(&quot;</span><br><span class="line">Testing task with guard...&quot;)</span><br><span class="line">example.task_with_guard()</span><br><span class="line"></span><br><span class="line"># 测试多线程函数</span><br><span class="line">print(&quot;</span><br><span class="line">Testing run in threads...&quot;)</span><br><span class="line">example.run_in_threads()</span><br></pre></td></tr></table></figure>
<h3 id="2-线程局部存储">2. 线程局部存储</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;pybind11/pybind11.h&gt;</span><br><span class="line">#include &lt;thread&gt;</span><br><span class="line">#include &lt;mutex&gt;</span><br><span class="line">#include &lt;iostream&gt;</span><br><span class="line"></span><br><span class="line">namespace py = pybind11;</span><br><span class="line"></span><br><span class="line">// 线程局部存储</span><br><span class="line">thread_local int thread_counter = 0;</span><br><span class="line">std::mutex cout_mutex;</span><br><span class="line"></span><br><span class="line">void thread_function(int id) &#123;</span><br><span class="line">    // 释放GIL</span><br><span class="line">    py::gil_scoped_release release;</span><br><span class="line">    </span><br><span class="line">    for (int i = 0; i &lt; 5; ++i) &#123;</span><br><span class="line">        thread_counter++;</span><br><span class="line">        </span><br><span class="line">        // 安全的输出</span><br><span class="line">        std::lock_guard&lt;std::mutex&gt; lock(cout_mutex);</span><br><span class="line">        std::cout &lt;&lt; &quot;Thread &quot; &lt;&lt; id &lt;&lt; &quot;: counter = &quot; &lt;&lt; thread_counter &lt;&lt; std::endl;</span><br><span class="line">        </span><br><span class="line">        std::this_thread::sleep_for(std::chrono::milliseconds(100));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void start_threads() &#123;</span><br><span class="line">    std::thread t1(thread_function, 1);</span><br><span class="line">    std::thread t2(thread_function, 2);</span><br><span class="line">    </span><br><span class="line">    t1.join();</span><br><span class="line">    t2.join();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PYBIND11_MODULE(example, m) &#123;</span><br><span class="line">    m.def(&quot;start_threads&quot;, &amp;start_threads);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="3-异步任务">3. 异步任务</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;pybind11/pybind11.h&gt;</span><br><span class="line">#include &lt;pybind11/functional.h&gt;</span><br><span class="line">#include &lt;thread&gt;</span><br><span class="line">#include &lt;future&gt;</span><br><span class="line">#include &lt;iostream&gt;</span><br><span class="line"></span><br><span class="line">namespace py = pybind11;</span><br><span class="line"></span><br><span class="line">// 异步执行函数</span><br><span class="line">std::future&lt;int&gt; async_task(int x, int y) &#123;</span><br><span class="line">    return std::async(std::launch::async, [x, y]() &#123;</span><br><span class="line">        // 释放GIL</span><br><span class="line">        py::gil_scoped_release release;</span><br><span class="line">        </span><br><span class="line">        std::cout &lt;&lt; &quot;Async task started (thread: &quot; </span><br><span class="line">                  &lt;&lt; std::this_thread::get_id() &lt;&lt; &quot;)&quot; &lt;&lt; std::endl;</span><br><span class="line">        </span><br><span class="line">        // 模拟计算</span><br><span class="line">        std::this_thread::sleep_for(std::chrono::seconds(2));</span><br><span class="line">        return x + y;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 异步回调</span><br><span class="line">void async_callback(py::function callback, int x, int y) &#123;</span><br><span class="line">    std::thread([callback, x, y]() &#123;</span><br><span class="line">        // 释放GIL</span><br><span class="line">        py::gil_scoped_release release;</span><br><span class="line">        </span><br><span class="line">        std::cout &lt;&lt; &quot;Callback task started&quot; &lt;&lt; std::endl;</span><br><span class="line">        std::this_thread::sleep_for(std::chrono::seconds(2));</span><br><span class="line">        </span><br><span class="line">        // 计算结果</span><br><span class="line">        int result = x * y;</span><br><span class="line">        </span><br><span class="line">        // 调用回调函数时重新获取GIL</span><br><span class="line">        py::gil_scoped_acquire acquire;</span><br><span class="line">        callback(result);</span><br><span class="line">    &#125;).detach();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PYBIND11_MODULE(example, m) &#123;</span><br><span class="line">    m.def(&quot;async_task&quot;, [](int x, int y) &#123;</span><br><span class="line">        auto future = async_task(x, y);</span><br><span class="line">        return future.get();</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    m.def(&quot;async_callback&quot;, &amp;async_callback);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Python 使用：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">import example</span><br><span class="line">import time</span><br><span class="line"></span><br><span class="line"># 测试异步任务</span><br><span class="line">print(&quot;Testing async task...&quot;)</span><br><span class="line">result = example.async_task(3, 4)</span><br><span class="line">print(f&quot;Async result: &#123;result&#125;&quot;)</span><br><span class="line"></span><br><span class="line"># 测试异步回调</span><br><span class="line">def on_complete(result):</span><br><span class="line">    print(f&quot;Callback received: &#123;result&#125;&quot;)</span><br><span class="line"></span><br><span class="line">print(&quot;</span><br><span class="line">Testing async callback...&quot;)</span><br><span class="line">example.async_callback(on_complete, 5, 6)</span><br><span class="line">print(&quot;Callback task started (will complete in 2 seconds)&quot;)</span><br><span class="line"></span><br><span class="line"># 等待回调完成</span><br><span class="line">time.sleep(3)</span><br></pre></td></tr></table></figure>
<h2 id="子解释器">子解释器</h2>
<h3 id="1-基础子解释器使用">1. 基础子解释器使用</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;pybind11/embed.h&gt;</span><br><span class="line">#include &lt;pybind11/subinterpreter.h&gt;</span><br><span class="line">#include &lt;iostream&gt;</span><br><span class="line"></span><br><span class="line">namespace py = pybind11;</span><br><span class="line"></span><br><span class="line">int main() &#123;</span><br><span class="line">    // 初始化主解释器</span><br><span class="line">    py::scoped_interpreter main_guard&#123;&#125;;</span><br><span class="line">    </span><br><span class="line">    try &#123;</span><br><span class="line">        std::cout &lt;&lt; &quot;Main interpreter started&quot; &lt;&lt; std::endl;</span><br><span class="line">        </span><br><span class="line">        // 创建子解释器</span><br><span class="line">        py::subinterpreter sub = py::subinterpreter::create();</span><br><span class="line">        </span><br><span class="line">        &#123;</span><br><span class="line">            // 激活子解释器</span><br><span class="line">            py::subinterpreter_scoped_activate activate(sub);</span><br><span class="line">            </span><br><span class="line">            std::cout &lt;&lt; &quot;Sub-interpreter activated&quot; &lt;&lt; std::endl;</span><br><span class="line">            </span><br><span class="line">            // 在子解释器中执行代码</span><br><span class="line">            py::exec(R&quot;(</span><br><span class="line">                import sys</span><br><span class="line">                print(f&quot;Sub-interpreter Python version: &#123;sys.version&#125;&quot;)</span><br><span class="line">                counter = 42</span><br><span class="line">            )&quot;);</span><br><span class="line">            </span><br><span class="line">            // 获取变量值</span><br><span class="line">            int counter = py::eval(&quot;counter&quot;).cast&lt;int&gt;();</span><br><span class="line">            std::cout &lt;&lt; &quot;Sub-interpreter counter: &quot; &lt;&lt; counter &lt;&lt; std::endl;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        std::cout &lt;&lt; &quot;Sub-interpreter deactivated&quot; &lt;&lt; std::endl;</span><br><span class="line">        </span><br><span class="line">        // 主解释器不受影响</span><br><span class="line">        py::exec(&quot;print(&#x27;Back to main interpreter&#x27;)&quot;);</span><br><span class="line">        </span><br><span class="line">    &#125; catch (const py::error_already_set&amp; e) &#123;</span><br><span class="line">        std::cerr &lt;&lt; &quot;Error: &quot; &lt;&lt; e.what() &lt;&lt; std::endl;</span><br><span class="line">        return 1;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="2-多线程子解释器">2. 多线程子解释器</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;pybind11/embed.h&gt;</span><br><span class="line">#include &lt;pybind11/subinterpreter.h&gt;</span><br><span class="line">#include &lt;thread&gt;</span><br><span class="line">#include &lt;iostream&gt;</span><br><span class="line"></span><br><span class="line">namespace py = pybind11;</span><br><span class="line"></span><br><span class="line">void run_in_subinterpreter(py::subinterpreter sub, int id) &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">        // 激活子解释器</span><br><span class="line">        py::subinterpreter_scoped_activate activate(sub);</span><br><span class="line">        </span><br><span class="line">        std::cout &lt;&lt; &quot;Thread &quot; &lt;&lt; id &lt;&lt; &quot; started in sub-interpreter&quot; &lt;&lt; std::endl;</span><br><span class="line">        </span><br><span class="line">        // 执行Python代码</span><br><span class="line">        py::exec(R&quot;(</span><br><span class="line">            import time</span><br><span class="line">            import threading</span><br><span class="line">            </span><br><span class="line">            def task():</span><br><span class="line">                for i in range(3):</span><br><span class="line">                    print(f&quot;Task &#123;id&#125; iteration &#123;i&#125; (thread: &#123;threading.get_ident()&#125;)&quot;)</span><br><span class="line">                    time.sleep(1)</span><br><span class="line">            </span><br><span class="line">            task()</span><br><span class="line">        )&quot;);</span><br><span class="line">        </span><br><span class="line">        std::cout &lt;&lt; &quot;Thread &quot; &lt;&lt; id &lt;&lt; &quot; completed&quot; &lt;&lt; std::endl;</span><br><span class="line">        </span><br><span class="line">    &#125; catch (const py::error_already_set&amp; e) &#123;</span><br><span class="line">        std::cerr &lt;&lt; &quot;Thread &quot; &lt;&lt; id &lt;&lt; &quot; error: &quot; &lt;&lt; e.what() &lt;&lt; std::endl;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">int main() &#123;</span><br><span class="line">    py::scoped_interpreter main_guard&#123;&#125;;</span><br><span class="line">    </span><br><span class="line">    try &#123;</span><br><span class="line">        // 创建多个子解释器</span><br><span class="line">        py::subinterpreter sub1 = py::subinterpreter::create();</span><br><span class="line">        py::subinterpreter sub2 = py::subinterpreter::create();</span><br><span class="line">        </span><br><span class="line">        // 在不同线程中运行子解释器</span><br><span class="line">        std::thread t1(run_in_subinterpreter, std::move(sub1), 1);</span><br><span class="line">        std::thread t2(run_in_subinterpreter, std::move(sub2), 2);</span><br><span class="line">        </span><br><span class="line">        t1.join();</span><br><span class="line">        t2.join();</span><br><span class="line">        </span><br><span class="line">    &#125; catch (const py::error_already_set&amp; e) &#123;</span><br><span class="line">        std::cerr &lt;&lt; &quot;Main error: &quot; &lt;&lt; e.what() &lt;&lt; std::endl;</span><br><span class="line">        return 1;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="3-子解释器安全最佳实践">3. 子解释器安全最佳实践</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;pybind11/embed.h&gt;</span><br><span class="line">#include &lt;pybind11/subinterpreter.h&gt;</span><br><span class="line">#include &lt;thread&gt;</span><br><span class="line">#include &lt;mutex&gt;</span><br><span class="line">#include &lt;iostream&gt;</span><br><span class="line"></span><br><span class="line">namespace py = pybind11;</span><br><span class="line"></span><br><span class="line">// 线程安全的子解释器管理器</span><br><span class="line">class SubinterpreterManager &#123;</span><br><span class="line">public:</span><br><span class="line">    SubinterpreterManager() : main_guard_&#123;&#125; &#123;&#125;</span><br><span class="line">    </span><br><span class="line">    py::subinterpreter create_subinterpreter() &#123;</span><br><span class="line">        std::lock_guard&lt;std::mutex&gt; lock(mutex_);</span><br><span class="line">        return py::subinterpreter::create();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">private:</span><br><span class="line">    py::scoped_interpreter main_guard_;</span><br><span class="line">    std::mutex mutex_;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">// 安全的任务函数</span><br><span class="line">void safe_task(py::subinterpreter sub, const std::string&amp; name) &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">        // 子解释器作用域</span><br><span class="line">        py::subinterpreter_scoped_activate activate(sub);</span><br><span class="line">        </span><br><span class="line">        // 任务逻辑</span><br><span class="line">        py::exec(R&quot;(</span><br><span class="line">            import time</span><br><span class="line">            </span><br><span class="line">            def safe_operation(name):</span><br><span class="line">                result = []</span><br><span class="line">                for i in range(5):</span><br><span class="line">                    result.append(f&quot;&#123;name&#125;: &#123;i&#125;&quot;)</span><br><span class="line">                    time.sleep(0.1)</span><br><span class="line">                return result</span><br><span class="line">            </span><br><span class="line">            result = safe_operation(name)</span><br><span class="line">            print(f&quot;Task &#123;name&#125; completed with &#123;len(result)&#125; items&quot;)</span><br><span class="line">        )&quot;);</span><br><span class="line">        </span><br><span class="line">    &#125; catch (const py::error_already_set&amp; e) &#123;</span><br><span class="line">        std::cerr &lt;&lt; &quot;Task &quot; &lt;&lt; name &lt;&lt; &quot; failed: &quot; &lt;&lt; e.what() &lt;&lt; std::endl;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">int main() &#123;</span><br><span class="line">    SubinterpreterManager manager;</span><br><span class="line">    </span><br><span class="line">    // 创建并运行多个子解释器任务</span><br><span class="line">    std::vector&lt;std::thread&gt; threads;</span><br><span class="line">    for (int i = 0; i &lt; 3; ++i) &#123;</span><br><span class="line">        py::subinterpreter sub = manager.create_subinterpreter();</span><br><span class="line">        threads.emplace_back(safe_task, std::move(sub), &quot;task_&quot; + std::to_string(i));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // 等待所有线程完成</span><br><span class="line">    for (auto&amp; t : threads) &#123;</span><br><span class="line">        t.join();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="自定义类型转换">自定义类型转换</h2>
<h3 id="1-基础自定义转换器">1. 基础自定义转换器</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;pybind11/pybind11.h&gt;</span><br><span class="line">#include &lt;string&gt;</span><br><span class="line">#include &lt;sstream&gt;</span><br><span class="line"></span><br><span class="line">namespace py = pybind11;</span><br><span class="line"></span><br><span class="line">// 自定义类型</span><br><span class="line">struct Point &#123;</span><br><span class="line">    int x;</span><br><span class="line">    int y;</span><br><span class="line">    </span><br><span class="line">    Point(int x = 0, int y = 0) : x(x), y(y) &#123;&#125;</span><br><span class="line">    </span><br><span class="line">    std::string to_string() const &#123;</span><br><span class="line">        std::stringstream ss;</span><br><span class="line">        ss &lt;&lt; &quot;(&quot; &lt;&lt; x &lt;&lt; &quot;, &quot; &lt;&lt; y &lt;&lt; &quot;)&quot;;</span><br><span class="line">        return ss.str();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">// 自定义类型转换器</span><br><span class="line">namespace pybind11 &#123; namespace detail &#123;</span><br><span class="line">    template &lt;&gt; struct type_caster&lt;Point&gt; &#123;</span><br><span class="line">    public:</span><br><span class="line">        PYBIND11_TYPE_CASTER(Point, _(&quot;Point&quot;));</span><br><span class="line">        </span><br><span class="line">        // 从Python对象转换到C++</span><br><span class="line">        bool load(handle src, bool) &#123;</span><br><span class="line">            if (!src.is_dict()) return false;</span><br><span class="line">            </span><br><span class="line">            py::dict obj = src.cast&lt;py::dict&gt;();</span><br><span class="line">            value.x = obj[&quot;x&quot;].cast&lt;int&gt;();</span><br><span class="line">            value.y = obj[&quot;y&quot;].cast&lt;int&gt;();</span><br><span class="line">            return true;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // 从C++转换到Python对象</span><br><span class="line">        static handle cast(const Point&amp; p, return_value_policy /* policy */, handle /* parent */) &#123;</span><br><span class="line">            py::dict obj;</span><br><span class="line">            obj[&quot;x&quot;] = p.x;</span><br><span class="line">            obj[&quot;y&quot;] = p.y;</span><br><span class="line">            return obj.release();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;&#125;</span><br><span class="line"></span><br><span class="line">PYBIND11_MODULE(example, m) &#123;</span><br><span class="line">    // 使用自定义转换器</span><br><span class="line">    m.def(&quot;add_points&quot;, [](const Point&amp; a, const Point&amp; b) &#123;</span><br><span class="line">        return Point(a.x + b.x, a.y + b.y);</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    m.def(&quot;print_point&quot;, [](const Point&amp; p) &#123;</span><br><span class="line">        py::print(p.to_string());</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Python 使用：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">import example</span><br><span class="line"></span><br><span class="line"># 创建Point对象（通过字典）</span><br><span class="line">p1 = &#123;&quot;x&quot;: 1, &quot;y&quot;: 2&#125;</span><br><span class="line">p2 = &#123;&quot;x&quot;: 3, &quot;y&quot;: 4&#125;</span><br><span class="line"></span><br><span class="line"># 使用自定义转换</span><br><span class="line">result = example.add_points(p1, p2)</span><br><span class="line">print(result)  # 输出：&#123;&#x27;x&#x27;: 4, &#x27;y&#x27;: 6&#125;</span><br><span class="line"></span><br><span class="line">example.print_point(result)  # 输出：(4, 6)</span><br></pre></td></tr></table></figure>
<h3 id="2-支持多种-Python-类型的转换器">2. 支持多种 Python 类型的转换器</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;pybind11/pybind11.h&gt;</span><br><span class="line">#include &lt;pybind11/stl.h&gt;</span><br><span class="line">#include &lt;string&gt;</span><br><span class="line">#include &lt;vector&gt;</span><br><span class="line"></span><br><span class="line">namespace py = pybind11;</span><br><span class="line"></span><br><span class="line">struct Rectangle &#123;</span><br><span class="line">    int x, y, width, height;</span><br><span class="line">    </span><br><span class="line">    Rectangle(int x=0, int y=0, int w=0, int h=0) </span><br><span class="line">        : x(x), y(y), width(w), height(h) &#123;&#125;</span><br><span class="line">    </span><br><span class="line">    int area() const &#123; return width * height; &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">namespace pybind11 &#123; namespace detail &#123;</span><br><span class="line">    template &lt;&gt; struct type_caster&lt;Rectangle&gt; &#123;</span><br><span class="line">    public:</span><br><span class="line">        PYBIND11_TYPE_CASTER(Rectangle, _(&quot;Rectangle&quot;));</span><br><span class="line">        </span><br><span class="line">        bool load(handle src, bool) &#123;</span><br><span class="line">            // 支持字典</span><br><span class="line">            if (src.is_dict()) &#123;</span><br><span class="line">                py::dict obj = src.cast&lt;py::dict&gt;();</span><br><span class="line">                value.x = obj[&quot;x&quot;].cast&lt;int&gt;();</span><br><span class="line">                value.y = obj[&quot;y&quot;].cast&lt;int&gt;();</span><br><span class="line">                value.width = obj[&quot;width&quot;].cast&lt;int&gt;();</span><br><span class="line">                value.height = obj[&quot;height&quot;].cast&lt;int&gt;();</span><br><span class="line">                return true;</span><br><span class="line">            &#125;</span><br><span class="line">            // 支持元组</span><br><span class="line">            else if (src.is_tuple()) &#123;</span><br><span class="line">                py::tuple obj = src.cast&lt;py::tuple&gt;();</span><br><span class="line">                if (obj.size() != 4) return false;</span><br><span class="line">                value.x = obj[0].cast&lt;int&gt;();</span><br><span class="line">                value.y = obj[1].cast&lt;int&gt;();</span><br><span class="line">                value.width = obj[2].cast&lt;int&gt;();</span><br><span class="line">                value.height = obj[3].cast&lt;int&gt;();</span><br><span class="line">                return true;</span><br><span class="line">            &#125;</span><br><span class="line">            // 支持列表</span><br><span class="line">            else if (src.is_list()) &#123;</span><br><span class="line">                py::list obj = src.cast&lt;py::list&gt;();</span><br><span class="line">                if (obj.size() != 4) return false;</span><br><span class="line">                value.x = obj[0].cast&lt;int&gt;();</span><br><span class="line">                value.y = obj[1].cast&lt;int&gt;();</span><br><span class="line">                value.width = obj[2].cast&lt;int&gt;();</span><br><span class="line">                value.height = obj[3].cast&lt;int&gt;();</span><br><span class="line">                return true;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        static handle cast(const Rectangle&amp; r, return_value_policy /* policy */, handle /* parent */) &#123;</span><br><span class="line">            py::dict obj;</span><br><span class="line">            obj[&quot;x&quot;] = r.x;</span><br><span class="line">            obj[&quot;y&quot;] = r.y;</span><br><span class="line">            obj[&quot;width&quot;] = r.width;</span><br><span class="line">            obj[&quot;height&quot;] = r.height;</span><br><span class="line">            obj[&quot;area&quot;] = r.area();</span><br><span class="line">            return obj.release();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;&#125;</span><br><span class="line"></span><br><span class="line">PYBIND11_MODULE(example, m) &#123;</span><br><span class="line">    m.def(&quot;rectangle_area&quot;, [](const Rectangle&amp; r) &#123;</span><br><span class="line">        return r.area();</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    m.def(&quot;expand_rectangle&quot;, [](const Rectangle&amp; r, int amount) &#123;</span><br><span class="line">        return Rectangle(</span><br><span class="line">            r.x - amount,</span><br><span class="line">            r.y - amount,</span><br><span class="line">            r.width + 2 * amount,</span><br><span class="line">            r.height + 2 * amount</span><br><span class="line">        );</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Python 使用：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">import example</span><br><span class="line"></span><br><span class="line"># 支持多种输入类型</span><br><span class="line">rect1 = &#123;&quot;x&quot;: 0, &quot;y&quot;: 0, &quot;width&quot;: 10, &quot;height&quot;: 20&#125;</span><br><span class="line">rect2 = (10, 10, 5, 5)</span><br><span class="line">rect3 = [20, 20, 8, 8]</span><br><span class="line"></span><br><span class="line">print(example.rectangle_area(rect1))  # 输出：200</span><br><span class="line">print(example.rectangle_area(rect2))  # 输出：25</span><br><span class="line">print(example.rectangle_area(rect3))  # 输出：64</span><br><span class="line"></span><br><span class="line"># 扩展矩形</span><br><span class="line">expanded = example.expand_rectangle(rect1, 2)</span><br><span class="line">print(expanded)</span><br><span class="line"># 输出：&#123;&#x27;x&#x27;: -2, &#x27;y&#x27;: -2, &#x27;width&#x27;: 14, &#x27;height&#x27;: 24, &#x27;area&#x27;: 336&#125;</span><br></pre></td></tr></table></figure>
<h3 id="3-继承类型的转换器">3. 继承类型的转换器</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;pybind11/pybind11.h&gt;</span><br><span class="line">#include &lt;string&gt;</span><br><span class="line">#include &lt;memory&gt;</span><br><span class="line"></span><br><span class="line">namespace py = pybind11;</span><br><span class="line"></span><br><span class="line">// 基类</span><br><span class="line">struct Shape &#123;</span><br><span class="line">    virtual ~Shape() = default;</span><br><span class="line">    virtual std::string name() const = 0;</span><br><span class="line">    virtual double area() const = 0;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">// 派生类</span><br><span class="line">struct Circle : public Shape &#123;</span><br><span class="line">    double radius;</span><br><span class="line">    </span><br><span class="line">    Circle(double r) : radius(r) &#123;&#125;</span><br><span class="line">    </span><br><span class="line">    std::string name() const override &#123; return &quot;Circle&quot;; &#125;</span><br><span class="line">    double area() const override &#123; return 3.14159 * radius * radius; &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">struct Square : public Shape &#123;</span><br><span class="line">    double side;</span><br><span class="line">    </span><br><span class="line">    Square(double s) : side(s) &#123;&#125;</span><br><span class="line">    </span><br><span class="line">    std::string name() const override &#123; return &quot;Square&quot;; &#125;</span><br><span class="line">    double area() const override &#123; return side * side; &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">// 基类转换器</span><br><span class="line">namespace pybind11 &#123; namespace detail &#123;</span><br><span class="line">    template &lt;&gt; struct type_caster&lt;std::shared_ptr&lt;Shape&gt;&gt; &#123;</span><br><span class="line">    public:</span><br><span class="line">        PYBIND11_TYPE_CASTER(std::shared_ptr&lt;Shape&gt;, _(&quot;Shape&quot;));</span><br><span class="line">        </span><br><span class="line">        bool load(handle src, bool) &#123;</span><br><span class="line">            if (!src.is_dict()) return false;</span><br><span class="line">            </span><br><span class="line">            py::dict obj = src.cast&lt;py::dict&gt;();</span><br><span class="line">            std::string type = obj[&quot;type&quot;].cast&lt;std::string&gt;();</span><br><span class="line">            </span><br><span class="line">            if (type == &quot;circle&quot;) &#123;</span><br><span class="line">                double radius = obj[&quot;radius&quot;].cast&lt;double&gt;();</span><br><span class="line">                value = std::make_shared&lt;Circle&gt;(radius);</span><br><span class="line">            &#125; else if (type == &quot;square&quot;) &#123;</span><br><span class="line">                double side = obj[&quot;side&quot;].cast&lt;double&gt;();</span><br><span class="line">                value = std::make_shared&lt;Square&gt;(side);</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                return false;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            return true;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        static handle cast(const std::shared_ptr&lt;Shape&gt;&amp; shape, </span><br><span class="line">                          return_value_policy /* policy */, handle /* parent */) &#123;</span><br><span class="line">            py::dict obj;</span><br><span class="line">            </span><br><span class="line">            if (auto circle = std::dynamic_pointer_cast&lt;Circle&gt;(shape)) &#123;</span><br><span class="line">                obj[&quot;type&quot;] = &quot;circle&quot;;</span><br><span class="line">                obj[&quot;radius&quot;] = circle-&gt;radius;</span><br><span class="line">            &#125; else if (auto square = std::dynamic_pointer_cast&lt;Square&gt;(shape)) &#123;</span><br><span class="line">                obj[&quot;type&quot;] = &quot;square&quot;;</span><br><span class="line">                obj[&quot;side&quot;] = square-&gt;side;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            obj[&quot;name&quot;] = shape-&gt;name();</span><br><span class="line">            obj[&quot;area&quot;] = shape-&gt;area();</span><br><span class="line">            </span><br><span class="line">            return obj.release();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;&#125;</span><br><span class="line"></span><br><span class="line">PYBIND11_MODULE(example, m) &#123;</span><br><span class="line">    m.def(&quot;shape_info&quot;, [](const std::shared_ptr&lt;Shape&gt;&amp; shape) &#123;</span><br><span class="line">        return py::make_tuple(shape-&gt;name(), shape-&gt;area());</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    m.def(&quot;create_shape&quot;, [](const std::string&amp; type, double param) &#123;</span><br><span class="line">        if (type == &quot;circle&quot;) &#123;</span><br><span class="line">            return std::make_shared&lt;Circle&gt;(param);</span><br><span class="line">        &#125; else if (type == &quot;square&quot;) &#123;</span><br><span class="line">            return std::make_shared&lt;Square&gt;(param);</span><br><span class="line">        &#125;</span><br><span class="line">        throw std::invalid_argument(&quot;Unknown shape type&quot;);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="其他高级特性">其他高级特性</h2>
<h3 id="1-属性装饰器">1. 属性装饰器</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;pybind11/pybind11.h&gt;</span><br><span class="line">#include &lt;string&gt;</span><br><span class="line"></span><br><span class="line">namespace py = pybind11;</span><br><span class="line"></span><br><span class="line">class Person &#123;</span><br><span class="line">public:</span><br><span class="line">    Person(const std::string&amp; name, int age) </span><br><span class="line">        : name(name), age(age) &#123;&#125;</span><br><span class="line">    </span><br><span class="line">    std::string get_name() const &#123; return name; &#125;</span><br><span class="line">    void set_name(const std::string&amp; new_name) &#123; name = new_name; &#125;</span><br><span class="line">    </span><br><span class="line">    int get_age() const &#123; return age; &#125;</span><br><span class="line">    void set_age(int new_age) &#123; </span><br><span class="line">        if (new_age &lt; 0) throw std::invalid_argument(&quot;年龄不能为负数&quot;);</span><br><span class="line">        age = new_age;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    std::string get_full_info() const &#123;</span><br><span class="line">        return name + &quot;, &quot; + std::to_string(age) + &quot;岁&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">private:</span><br><span class="line">    std::string name;</span><br><span class="line">    int age;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">PYBIND11_MODULE(example, m) &#123;</span><br><span class="line">    py::class_&lt;Person&gt;(m, &quot;Person&quot;)</span><br><span class="line">        .def(py::init&lt;const std::string&amp;, int&gt;())</span><br><span class="line">        </span><br><span class="line">        // 可读可写属性</span><br><span class="line">        .def_property(&quot;name&quot;, &amp;Person::get_name, &amp;Person::set_name)</span><br><span class="line">        </span><br><span class="line">        // 带验证的属性</span><br><span class="line">        .def_property(&quot;age&quot;, &amp;Person::get_age, &amp;Person::set_age)</span><br><span class="line">        </span><br><span class="line">        // 只读属性</span><br><span class="line">        .def_property_readonly(&quot;full_info&quot;, &amp;Person::get_full_info)</span><br><span class="line">        </span><br><span class="line">        // 静态属性</span><br><span class="line">        .def_readwrite_static(&quot;species&quot;, []() &#123; return &quot;人类&quot;; &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="2-方法装饰器">2. 方法装饰器</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;pybind11/pybind11.h&gt;</span><br><span class="line">#include &lt;pybind11/functional.h&gt;</span><br><span class="line">#include &lt;string&gt;</span><br><span class="line">#include &lt;chrono&gt;</span><br><span class="line"></span><br><span class="line">namespace py = pybind11;</span><br><span class="line"></span><br><span class="line">// 计时装饰器</span><br><span class="line">template &lt;typename Func&gt;</span><br><span class="line">auto timing_decorator(Func&amp;&amp; func) &#123;</span><br><span class="line">    return [func = std::forward&lt;Func&gt;(func)](auto&amp;&amp;... args) &#123;</span><br><span class="line">        auto start = std::chrono::high_resolution_clock::now();</span><br><span class="line">        </span><br><span class="line">        auto result = func(std::forward&lt;decltype(args)&gt;(args)...);</span><br><span class="line">        </span><br><span class="line">        auto end = std::chrono::high_resolution_clock::now();</span><br><span class="line">        auto duration = std::chrono::duration_cast&lt;std::chrono::microseconds&gt;(</span><br><span class="line">            end - start</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        py::print(&quot;函数执行时间:&quot;, duration.count(), &quot;微秒&quot;);</span><br><span class="line">        return result;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 缓存装饰器</span><br><span class="line">template &lt;typename Func&gt;</span><br><span class="line">auto cache_decorator(Func&amp;&amp; func) &#123;</span><br><span class="line">    std::unordered_map&lt;std::string, py::object&gt; cache;</span><br><span class="line">    </span><br><span class="line">    return [func = std::forward&lt;Func&gt;(func), cache = std::move(cache)](</span><br><span class="line">        const std::string&amp; key, auto&amp;&amp;... args</span><br><span class="line">    ) mutable &#123;</span><br><span class="line">        if (cache.find(key) != cache.end()) &#123;</span><br><span class="line">            py::print(&quot;缓存命中:&quot;, key);</span><br><span class="line">            return cache[key];</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        py::object result = func(key, std::forward&lt;decltype(args)&gt;(args)...);</span><br><span class="line">        cache[key] = result;</span><br><span class="line">        py::print(&quot;缓存未命中，计算结果:&quot;, key);</span><br><span class="line">        return result;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PYBIND11_MODULE(example, m) &#123;</span><br><span class="line">    // 原始函数</span><br><span class="line">    auto expensive_function = [](const std::string&amp; data) &#123;</span><br><span class="line">        // 模拟耗时计算</span><br><span class="line">        std::this_thread::sleep_for(std::chrono::milliseconds(100));</span><br><span class="line">        return &quot;处理结果: &quot; + data;</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    // 使用装饰器</span><br><span class="line">    m.def(&quot;process_data&quot;, timing_decorator(expensive_function));</span><br><span class="line">    m.def(&quot;cached_process&quot;, cache_decorator(expensive_function));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="3-自定义异常">3. 自定义异常</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;pybind11/pybind11.h&gt;</span><br><span class="line">#include &lt;stdexcept&gt;</span><br><span class="line">#include &lt;string&gt;</span><br><span class="line"></span><br><span class="line">namespace py = pybind11;</span><br><span class="line"></span><br><span class="line">// 自定义异常类型</span><br><span class="line">class ValidationError : public std::runtime_error &#123;</span><br><span class="line">public:</span><br><span class="line">    ValidationError(const std::string&amp; message) </span><br><span class="line">        : std::runtime_error(message) &#123;&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">class DatabaseError : public std::runtime_error &#123;</span><br><span class="line">public:</span><br><span class="line">    DatabaseError(const std::string&amp; message, int code) </span><br><span class="line">        : std::runtime_error(message), error_code(code) &#123;&#125;</span><br><span class="line">    </span><br><span class="line">    int get_code() const &#123; return error_code; &#125;</span><br><span class="line">    </span><br><span class="line">private:</span><br><span class="line">    int error_code;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">PYBIND11_MODULE(example, m) &#123;</span><br><span class="line">    // 绑定自定义异常</span><br><span class="line">    auto validation_error = py::register_exception&lt;ValidationError&gt;(m, &quot;ValidationError&quot;);</span><br><span class="line">    auto db_error = py::register_exception&lt;DatabaseError&gt;(m, &quot;DatabaseError&quot;);</span><br><span class="line">    </span><br><span class="line">    // 为异常添加额外方法</span><br><span class="line">    db_error.def(&quot;get_code&quot;, &amp;DatabaseError::get_code);</span><br><span class="line">    </span><br><span class="line">    // 使用自定义异常的函数</span><br><span class="line">    m.def(&quot;validate_age&quot;, [](int age) &#123;</span><br><span class="line">        if (age &lt; 0) &#123;</span><br><span class="line">            throw ValidationError(&quot;年龄不能为负数&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        if (age &gt; 150) &#123;</span><br><span class="line">            throw ValidationError(&quot;年龄不能超过150&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    m.def(&quot;connect_to_db&quot;, [](const std::string&amp; host) &#123;</span><br><span class="line">        if (host.empty()) &#123;</span><br><span class="line">            throw DatabaseError(&quot;数据库主机不能为空&quot;, 1001);</span><br><span class="line">        &#125;</span><br><span class="line">        if (host != &quot;localhost&quot;) &#123;</span><br><span class="line">            throw DatabaseError(&quot;连接失败: 未知主机&quot;, 1002);</span><br><span class="line">        &#125;</span><br><span class="line">        return &quot;连接成功&quot;;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Python 使用：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">import example</span><br><span class="line"></span><br><span class="line">try:</span><br><span class="line">    example.validate_age(-5)</span><br><span class="line">except example.ValidationError as e:</span><br><span class="line">    print(f&quot;验证错误: &#123;e&#125;&quot;)</span><br><span class="line"></span><br><span class="line">try:</span><br><span class="line">    example.connect_to_db(&quot;invalid_host&quot;)</span><br><span class="line">except example.DatabaseError as e:</span><br><span class="line">    print(f&quot;数据库错误: &#123;e&#125;, 错误码: &#123;e.get_code()&#125;&quot;)</span><br></pre></td></tr></table></figure>
<h3 id="4-上下文管理器">4. 上下文管理器</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;pybind11/pybind11.h&gt;</span><br><span class="line">#include &lt;pybind11/functional.h&gt;</span><br><span class="line">#include &lt;iostream&gt;</span><br><span class="line">#include &lt;chrono&gt;</span><br><span class="line"></span><br><span class="line">namespace py = pybind11;</span><br><span class="line"></span><br><span class="line">class Timer &#123;</span><br><span class="line">public:</span><br><span class="line">    Timer() : start_time(std::chrono::high_resolution_clock::now()) &#123;</span><br><span class="line">        std::cout &lt;&lt; &quot;计时器开始&quot; &lt;&lt; std::endl;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ~Timer() &#123;</span><br><span class="line">        auto end_time = std::chrono::high_resolution_clock::now();</span><br><span class="line">        auto duration = std::chrono::duration_cast&lt;std::chrono::milliseconds&gt;(</span><br><span class="line">            end_time - start_time</span><br><span class="line">        );</span><br><span class="line">        std::cout &lt;&lt; &quot;计时器结束，耗时: &quot; &lt;&lt; duration.count() &lt;&lt; &quot;毫秒&quot; &lt;&lt; std::endl;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    void reset() &#123;</span><br><span class="line">        start_time = std::chrono::high_resolution_clock::now();</span><br><span class="line">        std::cout &lt;&lt; &quot;计时器重置&quot; &lt;&lt; std::endl;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">private:</span><br><span class="line">    std::chrono::high_resolution_clock::time_point start_time;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">PYBIND11_MODULE(example, m) &#123;</span><br><span class="line">    py::class_&lt;Timer&gt;(m, &quot;Timer&quot;)</span><br><span class="line">        .def(py::init&lt;&gt;())</span><br><span class="line">        .def(&quot;reset&quot;, &amp;Timer::reset)</span><br><span class="line">        </span><br><span class="line">        // 实现上下文管理器接口</span><br><span class="line">        .def(&quot;__enter__&quot;, [](Timer&amp; self) &#123;</span><br><span class="line">            return &amp;self;</span><br><span class="line">        &#125;)</span><br><span class="line">        .def(&quot;__exit__&quot;, [](Timer&amp; self, py::object type, py::object value, py::object traceback) &#123;</span><br><span class="line">            // __exit__方法的返回值表示是否处理异常</span><br><span class="line">            return py::none();</span><br><span class="line">        &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Python 使用：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">import example</span><br><span class="line">import time</span><br><span class="line"></span><br><span class="line"># 使用上下文管理器</span><br><span class="line">with example.Timer() as timer:</span><br><span class="line">    time.sleep(1)</span><br><span class="line">    timer.reset()</span><br><span class="line">    time.sleep(0.5)</span><br><span class="line"></span><br><span class="line"># 输出：</span><br><span class="line"># 计时器开始</span><br><span class="line"># 计时器重置</span><br><span class="line"># 计时器结束，耗时: 500毫秒</span><br></pre></td></tr></table></figure>
<h3 id="5-迭代器支持">5. 迭代器支持</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;pybind11/pybind11.h&gt;</span><br><span class="line">#include &lt;vector&gt;</span><br><span class="line">#include &lt;string&gt;</span><br><span class="line"></span><br><span class="line">namespace py = pybind11;</span><br><span class="line"></span><br><span class="line">class NumberSequence &#123;</span><br><span class="line">public:</span><br><span class="line">    NumberSequence(int start, int end) </span><br><span class="line">        : start_(start), end_(end), current_(start) &#123;&#125;</span><br><span class="line">    </span><br><span class="line">    // 迭代器接口</span><br><span class="line">    int next() &#123;</span><br><span class="line">        if (current_ &gt; end_) &#123;</span><br><span class="line">            throw py::stop_iteration();</span><br><span class="line">        &#125;</span><br><span class="line">        return current_++;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // 重置迭代器</span><br><span class="line">    void reset() &#123;</span><br><span class="line">        current_ = start_;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">private:</span><br><span class="line">    int start_;</span><br><span class="line">    int end_;</span><br><span class="line">    int current_;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">PYBIND11_MODULE(example, m) &#123;</span><br><span class="line">    py::class_&lt;NumberSequence&gt;(m, &quot;NumberSequence&quot;)</span><br><span class="line">        .def(py::init&lt;int, int&gt;())</span><br><span class="line">        .def(&quot;reset&quot;, &amp;NumberSequence::reset)</span><br><span class="line">        </span><br><span class="line">        // 实现迭代器协议</span><br><span class="line">        .def(&quot;__iter__&quot;, [](NumberSequence&amp; self) &#123;</span><br><span class="line">            self.reset();</span><br><span class="line">            return &amp;self;</span><br><span class="line">        &#125;)</span><br><span class="line">        .def(&quot;__next__&quot;, &amp;NumberSequence::next);</span><br><span class="line">    </span><br><span class="line">    // 范围迭代器示例</span><br><span class="line">    m.def(&quot;range_generator&quot;, [](int n) &#123;</span><br><span class="line">        return py::make_iterator(range(0, n).begin(), range(0, n).end());</span><br><span class="line">    &#125;, py::keep_alive&lt;0, 1&gt;());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Python 使用：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">import example</span><br><span class="line"></span><br><span class="line"># 使用自定义迭代器</span><br><span class="line">seq = example.NumberSequence(1, 5)</span><br><span class="line">for num in seq:</span><br><span class="line">    print(num)  # 输出：1, 2, 3, 4, 5</span><br><span class="line"></span><br><span class="line"># 使用范围生成器</span><br><span class="line">for i in example.range_generator(3):</span><br><span class="line">    print(i)  # 输出：0, 1, 2</span><br></pre></td></tr></table></figure>
<h2 id="总结">总结</h2>
<p>本补充指南涵盖了 pybind11 官方文档中的所有重要高级特性：</p>
<h3 id="核心要点"><strong>核心要点</strong></h3>
<ol>
<li class="lvl-3">
<p><strong>高级类特性</strong>：动态属性、继承与多态、运算符重载、枚举绑定</p>
</li>
<li class="lvl-3">
<p><strong>构建系统</strong>：CMake、pyproject.toml、setuptools 的高级配置</p>
</li>
<li class="lvl-3">
<p><strong>内存管理</strong>：返回值策略、智能指针（smart_holder、unique_ptr、shared_ptr）</p>
</li>
<li class="lvl-3">
<p><strong>类型系统</strong>：基础类型转换、STL 容器、自定义类型转换器</p>
</li>
<li class="lvl-3">
<p><strong>嵌入与扩展</strong>：Python 解释器嵌入、子解释器、多线程 GIL 管理</p>
</li>
<li class="lvl-3">
<p><strong>高级功能</strong>：属性装饰器、方法装饰器、自定义异常、上下文管理器、迭代器</p>
</li>
</ol>
<h3 id="最佳实践"><strong>最佳实践</strong></h3>
<ul class="lvl-0">
<li class="lvl-2">
<p><strong>内存安全</strong>：正确使用返回值策略，优先使用 smart_holder</p>
</li>
<li class="lvl-2">
<p><strong>性能优化</strong>：合理释放 GIL，使用多线程和异步任务</p>
</li>
<li class="lvl-2">
<p><strong>类型安全</strong>：使用强类型转换，避免隐式转换错误</p>
</li>
<li class="lvl-2">
<p><strong>代码组织</strong>：模块化设计，分离实现和绑定代码</p>
</li>
<li class="lvl-2">
<p><strong>错误处理</strong>：使用自定义异常，提供详细的错误信息</p>
</li>
</ul>
<h3 id="进阶学习"><strong>进阶学习</strong></h3>
<ul class="lvl-0">
<li class="lvl-2">
<p><strong>性能调优</strong>：使用 LTO 优化、缓存机制、异步编程</p>
</li>
<li class="lvl-2">
<p><strong>调试技巧</strong>：GDB 调试、Python 调试器集成</p>
</li>
<li class="lvl-2">
<p><strong>测试策略</strong>：单元测试、集成测试、性能测试</p>
</li>
<li class="lvl-2">
<p><strong>部署方案</strong>：wheel 打包、conda 包、Docker 容器化</p>
</li>
</ul>
<p>pybind11 为 C++ 和 Python 的无缝集成提供了强大的支持，掌握这些高级特性将帮助您开发出更加高效、健壮的跨语言应用程序。</p>
<p><strong>Date: October 16, 2025</strong></p>
<p><strong>Code:</strong> <a target="_blank" rel="noopener" href="https://github.com/pybind/pybind11"><strong>https://github.com/pybind/pybind11</strong></a></p>

    </div>

    
    
    

      <footer class="post-footer">
          
          <div class="post-tags">
              <a href="/tags/python/" rel="tag"><i class="fa fa-tag"></i> python</a>
              <a href="/tags/cpp/" rel="tag"><i class="fa fa-tag"></i> C++</a>
          </div>

        



        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2025/09/09/web/Vue.js%20%E5%9F%BA%E6%9C%AC%E7%BB%84%E4%BB%B6%E6%95%B4%E7%90%86/" rel="prev" title="Vue基本组件">
      <i class="fa fa-chevron-left"></i> Vue基本组件
    </a></div>
      <div class="post-nav-item">
    <a href="/2025/09/09/C++/pybind11%20%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/" rel="next" title="PyBind11使用指北">
      PyBind11使用指北 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
            
    <div class="comments" id="gitalk-container"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link"><span class="nav-number">1.</span> <span class="nav-text">pybind11 使用指南 - 官方文档补充内容</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%9B%AE%E5%BD%95"><span class="nav-number">1.1.</span> <span class="nav-text">目录</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%AB%98%E7%BA%A7%E7%B1%BB%E7%89%B9%E6%80%A7"><span class="nav-number">1.2.</span> <span class="nav-text">高级类特性</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E5%8A%A8%E6%80%81%E5%B1%9E%E6%80%A7"><span class="nav-number">1.2.1.</span> <span class="nav-text">1. 动态属性</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E7%BB%A7%E6%89%BF%E4%B8%8E%E8%87%AA%E5%8A%A8%E5%90%91%E4%B8%8B%E8%BD%AC%E5%9E%8B"><span class="nav-number">1.2.2.</span> <span class="nav-text">2. 继承与自动向下转型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E8%BF%90%E7%AE%97%E7%AC%A6%E9%87%8D%E8%BD%BD"><span class="nav-number">1.2.3.</span> <span class="nav-text">3. 运算符重载</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-%E6%9E%9A%E4%B8%BE%E7%B1%BB%E5%9E%8B%E7%BB%91%E5%AE%9A"><span class="nav-number">1.2.4.</span> <span class="nav-text">4. 枚举类型绑定</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9E%84%E5%BB%BA%E7%B3%BB%E7%BB%9F%E8%AF%A6%E8%A7%A3"><span class="nav-number">1.3.</span> <span class="nav-text">构建系统详解</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-CMake-%E6%9E%84%E5%BB%BA"><span class="nav-number">1.3.1.</span> <span class="nav-text">1. CMake 构建</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-pyproject-toml-%E6%9E%84%E5%BB%BA"><span class="nav-number">1.3.2.</span> <span class="nav-text">2. pyproject.toml 构建</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-setuptools-%E6%9E%84%E5%BB%BA%E9%AB%98%E7%BA%A7%E9%85%8D%E7%BD%AE"><span class="nav-number">1.3.3.</span> <span class="nav-text">3. setuptools 构建高级配置</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%BF%94%E5%9B%9E%E5%80%BC%E7%AD%96%E7%95%A5"><span class="nav-number">1.4.</span> <span class="nav-text">返回值策略</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E7%AD%96%E7%95%A5%E6%A6%82%E8%BF%B0"><span class="nav-number">1.4.1.</span> <span class="nav-text">1. 策略概述</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E4%BD%BF%E7%94%A8%E7%A4%BA%E4%BE%8B"><span class="nav-number">1.4.2.</span> <span class="nav-text">2. 使用示例</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E5%B8%B8%E8%A7%81%E9%94%99%E8%AF%AF%E5%8F%8A%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="nav-number">1.4.3.</span> <span class="nav-text">3. 常见错误及解决方案</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%99%BA%E8%83%BD%E6%8C%87%E9%92%88"><span class="nav-number">1.5.</span> <span class="nav-text">智能指针</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-py-smart-holder%EF%BC%88%E6%8E%A8%E8%8D%90%EF%BC%89"><span class="nav-number">1.5.1.</span> <span class="nav-text">1. py::smart_holder（推荐）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-std-unique-ptr"><span class="nav-number">1.5.2.</span> <span class="nav-text">2. std::unique_ptr</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-std-shared-ptr"><span class="nav-number">1.5.3.</span> <span class="nav-text">3. std::shared_ptr</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-%E8%87%AA%E5%AE%9A%E4%B9%89%E6%99%BA%E8%83%BD%E6%8C%87%E9%92%88"><span class="nav-number">1.5.4.</span> <span class="nav-text">4. 自定义智能指针</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%B1%BB%E5%9E%8B%E8%BD%AC%E6%8D%A2"><span class="nav-number">1.6.</span> <span class="nav-text">类型转换</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E5%9F%BA%E7%A1%80%E7%B1%BB%E5%9E%8B%E8%BD%AC%E6%8D%A2"><span class="nav-number">1.6.1.</span> <span class="nav-text">1. 基础类型转换</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-STL-%E5%AE%B9%E5%99%A8%E8%BD%AC%E6%8D%A2"><span class="nav-number">1.6.2.</span> <span class="nav-text">2. STL 容器转换</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%92%8C%E5%AD%97%E8%8A%82%E8%BD%AC%E6%8D%A2"><span class="nav-number">1.6.3.</span> <span class="nav-text">3. 字符串和字节转换</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-%E6%97%B6%E9%97%B4%E7%B1%BB%E5%9E%8B%E8%BD%AC%E6%8D%A2"><span class="nav-number">1.6.4.</span> <span class="nav-text">4. 时间类型转换</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%B5%8C%E5%85%A5-Python-%E8%A7%A3%E9%87%8A%E5%99%A8"><span class="nav-number">1.7.</span> <span class="nav-text">嵌入 Python 解释器</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E5%9F%BA%E7%A1%80%E5%B5%8C%E5%85%A5"><span class="nav-number">1.7.1.</span> <span class="nav-text">1. 基础嵌入</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E5%B5%8C%E5%85%A5%E6%A8%A1%E5%9D%97"><span class="nav-number">1.7.2.</span> <span class="nav-text">2. 嵌入模块</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E5%AF%BC%E5%85%A5%E6%9C%AC%E5%9C%B0-Python-%E6%96%87%E4%BB%B6"><span class="nav-number">1.7.3.</span> <span class="nav-text">3. 导入本地 Python 文件</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A4%9A%E7%BA%BF%E7%A8%8B%E4%B8%8E-GIL-%E7%AE%A1%E7%90%86"><span class="nav-number">1.8.</span> <span class="nav-text">多线程与 GIL 管理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-GIL-%E9%87%8A%E6%94%BE%E4%B8%8E%E8%8E%B7%E5%8F%96"><span class="nav-number">1.8.1.</span> <span class="nav-text">1. GIL 释放与获取</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E7%BA%BF%E7%A8%8B%E5%B1%80%E9%83%A8%E5%AD%98%E5%82%A8"><span class="nav-number">1.8.2.</span> <span class="nav-text">2. 线程局部存储</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E5%BC%82%E6%AD%A5%E4%BB%BB%E5%8A%A1"><span class="nav-number">1.8.3.</span> <span class="nav-text">3. 异步任务</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AD%90%E8%A7%A3%E9%87%8A%E5%99%A8"><span class="nav-number">1.9.</span> <span class="nav-text">子解释器</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E5%9F%BA%E7%A1%80%E5%AD%90%E8%A7%A3%E9%87%8A%E5%99%A8%E4%BD%BF%E7%94%A8"><span class="nav-number">1.9.1.</span> <span class="nav-text">1. 基础子解释器使用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E5%A4%9A%E7%BA%BF%E7%A8%8B%E5%AD%90%E8%A7%A3%E9%87%8A%E5%99%A8"><span class="nav-number">1.9.2.</span> <span class="nav-text">2. 多线程子解释器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E5%AD%90%E8%A7%A3%E9%87%8A%E5%99%A8%E5%AE%89%E5%85%A8%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="nav-number">1.9.3.</span> <span class="nav-text">3. 子解释器安全最佳实践</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E7%B1%BB%E5%9E%8B%E8%BD%AC%E6%8D%A2"><span class="nav-number">1.10.</span> <span class="nav-text">自定义类型转换</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E5%9F%BA%E7%A1%80%E8%87%AA%E5%AE%9A%E4%B9%89%E8%BD%AC%E6%8D%A2%E5%99%A8"><span class="nav-number">1.10.1.</span> <span class="nav-text">1. 基础自定义转换器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E6%94%AF%E6%8C%81%E5%A4%9A%E7%A7%8D-Python-%E7%B1%BB%E5%9E%8B%E7%9A%84%E8%BD%AC%E6%8D%A2%E5%99%A8"><span class="nav-number">1.10.2.</span> <span class="nav-text">2. 支持多种 Python 类型的转换器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E7%BB%A7%E6%89%BF%E7%B1%BB%E5%9E%8B%E7%9A%84%E8%BD%AC%E6%8D%A2%E5%99%A8"><span class="nav-number">1.10.3.</span> <span class="nav-text">3. 继承类型的转换器</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%85%B6%E4%BB%96%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7"><span class="nav-number">1.11.</span> <span class="nav-text">其他高级特性</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E5%B1%9E%E6%80%A7%E8%A3%85%E9%A5%B0%E5%99%A8"><span class="nav-number">1.11.1.</span> <span class="nav-text">1. 属性装饰器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E6%96%B9%E6%B3%95%E8%A3%85%E9%A5%B0%E5%99%A8"><span class="nav-number">1.11.2.</span> <span class="nav-text">2. 方法装饰器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E8%87%AA%E5%AE%9A%E4%B9%89%E5%BC%82%E5%B8%B8"><span class="nav-number">1.11.3.</span> <span class="nav-text">3. 自定义异常</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-%E4%B8%8A%E4%B8%8B%E6%96%87%E7%AE%A1%E7%90%86%E5%99%A8"><span class="nav-number">1.11.4.</span> <span class="nav-text">4. 上下文管理器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-%E8%BF%AD%E4%BB%A3%E5%99%A8%E6%94%AF%E6%8C%81"><span class="nav-number">1.11.5.</span> <span class="nav-text">5. 迭代器支持</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%80%BB%E7%BB%93"><span class="nav-number">1.12.</span> <span class="nav-text">总结</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A0%B8%E5%BF%83%E8%A6%81%E7%82%B9"><span class="nav-number">1.12.1.</span> <span class="nav-text">核心要点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="nav-number">1.12.2.</span> <span class="nav-text">最佳实践</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BF%9B%E9%98%B6%E5%AD%A6%E4%B9%A0"><span class="nav-number">1.12.3.</span> <span class="nav-text">进阶学习</span></a></li></ol></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="三子曰"
      src="https://cdn.jsdelivr.net/gh/MengChangWang/Blog_Image@main/img/avatar.png">
  <p class="site-author-name" itemprop="name">三子曰</p>
  <div class="site-description" itemprop="description">欢迎来到我的博客</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">53</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">2</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">20</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/wangmc1024" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;wangmc1024" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:wangmc1024@gmail.com" title="E-Mail → mailto:wangmc1024@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



      </div>
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; Wed Mar 27 2024 08:00:00 GMT+0800 (中国标准时间) – 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">三子曰</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="站点总字数">559k</span>
</div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script size="300" alpha="0.6" zIndex="-1" src="/lib/canvas-ribbon/canvas-ribbon.js"></script>
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/lozad@1/dist/lozad.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  
  <script>
    (function(){
      var canonicalURL, curProtocol;
      //Get the <link> tag
      var x=document.getElementsByTagName("link");
		//Find the last canonical URL
		if(x.length > 0){
			for (i=0;i<x.length;i++){
				if(x[i].rel.toLowerCase() == 'canonical' && x[i].href){
					canonicalURL=x[i].href;
				}
			}
		}
    //Get protocol
	    if (!canonicalURL){
	    	curProtocol = window.location.protocol.split(':')[0];
	    }
	    else{
	    	curProtocol = canonicalURL.split(':')[0];
	    }
      //Get current URL if the canonical URL does not exist
	    if (!canonicalURL) canonicalURL = window.location.href;
	    //Assign script content. Replace current URL with the canonical URL
      !function(){var e=/([http|https]:\/\/[a-zA-Z0-9\_\.]+\.baidu\.com)/gi,r=canonicalURL,t=document.referrer;if(!e.test(r)){var n=(String(curProtocol).toLowerCase() === 'https')?"https://sp0.baidu.com/9_Q4simg2RQJ8t7jm9iCKT-xh_/s.gif":"//api.share.baidu.com/s.gif";t?(n+="?r="+encodeURIComponent(document.referrer),r&&(n+="&l="+r)):r&&(n+="?l="+r);var i=new Image;i.src=n}}(window);})();
  </script>















  

  

<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.css">

<script>
NexT.utils.loadComments(document.querySelector('#gitalk-container'), () => {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js', () => {
    var gitalk = new Gitalk({
      clientID    : '2719e26e1ea715ee8429',
      clientSecret: '77a4ce8e9410a002f05c8f2c2b398c952a012d7c',
      repo        : 'mengchangwang.github.io',
      owner       : 'MengChangWang',
      admin       : ['MengChangWang'],
      id          : 'ac87c1bc9dc8c13e236013f7e4d279b1',
        language: 'zh-CN',
      distractionFreeMode: true
    });
    gitalk.render('gitalk-container');
  }, window.Gitalk);
});
</script>



</body>
</html>
